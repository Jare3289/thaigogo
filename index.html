<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏û‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏£‡∏π</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        body {
            box-sizing: border-box;
            font-family: 'Sarabun', sans-serif;
            background: var(--surface-muted);
            color: #2c1720;
            min-height: 100vh;
        }

        :root {
            --primary-bg: #E1B1C1;
            --secondary-bg: #894D5B;
            --accent-color: #C4E9F8;
            --success-color: #88A82A;
            --warning-color: #21510A;
            --surface-muted: #f8f1f4;
        }
        
        .view {
            padding: 1.5rem 1rem;
        }

        .view-container {
            width: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .nav-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: flex-start;
            width: 100%;
        }

        @media (min-width: 768px) {
            .nav-list {
                width: auto;
                justify-content: flex-end;
            }
        }

        @media (max-width: 767px) {
            .nav-item {
                flex: 1 1 calc(50% - 0.5rem);
                text-align: center;
            }
        }

        .nav-item {
            transition: all 0.3s ease;
            border-radius: 8px;
            color: inherit;
        }

        .nav-item:hover {
            background: rgba(137, 77, 91, 0.12);
        }

        .nav-item.active {
            background: rgba(137, 77, 91, 0.18);
            border-bottom: 3px solid var(--secondary-bg);
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(137, 77, 91, 0.08);
        }
        
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: var(--secondary-bg);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #6f3b48;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--primary-bg);
            color: var(--secondary-bg);
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background: #d9a6b7;
            color: var(--secondary-bg);
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            background: var(--warning-color);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .table th {
            background: var(--primary-bg);
            font-weight: 600;
            color: #4a2c35;
        }

        .table tbody tr {
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .table tbody tr:hover {
            background: rgba(225, 177, 193, 0.25);
        }

        .table tbody tr.is-active {
            background: rgba(137, 77, 91, 0.12);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--secondary-bg);
            box-shadow: 0 0 0 3px rgba(137, 77, 91, 0.1);
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-assigned {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-completed {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .queue-score {
            display: inline-block;
            background: rgba(137, 77, 91, 0.12);
            color: var(--secondary-bg);
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 12px;
        }
        
        .teacher-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--secondary-bg);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
            overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .teacher-avatar-large {
            width: 62px;
            height: 62px;
            border-radius: 50%;
            background: var(--secondary-bg);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 12px rgba(137,77,91,0.15);
        }
        
        .teacher-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .next-queue-grid {
            display: grid;
            gap: 0.4rem;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        }

        @media (min-width: 1280px) {
            .next-queue-grid {
                grid-template-columns: repeat(13, minmax(0, 1fr));
            }
        }

        .next-queue-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            gap: 0.35rem;
            padding: 0.5rem;
            border-radius: 12px;
            background: white;
            border: 1px solid rgba(137, 77, 91, 0.18);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            min-height: 140px;
        }

        .next-queue-card .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 1px 6px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 600;
            color: var(--secondary-bg);
            background: rgba(137, 77, 91, 0.15);
            white-space: nowrap;
        }

        .next-queue-card .queue-mini-stat {
            display: flex;
            width: 100%;
            align-items: center;
            justify-content: space-between;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 6px;
            background: rgba(225, 177, 193, 0.25);
            color: #4a2c35;
            font-weight: 500;
        }

        .next-queue-card .queue-mini-stat.is-duty {
            background: rgba(196, 233, 248, 0.35);
            color: #2a5a6f;
        }

        .next-queue-card .queue-mini-stat.is-sub {
            background: rgba(136, 168, 42, 0.18);
            color: var(--warning-color);
        }

        .log-entry {
            border-left: 4px solid #e5e7eb;
            padding-left: 12px;
            margin-bottom: 12px;
        }
        
        .log-entry.auto-assign {
            border-left-color: var(--success-color);
        }
        
        .log-entry.manual-edit {
            border-left-color: var(--warning-color);
        }
        
        .log-entry.substitution {
            border-left-color: var(--secondary-bg);
        }

        .teacher-detail-card {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .teacher-detail-card .detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #4b5563;
        }

        .teacher-detail-card .detail-row span:first-child {
            font-weight: 600;
            color: #374151;
        }

    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <div class="flex flex-col h-screen"><!-- Top Navigation -->
   <div class="shadow-lg" style="background: var(--primary-bg); color: #4a2c35;">
    <div class="px-6 py-4">
     <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
       <h1 id="systemTitle" class="text-xl font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏π</h1>
       <p id="schoolName" class="text-sm opacity-80">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</p>
      </div>
      <nav class="nav-list">
       <div class="nav-item active px-4 py-2 cursor-pointer rounded-lg" data-view="dashboard">
        <div class="flex items-center"><span class="mr-2">üè†</span> <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
        </div>
       </div>
       <div class="nav-item px-4 py-2 cursor-pointer rounded-lg" data-view="events">
        <div class="flex items-center"><span class="mr-2">üìÖ</span> <span>‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</span>
        </div>
       </div>
       <div class="nav-item px-4 py-2 cursor-pointer rounded-lg" data-view="training">
        <div class="flex items-center"><span class="mr-2">üéì</span> <span>‡∏≠‡∏ö‡∏£‡∏°</span>
        </div>
       </div>
       <div class="nav-item px-4 py-2 cursor-pointer rounded-lg" data-view="teachers">
        <div class="flex items-center"><span class="mr-2">üë•</span> <span>‡∏Ñ‡∏£‡∏π</span>
        </div>
       </div>
       <div class="nav-item px-4 py-2 cursor-pointer rounded-lg" data-view="history">
        <div class="flex items-center"><span class="mr-2">üìã</span> <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
        </div>
       </div>
      </nav>
     </div>
    </div>
   </div><!-- Main Content -->
   <div class="flex-1 overflow-auto" style="background: var(--surface-muted);"><!-- Dashboard View -->
    <div id="dashboard-view" class="view">
     <div class="view-container">
      <h2 class="text-2xl font-bold text-gray-800">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å - ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</h2><!-- Next Queue Section - ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î -->
      <div class="card p-5">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><span class="mr-2">‚è≠Ô∏è</span>‡∏Ñ‡∏¥‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏õ - ‡∏Ñ‡∏£‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h3>
      <div id="next-queue"><!-- Next queue will be populated here -->
      </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card p-6 border-l-4" style="border-left-color: var(--secondary-bg);">
       <div class="flex items-center">
        <div class="p-3 rounded-full mr-4" style="background: rgba(225, 177, 193, 0.35); color: var(--secondary-bg);"><span class="text-2xl">üìÖ</span>
        </div>
        <div>
         <p class="text-sm text-gray-600">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
         <p class="text-2xl font-bold" style="color: var(--secondary-bg);" id="total-events">0</p>
        </div>
       </div>
      </div>
      <div class="card p-6 border-l-4" style="border-left-color: #88A82A;">
       <div class="flex items-center">
        <div class="p-3 rounded-full mr-4" style="background: rgba(136, 168, 42, 0.1); color: #88A82A;"><span class="text-2xl">‚úÖ</span>
        </div>
        <div>
         <p class="text-sm text-gray-600">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</p>
         <p class="text-2xl font-bold" style="color: #88A82A;" id="assigned-events">0</p>
        </div>
       </div>
      </div>
      <div class="card p-6 border-l-4" style="border-left-color: var(--accent-color);">
       <div class="flex items-center">
        <div class="p-3 rounded-full mr-4" style="background: rgba(196, 233, 248, 0.3); color: #1E90FF;"><span class="text-2xl">‚è≥</span>
        </div>
        <div>
         <p class="text-sm text-gray-600">‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß</p>
         <p class="text-2xl font-bold" style="color: #1E90FF;" id="pending-events">0</p>
        </div>
       </div>
      </div>
      <div class="card p-6 border-l-4" style="border-left-color: var(--secondary-bg);">
       <div class="flex items-center">
        <div class="p-3 rounded-full mr-4" style="background: rgba(225, 177, 193, 0.35); color: var(--secondary-bg);"><span class="text-2xl">üë•</span>
        </div>
        <div>
         <p class="text-sm text-gray-600">‡∏Ñ‡∏£‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
         <p class="text-2xl font-bold" style="color: var(--secondary-bg);" id="total-teachers">0</p>
        </div>
       </div>
      </div>
      </div><!-- Latest Event Section -->
      <div class="card p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><span class="mr-2">üéØ</span>‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</h3>
      <div id="latest-event" class="space-y-3"><!-- Latest event will be populated here -->
      </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="card p-6">
       <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</h3>
       <div id="urgent-events" class="space-y-3"><!-- Urgent events will be populated here -->
       </div>
      </div>
      <div class="card p-6">
       <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
       <div id="top-queue-teachers" class="space-y-3"><!-- Top queue teachers will be populated here -->
       </div>
      </div>
      </div><!-- Queue Score Explanation -->
      <div class="card p-8 border-2" style="background: rgba(225, 177, 193, 0.2); border-color: var(--secondary-bg);">
      <h3 class="text-xl font-bold mb-6 flex items-center" style="color: var(--secondary-bg);"><span class="mr-3 text-2xl">üéØ</span>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏° - ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
       <div class="p-4 rounded-lg" style="background: rgba(136, 168, 42, 0.1); border-left: 4px solid #88A82A;">
        <h4 class="font-bold text-gray-800 mb-3 flex items-center"><span class="mr-2">üèÅ</span>‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</h4>
        <ul class="text-sm text-gray-700 space-y-2">
         <li>‚Ä¢ ‡∏Ñ‡∏£‡∏π‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ <strong>0 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</strong></li>
         <li>‚Ä¢ <strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡πâ‡∏≠‡∏¢ = ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÑ‡∏î‡πâ‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡∏Å</strong></li>
         <li>‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô</li>
         <li>‚Ä¢ ‡∏¢‡∏¥‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢ ‡∏¢‡∏¥‡πà‡∏á‡πÑ‡∏î‡πâ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏°‡∏≤‡∏Å</li>
        </ul>
       </div>
       <div class="p-4 rounded-lg" style="background: rgba(196, 233, 248, 0.3); border-left: 4px solid #C4E9F8;">
        <h4 class="font-bold text-gray-800 mb-3 flex items-center"><span class="mr-2">üìà</span>‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h4>
        <ul class="text-sm text-gray-700 space-y-2">
         <li>‚Ä¢ ‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á = <strong>+15 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</strong></li>
         <li>‚Ä¢ ‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô = <strong>+25 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</strong></li>
         <li>‚Ä¢ ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏© = <strong>+20 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</strong></li>
         <li>‚Ä¢ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏ï‡∏•‡∏≠‡∏î‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</li>
        </ul>
       </div>
       <div class="p-4 rounded-lg" style="background: rgba(225, 177, 193, 0.35); border-left: 4px solid var(--secondary-bg);">
        <h4 class="font-bold text-gray-800 mb-3 flex items-center"><span class="mr-2">‚öñÔ∏è</span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∏‡∏ï‡∏¥‡∏ò‡∏£‡∏£‡∏°</h4>
        <ul class="text-sm text-gray-700 space-y-2">
         <li>‚Ä¢ ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î</li>
         <li>‚Ä¢ ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</li>
         <li>‚Ä¢ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏°</li>
         <li>‚Ä¢ ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</li>
        </ul>
       </div>
      </div>
      <div class="p-4 rounded-lg" style="background: rgba(137, 77, 91, 0.05); border: 1px solid rgba(137, 77, 91, 0.2);">
       <p class="text-center font-medium" style="color: var(--secondary-bg);">üí° <strong>‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong> ‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô</p>
      </div>
     </div>
    </div>
    </div><!-- Events Management View -->
    <div id="events-view" class="view hidden">
     <div class="view-container">
      <div class="flex justify-between items-center">
       <h2 class="text-2xl font-bold text-gray-800">‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</h2><button class="btn-primary" onclick="openEventModal()"> <span class="mr-2">+</span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà </button>
      </div>
      <div id="events-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"><!-- Event cards will be populated here -->
      </div>
     </div>
    </div><!-- Training Management View -->
    <div id="training-view" class="view hidden">
     <div class="view-container">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
       <h2 class="text-2xl font-bold text-gray-800">‡∏≠‡∏ö‡∏£‡∏°</h2>
       <div class="flex flex-wrap gap-3">
        <button class="btn-primary" onclick="openEventModal(null, QUEUE_TYPES.TRAINING)"><span class="mr-2">+</span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</button>
        <button class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50" onclick="showTrainingQueueGuide()">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏ö‡∏£‡∏°</button>
       </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
       <div class="card p-6 border-l-4" style="border-left-color: var(--secondary-bg);">
        <div class="flex items-center">
         <div class="p-3 rounded-full mr-4" style="background: rgba(225, 177, 193, 0.35); color: var(--secondary-bg);"><span class="text-2xl">üéì</span>
         </div>
         <div>
          <p class="text-sm text-gray-600">‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
          <p class="text-2xl font-bold" style="color: var(--secondary-bg);" id="total-training-events">0</p>
         </div>
        </div>
       </div>
       <div class="card p-6 border-l-4" style="border-left-color: #88A82A;">
        <div class="flex items-center">
         <div class="p-3 rounded-full mr-4" style="background: rgba(136, 168, 42, 0.1); color: #88A82A;"><span class="text-2xl">‚úÖ</span>
         </div>
         <div>
          <p class="text-sm text-gray-600">‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</p>
          <p class="text-2xl font-bold" style="color: #88A82A;" id="assigned-training-events">0</p>
         </div>
        </div>
       </div>
       <div class="card p-6 border-l-4" style="border-left-color: var(--accent-color);">
        <div class="flex items-center">
         <div class="p-3 rounded-full mr-4" style="background: rgba(196, 233, 248, 0.3); color: #1E90FF;"><span class="text-2xl">‚è≥</span>
         </div>
         <div>
          <p class="text-sm text-gray-600">‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß</p>
          <p class="text-2xl font-bold" style="color: #1E90FF;" id="pending-training-events">0</p>
         </div>
        </div>
       </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
       <div class="card p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏∂‡∏á</h3>
        <div id="upcoming-training-events" class="space-y-3"></div>
       </div>
       <div class="card p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏ö‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
        <div id="recent-training-teachers" class="space-y-3"></div>
       </div>
      </div>
      <div class="card p-6 mt-4">
       <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
       <div id="training-events-cards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
     </div>
    </div><!-- Teachers Management View -->
    <div id="teachers-view" class="view hidden">
     <div class="view-container">
      <div class="flex justify-between items-center">
       <h2 class="text-2xl font-bold text-gray-800">‡∏Ñ‡∏£‡∏π</h2><button class="btn-primary" onclick="openTeacherModal()"> <span class="mr-2">+</span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡∏°‡πà </button>
      </div>
      <div class="grid grid-cols-1 xl:grid-cols-3 gap-5">
       <div class="xl:col-span-2 card p-0">
        <div class="overflow-x-auto">
         <table class="table">
          <thead>
           <tr>
            <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π</th>
            <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
            <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏ß</th>
            <th>‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</th>
            <th>‡∏≠‡∏ö‡∏£‡∏°</th>
            <th>‡πÅ‡∏ó‡∏ô‡∏£‡∏ß‡∏°</th>
           </tr>
          </thead>
          <tbody id="teachers-table-body"></tbody>
         </table>
        </div>
       </div>
       <div id="teacher-detail-panel" class="card p-6 teacher-detail-card">
        <p class="text-sm text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
       </div>
      </div>
     </div>
    </div><!-- History View -->
    <div id="history-view" class="view hidden">
     <div class="view-container">
      <h2 class="text-2xl font-bold text-gray-800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
       <div class="card p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
        <div id="duty-distribution" class="space-y-2"><!-- Duty distribution will be populated here -->
        </div>
       </div>
       <div class="card p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏á‡∏≤‡∏ô</h3>
        <div id="substitution-stats" class="space-y-2"><!-- Substitution stats will be populated here -->
        </div>
       </div>
      </div>
      <div class="card p-6">
       <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
       <div id="activity-log" class="space-y-3 max-h-96 overflow-y-auto"><!-- Activity log will be populated here -->
       </div>
      </div>
     </div>
    </div>
    </div>
  </div><!-- Event Modal -->
  <div id="event-modal" class="modal">
   <div class="modal-content w-full max-w-2xl">
    <div class="flex justify-between items-center mb-6">
     <h3 id="event-modal-title" class="text-xl font-bold text-gray-800">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3><button onclick="closeEventModal()" class="text-gray-500 hover:text-gray-700"> <span class="text-2xl">√ó</span> </button>
    </div>
    <form id="event-form">
     <div class="grid grid-cols-1 gap-4">
      <div class="form-group"><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label> <input type="text" id="event-name" class="form-input" required>
      </div>
      <div class="form-group"><label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label> <textarea id="event-details" class="form-input" rows="3" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô"></textarea>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div class="form-group"><label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label> <input type="date" id="event-date" class="form-input" required>
       </div>
       <div class="form-group md:col-span-1"><label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
        <div class="flex flex-col sm:flex-row gap-3">
         <input type="time" id="event-start-time" class="form-input sm:flex-1" required>
         <input type="time" id="event-end-time" class="form-input sm:flex-1" required>
        </div>
       </div>
      </div>
      <div class="form-group"><label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
       <input type="text" id="event-location" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏ç‡πà ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ô‡∏Ñ‡∏≤‡∏û‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°" required>
      </div>
      <div class="form-group md:w-1/2"><label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</label> <input type="number" id="event-quota" class="form-input" min="1" required>
      </div>
     </div>
     <div id="event-assignment-summary" class="mt-4 hidden">
      <h4 class="text-sm font-semibold text-gray-700 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h4>
      <div id="event-assignment-list" class="space-y-2"></div>
     </div>
     <input type="hidden" id="event-location-lat" value="">
     <input type="hidden" id="event-location-lng" value="">
     <div class="flex justify-end space-x-3 mt-6"><button type="button" onclick="closeEventModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button> <button type="submit" class="btn-primary"> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å </button>
     </div>
    </form>
   </div>
  </div><!-- Teacher Modal -->
  <div id="teacher-modal" class="modal">
   <div class="modal-content w-full max-w-lg">
    <div class="flex justify-between items-center mb-6">
     <h3 id="teacher-modal-title" class="text-xl font-bold text-gray-800">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡∏°‡πà</h3><button onclick="closeTeacherModal()" class="text-gray-500 hover:text-gray-700"> <span class="text-2xl">√ó</span> </button>
    </div>
    <form id="teacher-form">
     <div class="form-group"><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠</label> <input type="text" id="teacher-name" class="form-input" required>
     </div>
     <div class="form-group"><label class="form-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label> <input type="text" id="teacher-position" class="form-input" required>
     </div>
     <div class="form-group"><label class="form-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label> <input type="number" id="teacher-queue-score" class="form-input" value="100" min="0" required>
     </div>
     <div class="flex justify-end space-x-3 mt-6"><button type="button" onclick="closeTeacherModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button> <button type="submit" class="btn-primary"> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å </button>
     </div>
    </form>
   </div>
  </div><!-- Auto Assign Modal -->
  <div id="auto-assign-modal" class="modal">
   <div class="modal-content w-full max-w-lg">
    <div class="flex justify-between items-center mb-6">
     <h3 class="text-xl font-bold text-gray-800">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h3><button onclick="closeAutoAssignModal()" class="text-gray-500 hover:text-gray-700"> <span class="text-2xl">√ó</span> </button>
    </div>
    <div id="auto-assign-content"><!-- Auto assign content will be populated here -->
    </div>
    <div class="flex justify-end space-x-3 mt-6"><button onclick="closeAutoAssignModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button> <button id="confirm-auto-assign" class="btn-success"> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß </button>
    </div>
   </div>
  </div><!-- Substitution Modal -->
  <div id="substitution-modal" class="modal">
   <div class="modal-content w-full max-w-lg">
    <div class="flex justify-between items-center mb-6">
     <h3 class="text-xl font-bold text-gray-800">‡πÅ‡∏ó‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</h3><button onclick="closeSubstitutionModal()" class="text-gray-500 hover:text-gray-700"> <span class="text-2xl">√ó</span> </button>
    </div>
    <form id="substitution-form">
     <div class="form-group"><label class="form-label">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏≠‡∏Å</label> <select id="original-teacher" class="form-input" required> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π</option> </select>
     </div>
     <div class="form-group"><label class="form-label">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏≤‡πÅ‡∏ó‡∏ô</label> <select id="substitute-teacher" class="form-input" required> <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π</option> </select>
     </div>
     <div class="form-group"><label class="form-label">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label> <textarea id="substitution-reason" class="form-input" rows="3" required placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£"></textarea>
     </div>
     <div class="flex justify-end space-x-3 mt-6"><button type="button" onclick="closeSubstitutionModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button> <button type="submit" class="btn-danger"> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô </button>
     </div>
    </form>
  </div>
 </div>
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-[2000] hidden">
   <div class="text-center">
    <svg class="animate-spin h-10 w-10 text-[#894D5B] mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
     <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
     <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p class="text-sm font-medium text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
   </div>
  </div>
  <script>
        // Firebase initialization bridge (shared with module loader)
        window.firebaseAppConfig = window.firebaseAppConfig || {
            apiKey: "AIzaSyDv--hw2BWKE-NTFrCMpTNz9LEzGK8l5PE",
            authDomain: "thaigogo-e9112.firebaseapp.com",
            databaseURL: "https://thaigogo-e9112-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "thaigogo-e9112",
            storageBucket: "thaigogo-e9112.firebasestorage.app",
            messagingSenderId: "820257616141",
            appId: "1:820257616141:web:c92cf50ae5e05491fb4044",
            measurementId: "G-4FX435MNDC"
        };

        window.firebaseReadyPromise = window.firebaseReadyPromise || new Promise((resolve, reject) => {
            window.__resolveFirebaseReady = resolve;
            window.__rejectFirebaseReady = reject;
        });

        window.notifyFirebaseReady = function(app, database, helpers) {
            window.firebaseApp = app;
            window.firebaseDatabase = database;
            if (helpers) {
                window.firebaseDbApi = helpers;
            }
            if (typeof window.__resolveFirebaseReady === 'function') {
                window.__resolveFirebaseReady({ app, database });
                window.__resolveFirebaseReady = null;
            }
        };

        window.notifyFirebaseInitError = function(error) {
            if (typeof window.__rejectFirebaseReady === 'function') {
                window.__rejectFirebaseReady(error);
                window.__rejectFirebaseReady = null;
            }
            console.error('Firebase initialization failed:', error);
        };

        // Default configuration
        const defaultConfig = {
            system_title: "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏π",
            school_name: "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢"
        };

        const PRIMARY_COLOR = '#894D5B';
        const SECONDARY_COLOR = '#E1B1C1';

        const QUEUE_TYPES = Object.freeze({
            DUTY: 'duty',
            TRAINING: 'training'
        });
        window.QUEUE_TYPES = QUEUE_TYPES;

        // Data structures
        let systemConfig = { ...defaultConfig };
        let teachers = [];
        let events = [];
        let trainingEvents = [];
        let activityLog = [];
        let currentEventId = null;
        let currentTeacherId = null;
        let currentEventQueueType = QUEUE_TYPES.DUTY;
        let selectedTeacherId = null;
        let dataInitialized = false;
        let firebaseDataLoaded = false;

        function ensureTeacherStats(teacher) {
            if (!teacher || typeof teacher !== 'object') {
                return teacher;
            }

            if (typeof teacher.totalDuties !== 'number') {
                teacher.totalDuties = typeof teacher.totalDuties === 'number' ? teacher.totalDuties : 0;
            }
            if (typeof teacher.swapCount !== 'number') {
                teacher.swapCount = typeof teacher.swapCount === 'number' ? teacher.swapCount : 0;
            }

            teacher.dutyDuties = typeof teacher.dutyDuties === 'number'
                ? teacher.dutyDuties
                : (typeof teacher.totalDuties === 'number' ? teacher.totalDuties : 0);
            teacher.trainingDuties = typeof teacher.trainingDuties === 'number' ? teacher.trainingDuties : 0;

            teacher.dutySwapCount = typeof teacher.dutySwapCount === 'number'
                ? teacher.dutySwapCount
                : (typeof teacher.swapCount === 'number' ? teacher.swapCount : 0);
            teacher.trainingSwapCount = typeof teacher.trainingSwapCount === 'number' ? teacher.trainingSwapCount : 0;

            teacher.lastDutyDate = normalizeDateString(teacher.lastDutyDate || teacher.lastEventDate);
            teacher.lastTrainingDate = normalizeDateString(teacher.lastTrainingDate);
            const normalizedLastEvent = normalizeDateString(teacher.lastEventDate);
            teacher.lastEventDate = latestDateString(teacher.lastDutyDate, teacher.lastTrainingDate) || normalizedLastEvent;

            teacher.totalDuties = (teacher.dutyDuties || 0) + (teacher.trainingDuties || 0);
            teacher.swapCount = (teacher.dutySwapCount || 0) + (teacher.trainingSwapCount || 0);

            return teacher;
        }

        function ensureAllTeacherStats() {
            teachers.forEach(ensureTeacherStats);
        }

        function getQueueEvents(queueType = QUEUE_TYPES.DUTY) {
            return queueType === QUEUE_TYPES.TRAINING ? trainingEvents : events;
        }

        function setQueueEvents(queueType, collection) {
            if (queueType === QUEUE_TYPES.TRAINING) {
                trainingEvents = collection;
            } else {
                events = collection;
            }
        }

        function getQueueView(queueType = QUEUE_TYPES.DUTY) {
            return queueType === QUEUE_TYPES.TRAINING ? 'training' : 'events';
        }

        function getQueueDisplayName(queueType = QUEUE_TYPES.DUTY) {
            return queueType === QUEUE_TYPES.TRAINING ? '‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°' : '‡∏á‡∏≤‡∏ô';
        }

        function safeDate(value) {
            if (!value) {
                return null;
            }
            const date = new Date(value);
            return Number.isNaN(date.getTime()) ? null : date;
        }

        function normalizeDateString(value) {
            const date = safeDate(value);
            return date ? date.toISOString().slice(0, 10) : null;
        }

        function latestDateString(dateA, dateB) {
            const parsedA = safeDate(dateA);
            const parsedB = safeDate(dateB);

            if (!parsedA && !parsedB) {
                return null;
            }
            if (!parsedA) {
                return parsedB.toISOString().slice(0, 10);
            }
            if (!parsedB) {
                return parsedA.toISOString().slice(0, 10);
            }

            const latest = parsedA > parsedB ? parsedA : parsedB;
            return latest.toISOString().slice(0, 10);
        }

        function recomputeTeacherStats() {
            const teacherMap = new Map();

            teachers.forEach(teacher => {
                ensureTeacherStats(teacher);
                teacher.dutyDuties = 0;
                teacher.trainingDuties = 0;
                teacher.dutySwapCount = 0;
                teacher.trainingSwapCount = 0;
                teacher.totalDuties = 0;
                teacher.swapCount = 0;
                teacher.lastDutyDate = null;
                teacher.lastTrainingDate = null;
                teacherMap.set(teacher.teacherId, teacher);
            });

            const updateFromEvent = (event, queueType) => {
                const slots = getEventAssignmentSlots(event);
                slots.forEach(slot => {
                    if (!slot || slot.currentTeacherId === null || slot.currentTeacherId === undefined) {
                        return;
                    }
                    const teacher = teacherMap.get(slot.currentTeacherId);
                    if (!teacher) {
                        return;
                    }

                    const dateValue = normalizeDateString(event.date);
                    if (queueType === QUEUE_TYPES.TRAINING) {
                        teacher.trainingDuties = (teacher.trainingDuties || 0) + 1;
                        teacher.lastTrainingDate = latestDateString(teacher.lastTrainingDate, dateValue);
                        if (slot.originalTeacherId && slot.originalTeacherId !== slot.currentTeacherId) {
                            teacher.trainingSwapCount = (teacher.trainingSwapCount || 0) + 1;
                        }
                    } else {
                        teacher.dutyDuties = (teacher.dutyDuties || 0) + 1;
                        teacher.lastDutyDate = latestDateString(teacher.lastDutyDate, dateValue);
                        if (slot.originalTeacherId && slot.originalTeacherId !== slot.currentTeacherId) {
                            teacher.dutySwapCount = (teacher.dutySwapCount || 0) + 1;
                        }
                    }
                });
            };

            events.forEach(event => updateFromEvent(event, QUEUE_TYPES.DUTY));
            trainingEvents.forEach(event => updateFromEvent(event, QUEUE_TYPES.TRAINING));

            teachers.forEach(teacher => {
                teacher.totalDuties = (teacher.dutyDuties || 0) + (teacher.trainingDuties || 0);
                teacher.swapCount = (teacher.dutySwapCount || 0) + (teacher.trainingSwapCount || 0);
                const latestOverall = latestDateString(teacher.lastDutyDate, teacher.lastTrainingDate);
                teacher.lastEventDate = latestOverall || normalizeDateString(teacher.lastEventDate);
            });
        }

        function normalizeTeacherId(value) {
            if (value === null || value === undefined) {
                return null;
            }

            if (typeof value === 'number') {
                return value;
            }

            const parsed = Number(value);
            return Number.isFinite(parsed) ? parsed : value;
        }

        function createAssignmentSlotsFromIds(ids = []) {
            return (Array.isArray(ids) ? ids : [])
                .filter(id => id !== null && id !== undefined)
                .map(id => {
                    const normalizedId = normalizeTeacherId(id);
                    return {
                        originalTeacherId: normalizedId,
                        currentTeacherId: normalizedId,
                        substituteTeacherId: null
                    };
                });
        }

        function ensureEventAssignments(event) {
            if (!event || typeof event !== 'object') {
                return event;
            }

            if (!Array.isArray(event.assignmentSlots) || event.assignmentSlots.length === 0) {
                event.assignmentSlots = createAssignmentSlotsFromIds(event.assignedTeachers);
            } else {
                event.assignmentSlots = event.assignmentSlots.map(slot => {
                    const originalId = normalizeTeacherId(slot.originalTeacherId ?? slot.teacherId ?? slot.currentTeacherId ?? null);
                    const currentId = normalizeTeacherId(slot.currentTeacherId ?? slot.substituteTeacherId ?? originalId);
                    return {
                        originalTeacherId: originalId,
                        currentTeacherId: currentId,
                        substituteTeacherId: currentId && originalId && currentId !== originalId ? currentId : null
                    };
                });
            }

            event.assignedTeachers = event.assignmentSlots
                .map(slot => slot.currentTeacherId)
                .filter(id => id !== null && id !== undefined);

            return event;
        }

        function getEventAssignmentSlots(event) {
            if (!event) {
                return [];
            }
            ensureEventAssignments(event);
            return event.assignmentSlots;
        }

        function canUseDirectFirebase() {
            return !!(
                window.firebaseDbApi &&
                typeof window.firebaseDbApi.get === 'function' &&
                typeof window.firebaseDbApi.put === 'function'
            );
        }

        async function firebaseFetch(path, options = {}) {
            if (!canUseDirectFirebase()) {
                throw new Error('Firebase database is not ready');
            }

            const helpers = window.firebaseDbApi;
            const method = (options.method || 'GET').toUpperCase();

            if (method === 'GET') {
                return helpers.get(path);
            }

            let payload = options.body;
            if (typeof payload === 'string') {
                try {
                    payload = JSON.parse(payload);
                } catch (error) {
                    console.warn('Unable to parse Firebase payload string, sending raw value.');
                }
            }

            if (method === 'PUT') {
                return helpers.put(path, payload);
            }

            if (method === 'PATCH') {
                if (payload && typeof payload === 'object') {
                    return helpers.patch(path, payload);
                }
                throw new Error('PATCH requests require a JSON object payload');
            }

            throw new Error(`Unsupported Firebase method: ${method}`);
        }

        function normalizeFirebaseList(value) {
            if (Array.isArray(value)) {
                return value.filter(item => item !== null && item !== undefined);
            }

            if (value && typeof value === 'object') {
                return Object.keys(value)
                    .sort((a, b) => {
                        const numA = Number(a);
                        const numB = Number(b);
                        const bothNumeric = !Number.isNaN(numA) && !Number.isNaN(numB);
                        return bothNumeric ? numA - numB : a.localeCompare(b);
                    })
                    .map(key => value[key]);
            }

            return [];
        }

        function toggleLoadingOverlay(show) {
            const overlay = document.getElementById('loading-overlay');
            if (!overlay) return;
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function createDefaultTeachers() {
            const baseTeachers = [
                { teacherId: 1, name: '‡∏û‡∏£‡∏£‡∏ß‡∏¥‡∏ô‡∏ó‡πå', position: '‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2024-07-07' },
                { teacherId: 2, name: '‡∏™‡∏≠‡∏≤‡∏î‡∏ß‡∏£‡∏£‡∏ì', position: '‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2024-07-07' },
                { teacherId: 3, name: '‡∏™‡∏∏‡∏ó‡∏±‡∏®‡∏©‡∏≤', position: '‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2024-07-07' },
                { teacherId: 4, name: '‡∏Å‡∏§‡∏©‡∏ì‡∏µ‡∏ô‡∏≤‡∏ó', position: '‡∏Ñ‡∏£‡∏π', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2025-04-01' },
                { teacherId: 5, name: '‡∏Ç‡∏ß‡∏±‡∏ç‡∏ô‡∏≤‡∏Ñ', position: '‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2025-01-08' },
                { teacherId: 6, name: '‡∏ô‡∏±‡∏ä‡∏ô‡∏±‡∏ô‡∏ó‡πå', position: '‡∏Ñ‡∏£‡∏π', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2024-08-12' },
                { teacherId: 7, name: '‡∏ô‡∏±‡∏ô‡∏ó‡∏ô‡∏≤', position: '‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2025-01-08' },
                { teacherId: 8, name: '‡πÄ‡∏û‡πá‡∏ç‡∏û‡∏£‡∏£‡∏ì‡∏µ', position: '‡∏Ñ‡∏£‡∏π', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2024-08-12' },
                { teacherId: 9, name: '‡∏ß‡∏¥‡∏ô‡∏±‡∏¢', position: '‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2025-04-01' },
                { teacherId: 10, name: '‡∏ß‡∏¥‡∏•‡∏≤‡∏ß‡∏£‡∏£‡∏ì', position: '‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2025-01-08' },
                { teacherId: 11, name: '‡∏≠‡∏£‡∏ß‡∏£‡∏£‡∏ì', position: '‡∏Ñ‡∏£‡∏π', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2025-04-01' },
                { teacherId: 12, name: '‡∏≠‡∏±‡∏á‡∏Ñ‡∏ì‡∏≤', position: '‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£', totalDuties: 3, queueScore: 45, swapCount: 0, lastEventDate: '2024-08-12' },
                { teacherId: 13, name: '‡∏†‡∏≤‡∏ì‡∏∏‡∏ß‡∏±‡∏í‡∏ô‡πå', position: '‡∏Ñ‡∏£‡∏π', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2025-04-01' }
            ];

            return baseTeachers.map(teacher => {
                const enriched = {
                    ...teacher,
                    dutyDuties: teacher.totalDuties ?? 0,
                    trainingDuties: teacher.trainingDuties ?? 0,
                    dutySwapCount: teacher.swapCount ?? 0,
                    trainingSwapCount: teacher.trainingSwapCount ?? 0,
                    lastDutyDate: teacher.lastEventDate || null,
                    lastTrainingDate: teacher.lastTrainingDate || null
                };
                ensureTeacherStats(enriched);
                return enriched;
            });
        }

        function createDefaultEvents() {
            const defaultEvents = [
                {
                    eventId: 1,
                    eventName: '‡∏û‡∏¥‡∏ò‡∏µ‡πÄ‡∏™‡∏Å‡∏ô‡πâ‡∏≥‡∏û‡∏£‡∏∞‡∏û‡∏∏‡∏ó‡∏ò‡∏°‡∏ô‡∏ï‡πå‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå',
                    details: '‡∏û‡∏¥‡∏ò‡∏µ‡πÄ‡∏™‡∏Å‡∏ô‡πâ‡∏≥‡∏û‡∏£‡∏∞‡∏û‡∏∏‡∏ó‡∏ò‡∏°‡∏ô‡∏ï‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡∏£‡∏¥‡∏°‡∏á‡∏Ñ‡∏• ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á',
                    date: '2024-07-07',
                    startTime: '15:00',
                    endTime: '17:00',
                    time: '15:00-17:00',
                    location: '‡∏ß‡∏±‡∏î‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ò‡∏≤‡∏ï‡∏∏‡∏ß‡∏£‡∏ß‡∏¥‡∏´‡∏≤‡∏£ ‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó',
                    requiredQuota: 3,
                    assignedTeachers: [1, 2, 3],
                    status: 'assigned'
                },
                {
                    eventId: 2,
                    eventName: '‡∏à‡∏∏‡∏î‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡∏ä‡∏±‡∏¢‡∏ñ‡∏ß‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏û‡∏£',
                    details: '‡∏û‡∏¥‡∏ò‡∏µ‡∏à‡∏∏‡∏î‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡∏ä‡∏±‡∏¢‡∏ñ‡∏ß‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏û‡∏£‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Ç‡∏ö‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏á‡∏£‡∏±‡∏Å‡∏†‡∏±‡∏Å‡∏î‡∏µ',
                    date: '2024-08-12',
                    startTime: '18:30',
                    endTime: '20:00',
                    time: '18:30-20:00',
                    location: '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏¥‡∏°‡∏•‡∏Ñ‡∏∏‡∏ì‡∏≤‡∏Å‡∏£',
                    requiredQuota: 5,
                    assignedTeachers: [5, 6, 7, 8, 12],
                    status: 'assigned'
                },
                {
                    eventId: 3,
                    eventName: '‡∏ß‡∏±‡∏ô‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏à‡πâ‡∏≤‡∏ü‡πâ‡∏≤‡∏™‡∏¥‡∏£‡∏¥‡∏ß‡∏±‡∏ì‡∏ì‡∏ß‡∏£‡∏µ ‡∏ô‡∏≤‡∏£‡∏µ‡∏£‡∏±‡∏ï‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏±‡∏ç‡∏ç‡∏≤',
                    date: '2025-01-08',
                    startTime: '07:00',
                    endTime: '12:00',
                    time: '07:00-12:00',
                    location: '‡πÄ‡∏Ç‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏´‡∏¥‡∏ô',
                    requiredQuota: 4,
                    assignedTeachers: [5, 7, 10, 12],
                    status: 'assigned'
                },
                {
                    eventId: 4,
                    eventName: '‡∏ß‡∏±‡∏ô‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ò‡∏¥‡∏Å‡∏≤‡∏£ 133 ‡∏õ‡∏µ',
                    date: '2025-04-01',
                    startTime: '07:00',
                    endTime: '16:00',
                    time: '07:00-16:00',
                    location: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ô‡∏Ñ‡∏≤‡∏û‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°',
                    requiredQuota: 5,
                    assignedTeachers: [2, 4, 9, 11, 13],
                    status: 'assigned'
                },
                {
                    eventId: 5,
                    eventName: '‡∏ß‡∏±‡∏ô‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏†‡∏û ‡πÉ‡∏ô‡∏´‡∏•‡∏ß‡∏á',
                    date: '2024-07-28',
                    startTime: '07:00',
                    endTime: '12:00',
                    time: '07:00-12:00',
                    location: '‡πÄ‡∏Ç‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏´‡∏¥‡∏ô',
                    requiredQuota: 5,
                    assignedTeachers: [1, 3, 6, 9, 10],
                    status: 'assigned'
                },
                {
                    eventId: 6,
                    eventName: '‡∏ü‡∏±‡∏á‡∏™‡∏ß‡∏î‡∏≠‡∏†‡∏¥‡∏ò‡∏£‡∏£‡∏°‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ‡∏ô‡∏≤‡∏ñ',
                    date: '2024-10-28',
                    startTime: '16:45',
                    endTime: '18:00',
                    time: '16:45-18:00',
                    location: '‡∏ß‡∏±‡∏î‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏ò‡∏≤‡∏ï‡∏∏‡∏ß‡∏£‡∏ß‡∏¥‡∏´‡∏≤‡∏£ ‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó',
                    requiredQuota: 5,
                    assignedTeachers: [],
                    status: 'pending'
                }
            ];

            defaultEvents.forEach(event => ensureEventAssignments(event));
            return defaultEvents;
        }

        function createDefaultTrainingEvents() {
            const defaultTraining = [
                {
                    eventId: 101,
                    eventName: '‡∏≠‡∏ö‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏ß‡∏Å',
                    details: '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Ñ‡∏£‡∏π‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢',
                    date: '2024-09-05',
                    startTime: '09:00',
                    endTime: '12:00',
                    time: '09:00-12:00',
                    location: '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û‡∏Ñ‡∏£‡∏π ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó',
                    requiredQuota: 4,
                    assignedTeachers: [2, 5, 8, 11],
                    status: 'assigned'
                },
                {
                    eventId: 102,
                    eventName: '‡∏≠‡∏ö‡∏£‡∏°‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
                    details: '‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏®‡∏ï‡∏ß‡∏£‡∏£‡∏©‡∏ó‡∏µ‡πà 21',
                    date: '2024-11-18',
                    startTime: '13:00',
                    endTime: '16:30',
                    time: '13:00-16:30',
                    location: '‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏è‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó',
                    requiredQuota: 3,
                    assignedTeachers: [1, 6, 10],
                    status: 'assigned'
                },
                {
                    eventId: 103,
                    eventName: '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ',
                    details: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏∑‡πà‡∏≠‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô',
                    date: '2025-02-22',
                    startTime: '08:30',
                    endTime: '16:00',
                    time: '08:30-16:00',
                    location: '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏ç‡πà ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ô‡∏Ñ‡∏≤‡∏û‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°',
                    requiredQuota: 5,
                    assignedTeachers: [3, 4, 7, 9, 12],
                    status: 'assigned'
                }
            ];

            defaultTraining.forEach(event => ensureEventAssignments(event));
            return defaultTraining;
        }

        function updateSystemLabels() {
            const titleEl = document.getElementById('systemTitle');
            const schoolEl = document.getElementById('schoolName');
            if (titleEl) {
                titleEl.textContent = systemConfig.system_title || defaultConfig.system_title;
            }
            if (schoolEl) {
                schoolEl.textContent = systemConfig.school_name || defaultConfig.school_name;
            }
        }

        function renderAllViews() {
            recomputeTeacherStats();
            renderDashboard();
            renderEventsTable();
            renderTrainingView();
            renderTeachersTable();
            renderHistory();
        }

        function buildPersistPayload() {
            return {
                config: systemConfig,
                teachers: teachers,
                events: events,
                trainingEvents: trainingEvents,
                activityLog: activityLog
            };
        }

        async function persistAllDataDirect(payload) {
            const tasks = [];

            if (payload.config !== undefined) {
                tasks.push(firebaseFetch('config', {
                    method: 'PUT',
                    body: JSON.stringify(payload.config)
                }));
            }

            if (payload.teachers !== undefined) {
                tasks.push(firebaseFetch('teachers', {
                    method: 'PUT',
                    body: JSON.stringify(payload.teachers)
                }));
            }

            if (payload.events !== undefined) {
                tasks.push(firebaseFetch('events', {
                    method: 'PUT',
                    body: JSON.stringify(payload.events)
                }));
            }

            if (payload.trainingEvents !== undefined) {
                tasks.push(firebaseFetch('trainingEvents', {
                    method: 'PUT',
                    body: JSON.stringify(payload.trainingEvents)
                }));
            }

            if (payload.activityLog !== undefined) {
                tasks.push(firebaseFetch('activityLog', {
                    method: 'PUT',
                    body: JSON.stringify(payload.activityLog)
                }));
            }

            await Promise.all(tasks);
        }

        function persistAllData() {
            const payload = buildPersistPayload();
            if (canUseDirectFirebase()) {
                return persistAllDataDirect(payload).catch(error => {
                    console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Firebase ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á:', error);
                });
            }

            return Promise.resolve();
        }

        function saveData() {
            if (!dataInitialized) {
                return;
            }

            recomputeTeacherStats();
            const persistResult = persistAllData();
            if (persistResult && typeof persistResult.then === 'function') {
                persistResult.catch(error => console.error('‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error));
            }
            renderAllViews();
        }

        async function fetchInitialDataDirect() {
            const [config, teacherData, eventData, trainingData, logData] = await Promise.all([
                firebaseFetch('config'),
                firebaseFetch('teachers'),
                firebaseFetch('events'),
                firebaseFetch('trainingEvents'),
                firebaseFetch('activityLog')
            ]);

            return {
                config: config || {},
                teachers: normalizeFirebaseList(teacherData),
                events: normalizeFirebaseList(eventData),
                trainingEvents: normalizeFirebaseList(trainingData),
                activityLog: normalizeFirebaseList(logData)
            };
        }

        async function loadInitialData() {
            toggleLoadingOverlay(true);

            if (window.firebaseReadyPromise) {
                try {
                    await Promise.race([
                        window.firebaseReadyPromise,
                        new Promise(resolve => setTimeout(resolve, 5000))
                    ]);
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                }
            }

            if (canUseDirectFirebase()) {
                try {
                    const data = await fetchInitialDataDirect();
                    firebaseDataLoaded = true;
                    applyInitialData(data || {});
                } catch (error) {
                    console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á:', error);
                    applyInitialData({});
                }
            } else {
                applyInitialData({});
            }

            dataInitialized = true;
            renderAllViews();
            showView('dashboard');
            toggleLoadingOverlay(false);

            if (!firebaseDataLoaded && window.firebaseReadyPromise) {
                window.firebaseReadyPromise
                    .then(() => {
                        if (!firebaseDataLoaded && canUseDirectFirebase()) {
                            fetchInitialDataDirect()
                                .then(data => {
                                    firebaseDataLoaded = true;
                                    applyInitialData(data || {});
                                    renderAllViews();
                                })
                                .catch(error => console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase ‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:', error));
                        }
                    })
                    .catch(() => {});
            }
        }

        function applyInitialData(data) {
            let shouldSeedDefaults = false;

            if (Array.isArray(data.teachers) && data.teachers.length > 0) {
                teachers = data.teachers;
            } else {
                teachers = createDefaultTeachers();
                shouldSeedDefaults = true;
            }

            ensureAllTeacherStats();
            selectedTeacherId = null;

            if (Array.isArray(data.events) && data.events.length > 0) {
                events = data.events;
            } else {
                events = createDefaultEvents();
                shouldSeedDefaults = true;
            }

            events = (Array.isArray(events) ? events : []).map(event => {
                ensureEventAssignments(event);
                return event;
            });

            if (Array.isArray(data.trainingEvents) && data.trainingEvents.length > 0) {
                trainingEvents = data.trainingEvents;
            } else {
                trainingEvents = createDefaultTrainingEvents();
                shouldSeedDefaults = true;
            }

            trainingEvents = (Array.isArray(trainingEvents) ? trainingEvents : []).map(event => {
                ensureEventAssignments(event);
                return event;
            });

            ensureAllTeacherStats();
            recomputeTeacherStats();

            activityLog = Array.isArray(data.activityLog) ? data.activityLog : [];
            systemConfig = { ...defaultConfig, ...(data.config || {}) };
            updateSystemLabels();

            if (window.elementSdk && window.elementSdk.config) {
                window.elementSdk.config = { ...systemConfig };
                if (window.elementSdk.element && typeof window.elementSdk.element.onConfigChange === 'function') {
                    window.elementSdk.element.onConfigChange(window.elementSdk.config);
                }
            }

            if (shouldSeedDefaults) {
                const seedResult = persistAllData();
                if (seedResult && typeof seedResult.then === 'function') {
                    seedResult.catch(error => console.error('‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error));
                }
            }
        }

        function addActivityLog(type, description, details = '') {
            const log = {
                id: Date.now(),
                type: type,
                description: description,
                details: details,
                timestamp: new Date().toISOString(),
                admin: 'Admin'
            };
            activityLog.unshift(log);
            saveData();
        }

        // Teacher photos mapping
        const teacherPhotos = {
            '‡∏†‡∏≤‡∏ì‡∏∏‡∏ß‡∏±‡∏í‡∏ô‡πå': 'https://img5.pic.in.th/file/secure-sv1/5e6f1794bb827bebc2e65ada722df90a.jpg',
            '‡∏ô‡∏±‡∏ä‡∏ô‡∏±‡∏ô‡∏ó‡πå': 'https://img5.pic.in.th/file/secure-sv1/1af9893f65630d5e1ba39c3784d1cde0.png',
            '‡∏ô‡∏±‡∏ô‡∏ó‡∏ô‡∏≤': 'https://img5.pic.in.th/file/secure-sv1/34093e3c53533ba2d0f4e017dc519b19.png',
            '‡∏Å‡∏§‡∏©‡∏ì‡∏µ‡∏ô‡∏≤‡∏ó': 'https://img2.pic.in.th/pic/4427e7666f2d9b21acd3d055da5e3cc1.png',
            '‡∏û‡∏£‡∏£‡∏ß‡∏¥‡∏ô‡∏ó‡πå': 'https://img2.pic.in.th/pic/41dcc8930f131834415adc9b313b8c32.png',
            '‡∏Ç‡∏ß‡∏±‡∏ç‡∏ô‡∏≤‡∏Ñ': 'https://img2.pic.in.th/pic/6c7baf1df19706aaee0d4326aad10e02.png',
            '‡∏≠‡∏£‡∏ß‡∏£‡∏£‡∏ì': 'https://img5.pic.in.th/file/secure-sv1/ba991bebe77c479877912bb4c8c41120.png',
            '‡∏≠‡∏±‡∏á‡∏Ñ‡∏ì‡∏≤': 'https://img2.pic.in.th/pic/10653004a11f24a845d64c4f0ad4ff2a.png',
            '‡∏™‡∏∏‡∏ó‡∏±‡∏®‡∏©‡∏≤': 'https://img5.pic.in.th/file/secure-sv1/f2c5119a8b036412489618b7cf3b9f70.png',
            '‡∏™‡∏≠‡∏≤‡∏î‡∏ß‡∏£‡∏£‡∏ì': 'https://img2.pic.in.th/pic/289ed6001a81b79e8d4ab6378fd7f1a6.png',
            '‡∏ß‡∏¥‡∏ô‡∏±‡∏¢': 'https://img5.pic.in.th/file/secure-sv1/b50541ebf13b24546c51e4b928a641b1.png',
            '‡∏ß‡∏¥‡∏•‡∏≤‡∏ß‡∏£‡∏£‡∏ì': 'https://img2.pic.in.th/pic/780e5fa00b1a4787c0eb2a3d56e08f8c.png',
            '‡πÄ‡∏û‡πá‡∏ç‡∏û‡∏£‡∏£‡∏ì‡∏µ': 'https://img5.pic.in.th/file/secure-sv1/f3f6d80d0a4047e1d97b05fe6a78c0f1.png'
        };

        function getTeacherPhoto(name) {
            return teacherPhotos[name] || null;
        }

        function createTeacherAvatar(teacher, large = false) {
            const photo = teacher ? getTeacherPhoto(teacher.name) : null;
            const avatarClass = large ? 'teacher-avatar-large' : 'teacher-avatar';
            if (photo) {
                return `<div class="${avatarClass}">
                    <img src="${photo}" alt="${teacher.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='${teacher.name.charAt(0)}';">
                </div>`;
            }

            if (teacher && teacher.name) {
                return `<div class="${avatarClass}">${teacher.name.charAt(0)}</div>`;
            }

            return `<div class="${avatarClass}">?</div>`;
        }

        function formatDateThai(dateStr) {
            if (!dateStr) {
                return '-';
            }

            const date = new Date(dateStr);
            if (Number.isNaN(date.getTime())) {
                return '-';
            }

            const buddhistYear = date.getFullYear() + 543;
            const months = [
                '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
            ];
            return `${date.getDate()} ${months[date.getMonth()]} ${buddhistYear}`;
        }

        function formatDateTimeThai(value) {
            if (!value) {
                return '-';
            }

            const date = value instanceof Date ? value : new Date(value);
            if (Number.isNaN(date.getTime())) {
                return '-';
            }

            return date.toLocaleString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getTeacherById(id) {
            return teachers.find(t => t.teacherId === id);
        }

        function getEventById(id, queueType = QUEUE_TYPES.DUTY) {
            const collection = getQueueEvents(queueType);
            let found = collection.find(e => e.eventId === id);
            if (!found && queueType === QUEUE_TYPES.DUTY) {
                // Fallback: search training events if queue type not specified
                found = trainingEvents.find(e => e.eventId === id) || null;
            }
            return found || null;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏≤‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ (‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
        function getNextQueueTeachers(limit = 13) {
            return [...teachers]
                .map(teacher => {
                    ensureTeacherStats(teacher);
                    return teacher;
                })
                .sort((a, b) => {
                    if (a.queueScore !== b.queueScore) {
                        return a.queueScore - b.queueScore;
                    }

                    const dateA = a.lastEventDate ? new Date(a.lastEventDate) : new Date(0);
                    const dateB = b.lastEventDate ? new Date(b.lastEventDate) : new Date(0);
                    return dateA - dateB;
                })
                .slice(0, limit);
        }

        // Navigation
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            
            // Show selected view
            document.getElementById(`${viewName}-view`).classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
            
            // Refresh view data
            switch(viewName) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'events':
                    renderEventsTable();
                    break;
                case 'training':
                    renderTrainingView();
                    break;
                case 'teachers':
                    renderTeachersTable();
                    break;
                case 'history':
                    renderHistory();
                    break;
            }
        }

        // Dashboard rendering
        function renderDashboard() {
            const totalEvents = events.length;
            const assignedEvents = events.filter(e => e.status === 'assigned').length;
            const pendingEvents = events.filter(e => e.status === 'pending').length;
            const totalTeachers = teachers.length;

            document.getElementById('total-events').textContent = totalEvents;
            document.getElementById('assigned-events').textContent = assignedEvents;
            document.getElementById('pending-events').textContent = pendingEvents;
            document.getElementById('total-teachers').textContent = totalTeachers;

            // Render latest event (most recent assigned event)
            const latestEvent = events
                .filter(e => e.status === 'assigned')
                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

            const latestEventHtml = latestEvent ? `
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <h4 class="font-medium text-gray-800 mb-2">${latestEvent.eventName}</h4>
                    <p class="text-sm text-gray-600 mb-3">${formatDateThai(latestEvent.date)} ‚Ä¢ ${latestEvent.time}</p>
                    <p class="text-sm text-gray-600 mb-3">üìç ${latestEvent.location}</p>
                    
                    <div class="mb-3">
                        <p class="text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô:</p>
                        <div class="grid grid-cols-2 gap-2">
                            ${latestEvent.assignedTeachers.map(id => {
                                const teacher = getTeacherById(id);
                                return `
                                    <div class="flex items-center bg-white p-2 rounded border">
                                        ${createTeacherAvatar(teacher)}
                                        <span class="ml-2 text-sm font-medium">${teacher.name}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            ` : '<p class="text-gray-500 text-center py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß</p>';

            document.getElementById('latest-event').innerHTML = latestEventHtml;

            // Render next queue (all teachers sorted by queue score, displayed horizontally)
            const nextQueueTeachers = getNextQueueTeachers(13)
                .map((teacher, index) => ({ ...teacher, queueRank: index + 1 }));

            const nextQueueHtml = nextQueueTeachers.length > 0 ? nextQueueTeachers.map((teacher, index) => {
                const rankIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üéØ';

                return `
                    <div class="next-queue-card">
                        <div class="w-full flex items-center justify-between text-[11px] text-gray-500 font-semibold">
                            <span class="rank-badge">${rankIcon} #${teacher.queueRank}</span>
                            <span class="text-sm font-bold text-[#5b2d38]">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${teacher.queueScore}</span>
                        </div>
                        ${createTeacherAvatar(teacher, true)}
                        <div class="text-center space-y-1 w-full">
                            <h4 class="font-semibold text-sm text-gray-900 leading-tight">${teacher.name}</h4>
                            <p class="text-[11px] text-gray-500 leading-tight">${teacher.position}</p>
                            ${teacher.lastEventDate ? `<p class="text-[10px] text-gray-400 leading-tight">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${formatDateThai(teacher.lastEventDate)}</p>` : ''}
                        </div>
                        <div class="w-full space-y-1">
                            <div class="queue-mini-stat is-duty"><span>‡∏á‡∏≤‡∏ô</span><span class="font-semibold text-gray-700">${teacher.dutyDuties ?? 0}</span></div>
                            <div class="queue-mini-stat is-duty"><span>‡∏≠‡∏ö‡∏£‡∏°</span><span class="font-semibold text-gray-700">${teacher.trainingDuties ?? 0}</span></div>
                            <div class="queue-mini-stat is-sub"><span>‡πÅ‡∏ó‡∏ô‡∏£‡∏ß‡∏°</span><span class="font-semibold text-gray-700">${teacher.swapCount || 0}</span></div>
                        </div>
                    </div>
                `;
            }).join('') : '<p class="text-gray-500 text-center py-6">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π</p>';

            document.getElementById('next-queue').innerHTML = `
                <div class="next-queue-grid">
                    ${nextQueueHtml}
                </div>
            `;

            // Render urgent events (pending events sorted by date)
            const urgentEvents = events
                .filter(e => e.status === 'pending')
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(0, 5);

            const urgentEventsHtml = urgentEvents.length > 0 ? urgentEvents.map(event => `
                <div class="flex justify-between items-center p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div class="flex-1">
                        <p class="font-medium text-gray-800">${event.eventName}</p>
                        <p class="text-sm text-gray-600">${formatDateThai(event.date)} ‚Ä¢ ${event.time}</p>
                        ${event.assignedTeachers.length > 0 ? `
                            <div class="flex items-center mt-2">
                                <span class="text-xs text-gray-500 mr-2">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢:</span>
                                <div class="flex -space-x-1">
                                    ${event.assignedTeachers.slice(0, 3).map(id => {
                                        const teacher = getTeacherById(id);
                                        return createTeacherAvatar(teacher);
                                    }).join('')}
                                    ${event.assignedTeachers.length > 3 ? `<div class="teacher-avatar bg-gray-400">+${event.assignedTeachers.length - 3}</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <button onclick="openAutoAssignModal(${event.eventId}, '${QUEUE_TYPES.DUTY}')" class="btn-primary text-sm">
                        ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß
                    </button>
                </div>
            `).join('') : '<p class="text-gray-500 text-center py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</p>';

            document.getElementById('urgent-events').innerHTML = urgentEventsHtml;

            // Render top priority teachers (lowest score first)
            const topTeachers = [...teachers]
                .sort((a, b) => a.queueScore - b.queueScore)
                .slice(0, 5);

            const topTeachersHtml = topTeachers.map(teacher => `
                <div class="flex justify-between items-center p-3 rounded-lg" style="background: rgba(137, 77, 91, 0.08); border: 1px solid rgba(137, 77, 91, 0.2);">
                    <div class="flex items-center">
                        ${createTeacherAvatar(teacher)}
                        <div class="ml-3">
                            <p class="font-medium text-gray-800">${teacher.name}</p>
                            <p class="text-sm text-gray-600">${teacher.position}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="queue-score">${teacher.queueScore}</div>
                        <p class="text-xs text-gray-600 mt-1">‡∏á‡∏≤‡∏ô ${teacher.dutyDuties ?? 0} | ‡∏≠‡∏ö‡∏£‡∏° ${teacher.trainingDuties ?? 0}</p>
                    </div>
                </div>
            `).join('');

            document.getElementById('top-queue-teachers').innerHTML = topTeachersHtml;
        }

        function renderQueueCards(queueType, containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                return;
            }

            const queueEvents = [...getQueueEvents(queueType)].sort((a, b) => new Date(b.date) - new Date(a.date));
            if (queueEvents.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-6">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>';
                return;
            }

            const queueLabel = getQueueDisplayName(queueType);

            const cardsHtml = queueEvents.map(event => {
                const statusClass = event.status === 'assigned' ? 'status-assigned'
                    : event.status === 'completed' ? 'status-completed'
                    : 'status-pending';
                const statusText = event.status === 'assigned' ? '‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß'
                    : event.status === 'completed' ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'
                    : '‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß';
                const statusIcon = event.status === 'assigned' ? '‚úÖ'
                    : event.status === 'completed' ? 'üéâ'
                    : '‚è≥';

                const assignmentSlots = getEventAssignmentSlots(event);
                const currentAssignments = assignmentSlots.filter(slot => slot.currentTeacherId !== null && slot.currentTeacherId !== undefined);
                const assignedCount = currentAssignments.length;

                const queueBadge = queueType === QUEUE_TYPES.TRAINING
                    ? '<span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-[#E1B1C1] text-[#5b2d38] mb-2">‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏ö‡∏£‡∏°</span>'
                    : '<span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-[#C4E9F8] text-[#245f7a] mb-2">‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</span>';

                const assignmentSlots = getEventAssignmentSlots(event);
                const currentAssignments = assignmentSlots.filter(slot => slot.currentTeacherId !== null && slot.currentTeacherId !== undefined);
                const assignedCount = currentAssignments.length;

                return `
                    <div class="card p-6 hover:shadow-lg transition-all duration-300">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                ${queueBadge}
                                <h3 class="font-semibold text-gray-800 text-lg mb-2">${event.eventName}</h3>
                                <div class="space-y-1 text-sm text-gray-600">
                                    <p class="flex items-center">
                                        <span class="mr-2">üìÖ</span>${formatDateThai(event.date)}
                                    </p>
                                    <p class="flex items-center">
                                        <span class="mr-2">‚è∞</span>${event.time}
                                    </p>
                                    <p class="flex items-center">
                                        <span class="mr-2">üìç</span>${event.location}
                                    </p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="status-badge ${statusClass} flex items-center">
                                    <span class="mr-1">${statusIcon}</span>${statusText}
                                </span>
                                <p class="text-sm text-gray-500 mt-2">${assignedCount}/${event.requiredQuota} ‡∏Ñ‡∏ô</p>
                            </div>
                        </div>

                        ${currentAssignments.length > 0 ? `
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-700 mb-3">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢:</p>
                                <div class="flex flex-wrap gap-2">
                                    ${currentAssignments.map(slot => {
                                        const currentTeacher = getTeacherById(slot.currentTeacherId);
                                        const originalTeacher = slot.originalTeacherId ? getTeacherById(slot.originalTeacherId) : null;
                                        const isSubstituted = slot.originalTeacherId && slot.currentTeacherId && slot.originalTeacherId !== slot.currentTeacherId;
                                        const currentName = currentTeacher ? currentTeacher.name : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                                        const originalName = originalTeacher ? originalTeacher.name : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
                                        return `
                                            <div class="flex items-center bg-gray-50 p-2 rounded-lg border ${isSubstituted ? 'border-[#E1B1C1]' : 'border-transparent'}">
                                                ${createTeacherAvatar(currentTeacher)}
                                                <div class="ml-2">
                                                    <p class="font-medium text-gray-800 text-sm">${currentName}</p>
                                                    ${isSubstituted
                                                        ? `<p class="text-xs text-[#894D5B] font-medium">‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á ${originalName}</p>`
                                                        : `<p class="text-xs text-gray-500">‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏î‡∏¥‡∏°</p>`}
                                                    <div class="queue-score text-xs mt-1">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏ß ${currentTeacher && typeof currentTeacher.queueScore === 'number' ? currentTeacher.queueScore : '-'}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <p class="text-sm text-yellow-700 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß</p>
                            </div>
                        `}

                        <div class="flex space-x-2">
                            <button onclick="editEvent(${event.eventId}, '${queueType}')" class="btn-primary text-sm flex-1">
                                <span class="mr-1">‚úèÔ∏è</span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            ${event.status === 'pending'
                                ? `<button onclick="openAutoAssignModal(${event.eventId}, '${queueType}')" class="btn-success text-sm flex-1">
                                    <span class="mr-1">üéØ</span>‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß
                                </button>`
                                : `<button onclick="openSubstitutionModal(${event.eventId}, '${queueType}')" class="btn-danger text-sm flex-1">
                                    <span class="mr-1">üîÑ</span>‡πÅ‡∏ó‡∏ô
                                </button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = cardsHtml;
        }

        function renderEventsTable() {
            renderQueueCards(QUEUE_TYPES.DUTY, 'events-cards');
        }

        function renderTrainingView() {
            const trainings = getQueueEvents(QUEUE_TYPES.TRAINING);
            const totalTrainingsEl = document.getElementById('total-training-events');
            const assignedTrainingsEl = document.getElementById('assigned-training-events');
            const pendingTrainingsEl = document.getElementById('pending-training-events');
            const upcomingContainer = document.getElementById('upcoming-training-events');
            const recentContainer = document.getElementById('recent-training-teachers');

            if (totalTrainingsEl) {
                totalTrainingsEl.textContent = trainings.length;
            }
            if (assignedTrainingsEl) {
                assignedTrainingsEl.textContent = trainings.filter(event => event.status === 'assigned').length;
            }
            if (pendingTrainingsEl) {
                pendingTrainingsEl.textContent = trainings.filter(event => event.status === 'pending').length;
            }

            if (upcomingContainer) {
                const upcoming = trainings
                    .filter(event => event.status !== 'completed')
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .slice(0, 5);

                upcomingContainer.innerHTML = upcoming.length > 0
                    ? upcoming.map(event => {
                        const slots = getEventAssignmentSlots(event);
                        const assignedCount = slots.filter(slot => slot.currentTeacherId !== null && slot.currentTeacherId !== undefined).length;
                        const callToAction = event.status === 'pending'
                            ? `<button onclick="openAutoAssignModal(${event.eventId}, '${QUEUE_TYPES.TRAINING}')" class="btn-primary text-sm">‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß</button>`
                            : `<button onclick="openSubstitutionModal(${event.eventId}, '${QUEUE_TYPES.TRAINING}')" class="btn-danger text-sm">‡πÅ‡∏ó‡∏ô</button>`;

                        return `
                            <div class="flex justify-between items-center p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">${event.eventName}</p>
                                    <p class="text-sm text-gray-600">${formatDateThai(event.date)} ‚Ä¢ ${event.time}</p>
                                    <p class="text-sm text-gray-600">üìç ${event.location}</p>
                                    <p class="text-xs text-gray-500 mt-1">‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß ${assignedCount}/${event.requiredQuota} ‡∏Ñ‡∏ô</p>
                                </div>
                                ${callToAction}
                            </div>
                        `;
                    }).join('')
                    : '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß</p>';
            }

            if (recentContainer) {
                const seen = new Set();
                const recentAssignments = [];

                [...trainings]
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .forEach(event => {
                        getEventAssignmentSlots(event).forEach(slot => {
                            const teacher = slot.currentTeacherId ? getTeacherById(slot.currentTeacherId) : null;
                            if (!teacher || seen.has(teacher.teacherId)) {
                                return;
                            }
                            seen.add(teacher.teacherId);
                            ensureTeacherStats(teacher);
                            recentAssignments.push({ event, teacher });
                        });
                    });

                recentContainer.innerHTML = recentAssignments.length > 0
                    ? recentAssignments.slice(0, 5).map(({ event, teacher }) => {
                        const lastTrainingDate = teacher.lastTrainingDate ? formatDateThai(teacher.lastTrainingDate) : formatDateThai(event.date);
                        return `
                            <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg">
                                <div class="flex items-center">
                                    ${createTeacherAvatar(teacher)}
                                    <div class="ml-3">
                                        <p class="font-medium text-gray-800">${teacher.name}</p>
                                        <p class="text-xs text-gray-500">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏ß ${teacher.queueScore}</p>
                                        <p class="text-xs text-gray-500">‡∏≠‡∏ö‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${lastTrainingDate}</p>
                                    </div>
                                </div>
                                <span class="text-xs text-gray-500 text-right">${event.eventName}</span>
                            </div>
                        `;
                    }).join('')
                    : '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>';
            }

            renderQueueCards(QUEUE_TYPES.TRAINING, 'training-events-cards');
        }

        function showTrainingQueueGuide() {
            alert('‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏¢‡πà‡∏≠:\n‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏ö‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà\n‚Ä¢ ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‚Äù ‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏ô‡∏≠‡∏Ñ‡∏£‡∏π‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡πÄ‡∏ä‡πà‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥\n‚Ä¢ ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡πÅ‡∏ó‡∏ô‚Äù ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏£‡∏π‡∏≠‡∏ö‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
        }

        // Teachers table rendering
        function renderTeachersTable() {
            const tbody = document.getElementById('teachers-table-body');
            if (!tbody) {
                return;
            }

            const sortedTeachers = [...teachers]
                .map(teacher => {
                    ensureTeacherStats(teacher);
                    return teacher;
                })
                .sort((a, b) => {
                    if (a.queueScore !== b.queueScore) {
                        return a.queueScore - b.queueScore;
                    }
                    const dateA = a.lastEventDate ? new Date(a.lastEventDate) : new Date(0);
                    const dateB = b.lastEventDate ? new Date(b.lastEventDate) : new Date(0);
                    return dateA - dateB;
                })
                .map((teacher, index) => ({ ...teacher, queueRank: index + 1 }));

            if (sortedTeachers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-6 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π</td></tr>';
                renderTeacherDetail(null);
                return;
            }

            if (!selectedTeacherId || !sortedTeachers.some(t => t.teacherId === selectedTeacherId)) {
                selectedTeacherId = sortedTeachers[0].teacherId;
            }

            tbody.innerHTML = sortedTeachers.map(teacher => {
                const isActive = teacher.teacherId === selectedTeacherId;
                return `
                    <tr class="${isActive ? 'is-active' : ''}" onclick="showTeacherDetail(${teacher.teacherId})">
                        <td class="font-medium text-gray-700">${teacher.queueRank}</td>
                        <td>
                            <div class="flex items-center space-x-3">
                                ${createTeacherAvatar(teacher)}
                                <div>
                                    <p class="font-semibold text-gray-800">${teacher.name}</p>
                                    ${teacher.lastEventDate ? `<p class="text-xs text-gray-500">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ${formatDateThai(teacher.lastEventDate)}</p>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="text-sm text-gray-600">${teacher.position}</td>
                        <td class="font-semibold text-[#5b2d38]">${teacher.queueScore}</td>
                        <td class="text-center">${teacher.dutyDuties ?? 0}</td>
                        <td class="text-center">${teacher.trainingDuties ?? 0}</td>
                        <td class="text-center">${teacher.swapCount ?? 0}</td>
                    </tr>
                `;
            }).join('');

            const activeTeacher = sortedTeachers.find(t => t.teacherId === selectedTeacherId) || sortedTeachers[0];
            renderTeacherDetail(activeTeacher);
        }

        function showTeacherDetail(teacherId) {
            selectedTeacherId = teacherId;
            renderTeachersTable();
        }

        function renderTeacherDetail(teacher) {
            const panel = document.getElementById('teacher-detail-panel');
            if (!panel) {
                return;
            }

            if (!teacher) {
                panel.innerHTML = '<p class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á</p>';
                return;
            }

            ensureTeacherStats(teacher);
            const relatedEvents = events
                .filter(event => Array.isArray(event.assignedTeachers) && event.assignedTeachers.includes(teacher.teacherId))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const relatedTrainingEvents = trainingEvents
                .filter(event => Array.isArray(event.assignedTeachers) && event.assignedTeachers.includes(teacher.teacherId))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const highlightEvents = relatedEvents.slice(0, 3).map(event => {
                const statusLabel = event.status === 'assigned' ? '‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß' : event.status === 'completed' ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : '‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß';
                return `
                    <li class="p-3 rounded-lg border border-gray-200 bg-gray-50">
                        <p class="font-medium text-gray-800">${event.eventName}</p>
                        <p class="text-xs text-gray-500">${formatDateThai(event.date)} ‚Ä¢ ${event.time}</p>
                        <p class="text-xs text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${event.location}</p>
                        <span class="inline-block mt-2 text-xs font-semibold px-2 py-1 rounded-full" style="background: rgba(137, 77, 91, 0.12); color: #5b2d38;">${statusLabel}</span>
                    </li>
                `;
            }).join('');

            const highlightTraining = relatedTrainingEvents.slice(0, 3).map(event => {
                const statusLabel = event.status === 'assigned' ? '‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß' : event.status === 'completed' ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : '‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß';
                return `
                    <li class="p-3 rounded-lg border border-blue-200 bg-blue-50">
                        <p class="font-medium text-gray-800">${event.eventName}</p>
                        <p class="text-xs text-gray-500">${formatDateThai(event.date)} ‚Ä¢ ${event.time}</p>
                        <p class="text-xs text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${event.location}</p>
                        <span class="inline-block mt-2 text-xs font-semibold px-2 py-1 rounded-full" style="background: rgba(196, 233, 248, 0.6); color: #245f7a;">${statusLabel}</span>
                    </li>
                `;
            }).join('');

            panel.innerHTML = `
                <div class="flex items-center gap-4">
                    ${createTeacherAvatar(teacher, true)}
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">${teacher.name}</h3>
                        <p class="text-sm text-gray-600">${teacher.position}</p>
                        <div class="mt-2">
                            <span class="queue-score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏ß ${teacher.queueScore}</span>
                        </div>
                    </div>
                </div>
                <div class="teacher-detail-card mt-4">
                    <div class="detail-row"><span>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span><span>${teacher.queueRank ?? '-'}</span></div>
                    <div class="detail-row"><span>‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span><span>${teacher.dutyDuties ?? 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                    <div class="detail-row"><span>‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span><span>${teacher.trainingDuties ?? 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                    <div class="detail-row"><span>‡πÅ‡∏ó‡∏ô‡∏á‡∏≤‡∏ô</span><span>${teacher.dutySwapCount ?? 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                    <div class="detail-row"><span>‡πÅ‡∏ó‡∏ô‡∏≠‡∏ö‡∏£‡∏°</span><span>${teacher.trainingSwapCount ?? 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                    <div class="detail-row"><span>‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô</span><span>${teacher.swapCount ?? 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span></div>
                    <div class="detail-row"><span>‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span><span>${teacher.lastDutyDate ? formatDateThai(teacher.lastDutyDate) : '-'}</span></div>
                    <div class="detail-row"><span>‡∏≠‡∏ö‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span><span>${teacher.lastTrainingDate ? formatDateThai(teacher.lastTrainingDate) : '-'}</span></div>
                </div>
                <div class="mt-4">
                    <h4 class="font-semibold text-gray-800">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
                    ${relatedEvents.length > 0 ? `<ul class="mt-2 space-y-2">${highlightEvents}</ul>` : '<p class="text-sm text-gray-500 mt-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</p>'}
                </div>
                <div class="mt-4">
                    <h4 class="font-semibold text-gray-800">‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
                    ${relatedTrainingEvents.length > 0 ? `<ul class="mt-2 space-y-2">${highlightTraining}</ul>` : '<p class="text-sm text-gray-500 mt-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</p>'}
                </div>
                <div class="flex gap-3 mt-6">
                    <button class="btn-primary flex-1" onclick="editTeacher(${teacher.teacherId})">
                        <span class="mr-1">‚úèÔ∏è</span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button class="btn-success flex-1" onclick="adjustQueueScore(${teacher.teacherId})">
                        <span class="mr-1">‚öñÔ∏è</span>‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏ß
                    </button>
                </div>
            `;
        }

        // History rendering
        function renderHistory() {
            // Duty distribution
            const sortedTeachers = [...teachers].map(ensureTeacherStats).sort((a, b) => (a.totalDuties || 0) - (b.totalDuties || 0));
            const dutyDistributionHtml = sortedTeachers.map(teacher => `
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <div class="flex items-center">
                        ${createTeacherAvatar(teacher)}
                        <span class="font-medium ml-3">${teacher.name}</span>
                    </div>
                    <span class="text-gray-600">${teacher.dutyDuties ?? 0} ‡∏á‡∏≤‡∏ô | ${teacher.trainingDuties ?? 0} ‡∏≠‡∏ö‡∏£‡∏°</span>
                </div>
            `).join('');
            document.getElementById('duty-distribution').innerHTML = dutyDistributionHtml;

            // Substitution stats
            const substitutionStats = teachers.map(ensureTeacherStats).filter(t => (t.swapCount || 0) > 0);
            const substitutionStatsHtml = substitutionStats.length > 0 ? substitutionStats.map(teacher => `
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <div class="flex items-center">
                        ${createTeacherAvatar(teacher)}
                        <span class="font-medium ml-3">${teacher.name}</span>
                    </div>
                    <span class="font-semibold" style="color: var(--secondary-bg);">${teacher.swapCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏á‡∏≤‡∏ô ${teacher.dutySwapCount ?? 0} | ‡∏≠‡∏ö‡∏£‡∏° ${teacher.trainingSwapCount ?? 0})</span>
                </div>
            `).join('') : '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô</p>';
            document.getElementById('substitution-stats').innerHTML = substitutionStatsHtml;

            // Activity log
            const activityLogHtml = activityLog.length > 0 ? activityLog.map(log => {
                const logClass = log.type === 'auto-assign' ? 'auto-assign' :
                               log.type === 'manual-edit' ? 'manual-edit' : 'substitution';
                const date = formatDateTimeThai(log.timestamp);
                
                return `
                    <div class="log-entry ${logClass}">
                        <div class="flex justify-between items-start mb-1">
                            <p class="font-medium text-gray-800">${log.description}</p>
                            <span class="text-xs text-gray-500">${date}</span>
                        </div>
                        ${log.details ? `<p class="text-sm text-gray-600">${log.details}</p>` : ''}
                        <p class="text-xs text-gray-500 mt-1">‡πÇ‡∏î‡∏¢: ${log.admin}</p>
                    </div>
                `;
            }).join('') : '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>';
            document.getElementById('activity-log').innerHTML = activityLogHtml;
        }

        // Modal functions
        function renderEventAssignmentSummary(event) {
            const summary = document.getElementById('event-assignment-summary');
            const list = document.getElementById('event-assignment-list');

            if (!summary || !list) {
                return;
            }

            if (!event) {
                summary.classList.add('hidden');
                list.innerHTML = '';
                return;
            }

            const slots = getEventAssignmentSlots(event);
            summary.classList.remove('hidden');

            if (!slots.length) {
                list.innerHTML = '<p class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</p>';
                return;
            }

            list.innerHTML = slots.map((slot, index) => {
                const originalTeacher = slot.originalTeacherId ? getTeacherById(slot.originalTeacherId) : null;
                const currentTeacher = slot.currentTeacherId ? getTeacherById(slot.currentTeacherId) : null;
                const isSubstituted = slot.originalTeacherId && slot.currentTeacherId && slot.originalTeacherId !== slot.currentTeacherId;

                const originalName = originalTeacher ? originalTeacher.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const currentName = currentTeacher ? currentTeacher.name : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                const currentScore = currentTeacher && typeof currentTeacher.queueScore === 'number' ? currentTeacher.queueScore : '-';

                return `
                    <div class="p-3 rounded-lg border ${isSubstituted ? 'border-[#E1B1C1] bg-[#fdf6f8]' : 'border-gray-200 bg-white'}">
                        <div class="flex items-center justify-between gap-3">
                            <div class="flex items-center space-x-3">
                                ${createTeacherAvatar(originalTeacher)}
                                <div>
                                    <p class="text-xs text-gray-500 uppercase tracking-wide">‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà ${index + 1}</p>
                                    <p class="text-sm font-medium text-gray-800">${originalName}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                ${createTeacherAvatar(currentTeacher)}
                                <div class="text-right">
                                    <p class="text-xs text-gray-500 uppercase tracking-wide">‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏à‡∏£‡∏¥‡∏á</p>
                                    <p class="text-sm font-semibold ${isSubstituted ? 'text-[#894D5B]' : 'text-gray-800'}">${currentName}</p>
                                    <p class="text-xs text-gray-500">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏ß ${currentScore}</p>
                                </div>
                            </div>
                        </div>
                        ${isSubstituted
                            ? `<p class="text-xs text-[#894D5B] mt-2">‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á ${originalName}</p>`
                            : '<p class="text-xs text-gray-500 mt-2">‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏î‡∏¥‡∏°</p>'}
                    </div>
                `;
            }).join('');
        }

        function openEventModal(eventId = null, queueType = QUEUE_TYPES.DUTY) {
            currentEventId = eventId;
            currentEventQueueType = queueType || QUEUE_TYPES.DUTY;

            const modal = document.getElementById('event-modal');
            const title = document.getElementById('event-modal-title');
            const form = document.getElementById('event-form');
            const queueLabel = getQueueDisplayName(currentEventQueueType);

            if (eventId) {
                const event = getEventById(eventId, currentEventQueueType);
                if (!event) {
                    console.error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß', currentEventQueueType, '‡∏£‡∏´‡∏±‡∏™', eventId);
                    return;
                }
                title.textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç${queueLabel}`;
                document.getElementById('event-name').value = event.eventName || '';
                document.getElementById('event-details').value = event.details || '';
                document.getElementById('event-date').value = event.date || '';
                document.getElementById('event-start-time').value = event.startTime || '';
                document.getElementById('event-end-time').value = event.endTime || '';
                document.getElementById('event-location').value = event.location || '';
                document.getElementById('event-quota').value = event.requiredQuota || 0;
                const latInput = document.getElementById('event-location-lat');
                const lngInput = document.getElementById('event-location-lng');
                if (latInput) latInput.value = event.locationLat ?? '';
                if (lngInput) lngInput.value = event.locationLng ?? '';
                renderEventAssignmentSummary(event);
            } else {
                title.textContent = `‡πÄ‡∏û‡∏¥‡πà‡∏°${queueLabel}‡πÉ‡∏´‡∏°‡πà`;
                form.reset();
                const latInput = document.getElementById('event-location-lat');
                const lngInput = document.getElementById('event-location-lng');
                if (latInput) latInput.value = '';
                if (lngInput) lngInput.value = '';
                renderEventAssignmentSummary(null);
            }

            modal.classList.add('show');

            setTimeout(() => prepareLocationPicker(targetEvent), 120);
        }

        function closeEventModal() {
            document.getElementById('event-modal').classList.remove('show');
            currentEventId = null;
            renderEventAssignmentSummary(null);
        }

        function openTeacherModal(teacherId = null) {
            currentTeacherId = teacherId;
            const modal = document.getElementById('teacher-modal');
            const title = document.getElementById('teacher-modal-title');
            const form = document.getElementById('teacher-form');

            if (teacherId) {
                const teacher = getTeacherById(teacherId);
                title.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π';
                document.getElementById('teacher-name').value = teacher.name;
                document.getElementById('teacher-position').value = teacher.position;
                document.getElementById('teacher-queue-score').value = teacher.queueScore;
            } else {
                title.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡∏°‡πà';
                form.reset();
                document.getElementById('teacher-queue-score').value = 100;
            }

            modal.classList.add('show');
        }

        function closeTeacherModal() {
            document.getElementById('teacher-modal').classList.remove('show');
            currentTeacherId = null;
        }

        function openAutoAssignModal(eventId, queueType = QUEUE_TYPES.DUTY) {
            currentEventQueueType = queueType || QUEUE_TYPES.DUTY;
            const event = getEventById(eventId, currentEventQueueType);
            if (!event || event.status !== 'pending') return;

            // Get teachers sorted by queue score (lowest first)
            const sortedTeachers = [...teachers].sort((a, b) => a.queueScore - b.queueScore);
            const suggestedTeachers = sortedTeachers.slice(0, event.requiredQuota);

            const content = document.getElementById('auto-assign-content');
            content.innerHTML = `
                <div class="mb-4">
                    <h4 class="font-semibold text-gray-800 mb-2">${getQueueDisplayName(currentEventQueueType)}: ${event.eventName}</h4>
                    <p class="text-sm text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDateThai(event.date)} ‡πÄ‡∏ß‡∏•‡∏≤: ${event.time}</p>
                    <p class="text-sm text-gray-600">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏π: ${event.requiredQuota} ‡∏Ñ‡∏ô</p>
                </div>
                
                <div class="mb-6">
                    <h5 class="font-medium text-gray-800 mb-3">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å):</h5>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 max-h-80 overflow-y-auto">
                        ${sortedTeachers.map((teacher, index) => {
                            const isSelected = index < event.requiredQuota;
                            const isRecommended = index < event.requiredQuota;
                            return `
                                <div class="teacher-select-card p-3 border-2 rounded-lg cursor-pointer transition-all duration-200 ${isSelected ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white hover:border-blue-300'}" 
                                     data-teacher-id="${teacher.teacherId}" 
                                     onclick="toggleTeacherSelection(${teacher.teacherId}, ${event.requiredQuota})">
                                            <div class="flex flex-col items-center text-center">
                                                ${createTeacherAvatar(teacher)}
                                                <div class="mt-2">
                                                    <p class="font-medium text-sm">${teacher.name}</p>
                                                    <p class="text-xs text-gray-600">${teacher.position}</p>
                                                    <div class="flex items-center justify-center mt-1">
                                                        <span class="queue-score text-xs">${teacher.queueScore}</span>
                                                        ${isRecommended ? '<span class="ml-1 text-xs">‚≠ê</span>' : ''}
                                                    </div>
                                                    <p class="text-xs text-gray-500">‡∏á‡∏≤‡∏ô ${teacher.dutyDuties ?? 0} | ‡∏≠‡∏ö‡∏£‡∏° ${teacher.trainingDuties ?? 0}</p>
                                                </div>
                                                <div class="selection-indicator mt-2 w-4 h-4 rounded-full border-2 ${isSelected ? 'bg-green-500 border-green-500' : 'border-gray-300'}">
                                                    ${isSelected ? '<span class="text-white text-xs">‚úì</span>' : ''}
                                                </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="mt-3 text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                        <p><span class="font-medium">üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</span> ‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏°‡∏µ ‚≠ê ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î</p>
                        <p class="mt-1"><span class="font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß:</span> <span id="selected-count">0</span>/${event.requiredQuota} ‡∏Ñ‡∏ô</p>
                    </div>
                </div>
            `;

            // Initialize selection count
            updateSelectedCount(event.requiredQuota);

            document.getElementById('confirm-auto-assign').onclick = () => confirmAutoAssignFromSelection(eventId, currentEventQueueType);
            document.getElementById('auto-assign-modal').classList.add('show');
        }

        function toggleTeacherSelection(teacherId, requiredQuota) {
            const card = document.querySelector(`[data-teacher-id="${teacherId}"]`);
            const indicator = card.querySelector('.selection-indicator');
            const isCurrentlySelected = card.classList.contains('border-green-500');
            
            if (isCurrentlySelected) {
                // Deselect
                card.classList.remove('border-green-500', 'bg-green-50');
                card.classList.add('border-gray-200', 'bg-white');
                indicator.classList.remove('bg-green-500', 'border-green-500');
                indicator.classList.add('border-gray-300');
                indicator.innerHTML = '';
            } else {
                // Check if we can select more
                const currentSelected = document.querySelectorAll('.teacher-select-card.border-green-500').length;
                if (currentSelected >= requiredQuota) {
                    alert(`‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${requiredQuota} ‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`);
                    return;
                }
                
                // Select
                card.classList.remove('border-gray-200', 'bg-white');
                card.classList.add('border-green-500', 'bg-green-50');
                indicator.classList.remove('border-gray-300');
                indicator.classList.add('bg-green-500', 'border-green-500');
                indicator.innerHTML = '<span class="text-white text-xs">‚úì</span>';
            }
            
            updateSelectedCount(requiredQuota);
        }

        function updateSelectedCount(requiredQuota) {
            const selectedCount = document.querySelectorAll('.teacher-select-card.border-green-500').length;
            const countElement = document.getElementById('selected-count');
            if (countElement) {
                countElement.textContent = selectedCount;
                countElement.style.color = selectedCount === requiredQuota ? '#059669' : '#dc2626';
            }
        }

        function confirmAutoAssignFromSelection(eventId, queueType = currentEventQueueType) {
            const selectedCards = document.querySelectorAll('.teacher-select-card.border-green-500');
            const selectedTeacherIds = Array.from(selectedCards).map(card =>
                parseInt(card.getAttribute('data-teacher-id'))
            );

            const event = getEventById(eventId, queueType);

            if (selectedTeacherIds.length !== event.requiredQuota) {
                alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ${event.requiredQuota} ‡∏Ñ‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${selectedTeacherIds.length} ‡∏Ñ‡∏ô)`);
                return;
            }

            const selectedTeachers = selectedTeacherIds.map(id => getTeacherById(id));
            confirmAutoAssign(eventId, selectedTeachers, queueType);
        }

        function closeAutoAssignModal() {
            document.getElementById('auto-assign-modal').classList.remove('show');
        }

        function confirmAutoAssign(eventId, selectedTeachers, queueType = currentEventQueueType) {
            const event = getEventById(eventId, queueType);
            const teacherIds = selectedTeachers.map(t => t.teacherId);

            // Update event
            event.assignedTeachers = teacherIds;
            event.assignmentSlots = createAssignmentSlotsFromIds(teacherIds);
            event.status = 'assigned';
            ensureEventAssignments(event);

            // Update teacher stats - ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô
            selectedTeachers.forEach(teacher => {
                ensureTeacherStats(teacher);
                if (queueType === QUEUE_TYPES.TRAINING) {
                    teacher.trainingDuties = (teacher.trainingDuties || 0) + 1;
                    teacher.lastTrainingDate = normalizeDateString(event.date);
                } else {
                    teacher.dutyDuties = (teacher.dutyDuties || 0) + 1;
                    teacher.lastDutyDate = normalizeDateString(event.date);
                }
                teacher.totalDuties = (teacher.dutyDuties || 0) + (teacher.trainingDuties || 0);
                teacher.queueScore += 15; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 15 ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô
                teacher.lastEventDate = normalizeDateString(event.date);
            });

            // Add activity log
            const teacherNames = selectedTeachers.map(t => t.name).join(', ');
            addActivityLog(
                'auto-assign',
                `‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö${getQueueDisplayName(queueType)} "${event.eventName}"`,
                `‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢: ${teacherNames}`
            );

            saveData();
            closeAutoAssignModal();
            showView(getQueueView(queueType));
        }

        function openSubstitutionModal(eventId, queueType = QUEUE_TYPES.DUTY) {
            currentEventQueueType = queueType || QUEUE_TYPES.DUTY;
            const event = getEventById(eventId, currentEventQueueType);
            const slots = event ? getEventAssignmentSlots(event) : [];
            const currentAssignments = slots.filter(slot => slot.currentTeacherId !== null && slot.currentTeacherId !== undefined);

            if (!event || currentAssignments.length === 0) return;

            currentEventId = eventId;

            const assignedIds = currentAssignments
                .map(slot => slot.currentTeacherId)
                .filter(id => id !== null && id !== undefined);

            const currentTeachersHtml = `
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <h5 class="font-medium text-gray-800 mb-2">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô${getQueueDisplayName(currentEventQueueType)}‡∏ô‡∏µ‡πâ:</h5>
                    <div class="space-y-2">
                        ${slots.map((slot, index) => {
                            if (slot.currentTeacherId === null || slot.currentTeacherId === undefined) {
                                return '';
                            }
                            const currentTeacher = getTeacherById(slot.currentTeacherId);
                            const originalTeacher = slot.originalTeacherId ? getTeacherById(slot.originalTeacherId) : null;
                            const isSubstituted = slot.originalTeacherId && slot.currentTeacherId && slot.originalTeacherId !== slot.currentTeacherId;
                            return `
                                <div class="flex items-center justify-between bg-white px-3 py-2 rounded-lg border ${isSubstituted ? 'border-[#E1B1C1]' : 'border-gray-200'}">
                                    <div class="flex items-center">
                                        ${createTeacherAvatar(currentTeacher)}
                                        <div class="ml-2">
                                            <p class="text-sm font-medium text-gray-800">${currentTeacher ? currentTeacher.name : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</p>
                                            ${isSubstituted
                                                ? `<p class="text-xs text-[#894D5B]">‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á ${originalTeacher ? originalTeacher.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>`
                                                : '<p class="text-xs text-gray-500">‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏î‡∏¥‡∏°</p>'}
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-500">‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà ${index + 1}</span>
                                </div>
                            `;
                        }).filter(Boolean).join('')}
                    </div>
                </div>
            `;

            const modalContent = document.querySelector('#substitution-modal .modal-content');
            const existingDisplay = modalContent.querySelector('.current-teachers-display');
            if (existingDisplay) {
                existingDisplay.remove();
            }

            const tempDiv = document.createElement('div');
            tempDiv.className = 'current-teachers-display';
            tempDiv.innerHTML = currentTeachersHtml;
            modalContent.insertBefore(tempDiv, document.getElementById('substitution-form'));

            const originalSelect = document.getElementById('original-teacher');
            originalSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π</option>' +
                currentAssignments.map(slot => {
                    const currentTeacher = getTeacherById(slot.currentTeacherId);
                    const originalTeacher = slot.originalTeacherId ? getTeacherById(slot.originalTeacherId) : null;
                    const currentName = currentTeacher ? currentTeacher.name : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                    const originalLabel = originalTeacher ? ` (‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏î‡∏¥‡∏°: ${originalTeacher.name})` : '';
                    return `<option value="${slot.currentTeacherId}">${currentName}${originalLabel}</option>`;
                }).join('');

            const substituteSelect = document.getElementById('substitute-teacher');
            const availableTeachers = teachers.filter(t => !assignedIds.includes(t.teacherId));
            substituteSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π</option>' +
                availableTeachers.map(teacher =>
                    `<option value="${teacher.teacherId}">${teacher.name} - ${teacher.position} (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏ß: ${teacher.queueScore})</option>`
                ).join('');

            document.getElementById('substitution-modal').classList.add('show');
        }

        function closeSubstitutionModal() {
            document.getElementById('substitution-modal').classList.remove('show');
            document.getElementById('substitution-form').reset();
            currentEventId = null;
        }

        function editEvent(eventId, queueType = QUEUE_TYPES.DUTY) {
            openEventModal(eventId, queueType);
        }

        function editTeacher(teacherId) {
            openTeacherModal(teacherId);
        }

        function adjustQueueScore(teacherId) {
            const teacher = getTeacherById(teacherId);
            const newScore = prompt(`‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${teacher.name}\n‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${teacher.queueScore}`, teacher.queueScore);
            
            if (newScore !== null && !isNaN(newScore)) {
                const reason = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö):');
                if (reason && reason.trim()) {
                    const oldScore = teacher.queueScore;
                    teacher.queueScore = parseInt(newScore);
                    
                    addActivityLog(
                        'manual-edit',
                        `‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á ${teacher.name}`,
                        `‡∏à‡∏≤‡∏Å ${oldScore} ‡πÄ‡∏õ‡πá‡∏ô ${newScore} | ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason}`
                    );
                    
                    saveData();
                    renderTeachersTable();
                } else {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
                }
            }
        }

        // Form submissions
        function safeValue(id) {
            const el = document.getElementById(id);
            return el ? el.value : '';
        }

        document.getElementById('event-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.currentTarget;
            try {
                if (!form.reportValidity()) return;

                const startTime = safeValue('event-start-time');
                const endTime = safeValue('event-end-time');

                const latRaw = parseFloat(safeValue('event-location-lat'));
                const lngRaw = parseFloat(safeValue('event-location-lng'));
                const locationLat = Number.isFinite(latRaw) ? latRaw : null;
                const locationLng = Number.isFinite(lngRaw) ? lngRaw : null;

                const eventData = {
                    eventName: safeValue('event-name'),
                    details: safeValue('event-details'),
                    date: safeValue('event-date'),
                    startTime,
                    endTime,
                    time: `${startTime}-${endTime}`,
                    location: safeValue('event-location'),
                    locationLat,
                    locationLng,
                    requiredQuota: parseInt(safeValue('event-quota')) || 0
                };

                const queueType = currentEventQueueType || QUEUE_TYPES.DUTY;
                const targetCollection = getQueueEvents(queueType);

                if (currentEventId) {
                    const event = getEventById(currentEventId, queueType);
                    Object.assign(event, eventData);
                    ensureEventAssignments(event);

                    addActivityLog(
                        'manual-edit',
                        `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•${getQueueDisplayName(queueType)} "${eventData.eventName}"`,
                        `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDateThai(eventData.date)} | ‡πÄ‡∏ß‡∏•‡∏≤: ${eventData.time} | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${eventData.location} | ‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏Ñ‡∏£‡∏π: ${eventData.requiredQuota} ‡∏Ñ‡∏ô`
                    );
                } else {
                    const newEvent = {
                        eventId: Math.max(...targetCollection.map(e => e.eventId), 0) + 1,
                        ...eventData,
                        assignedTeachers: [],
                        assignmentSlots: [],
                        status: 'pending'
                    };
                    ensureEventAssignments(newEvent);
                    targetCollection.push(newEvent);

                    addActivityLog(
                        'manual-edit',
                        `‡πÄ‡∏û‡∏¥‡πà‡∏°${getQueueDisplayName(queueType)}‡πÉ‡∏´‡∏°‡πà "${eventData.eventName}"`,
                        `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDateThai(eventData.date)} | ‡πÄ‡∏ß‡∏•‡∏≤: ${eventData.time} | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${eventData.location} | ‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏Ñ‡∏£‡∏π: ${eventData.requiredQuota} ‡∏Ñ‡∏ô`
                    );
                }

                saveData();
                closeEventModal();
                showView(getQueueView(queueType));
            } catch (err) {
                console.error('Event form submit failed:', err);
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err?.message || err));
            }
        });

        document.getElementById('teacher-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.currentTarget;
            try {
                if (!form.reportValidity()) return;

                const teacherData = {
                    name: safeValue('teacher-name'),
                    position: safeValue('teacher-position'),
                    queueScore: parseInt(safeValue('teacher-queue-score')) || 0
                };

                if (currentTeacherId) {
                    const teacher = getTeacherById(currentTeacherId);
                    Object.assign(teacher, teacherData);
                    ensureTeacherStats(teacher);

                    addActivityLog(
                        'manual-edit',
                        `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π "${teacherData.name}"`,
                        `‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${teacherData.position} | ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏ß: ${teacherData.queueScore}`
                    );
                } else {
                    const newTeacher = {
                        teacherId: Math.max(...teachers.map(t => t.teacherId), 0) + 1,
                        ...teacherData,
                        totalDuties: 0,
                        swapCount: 0,
                        dutyDuties: 0,
                        trainingDuties: 0,
                        dutySwapCount: 0,
                        trainingSwapCount: 0,
                        lastDutyDate: null,
                        lastTrainingDate: null
                    };
                    ensureTeacherStats(newTeacher);
                    teachers.push(newTeacher);

                    addActivityLog(
                        'manual-edit',
                        `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡∏°‡πà "${teacherData.name}"`,
                        `‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${teacherData.position} | ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ${teacherData.queueScore}`
                    );
                }

                saveData();
                closeTeacherModal();
                showView('teachers');
            } catch (err) {
                console.error('Teacher form submit failed:', err);
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err?.message || err));
            }
        });

        document.getElementById('substitution-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const originalTeacherId = parseInt(document.getElementById('original-teacher').value);
            const substituteTeacherId = parseInt(document.getElementById('substitute-teacher').value);
            const reason = document.getElementById('substitution-reason').value;

            if (!originalTeacherId || !substituteTeacherId || !reason.trim()) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            const event = getEventById(currentEventId, currentEventQueueType);
            const slots = getEventAssignmentSlots(event);
            const slot = slots.find(s => s.currentTeacherId === originalTeacherId) ||
                slots.find(s => s.originalTeacherId === originalTeacherId);

            const originalQueueTeacherId = slot && slot.originalTeacherId ? slot.originalTeacherId : originalTeacherId;
            const queueTeacher = getTeacherById(originalQueueTeacherId);
            const currentAssignedTeacher = getTeacherById(originalTeacherId);
            const substituteTeacher = getTeacherById(substituteTeacherId);

            // Update event assignment
            const index = event.assignedTeachers.indexOf(originalTeacherId);
            if (index !== -1) {
                event.assignedTeachers[index] = substituteTeacherId;
            }

            if (slot) {
                const slotIndex = slots.indexOf(slot);
                if (slotIndex !== -1 && slotIndex !== index) {
                    event.assignedTeachers[slotIndex] = substituteTeacherId;
                }
                if (!slot.originalTeacherId) {
                    slot.originalTeacherId = originalTeacherId;
                }
                slot.currentTeacherId = substituteTeacherId;
                slot.substituteTeacherId = substituteTeacherId;
            }

            ensureEventAssignments(event);

            // Update teacher stats - ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô
            ensureTeacherStats(substituteTeacher);
            if (currentEventQueueType === QUEUE_TYPES.TRAINING) {
                substituteTeacher.trainingDuties = (substituteTeacher.trainingDuties || 0) + 1;
                substituteTeacher.trainingSwapCount = (substituteTeacher.trainingSwapCount || 0) + 1;
                substituteTeacher.lastTrainingDate = normalizeDateString(event.date);
            } else {
                substituteTeacher.dutyDuties = (substituteTeacher.dutyDuties || 0) + 1;
                substituteTeacher.dutySwapCount = (substituteTeacher.dutySwapCount || 0) + 1;
                substituteTeacher.lastDutyDate = normalizeDateString(event.date);
            }
            substituteTeacher.totalDuties = (substituteTeacher.dutyDuties || 0) + (substituteTeacher.trainingDuties || 0);
            substituteTeacher.swapCount = (substituteTeacher.dutySwapCount || 0) + (substituteTeacher.trainingSwapCount || 0);
            substituteTeacher.queueScore += 25; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 25 ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô
            substituteTeacher.lastEventDate = normalizeDateString(event.date);

            addActivityLog(
                'substitution',
                `‡πÅ‡∏ó‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÉ‡∏ô${getQueueDisplayName(currentEventQueueType)} "${event.eventName}"`,
                `‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏î‡∏¥‡∏°: ${queueTeacher ? queueTeacher.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} | ‡∏ú‡∏π‡πâ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${currentAssignedTeacher ? currentAssignedTeacher.name : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'} | ‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏à‡∏£‡∏¥‡∏á: ${substituteTeacher ? substituteTeacher.name : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'} | ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason}`
            );

            saveData();
            closeSubstitutionModal();
            showView(getQueueView(currentEventQueueType));
        });

        // Navigation event listeners
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                const viewName = this.getAttribute('data-view');
                showView(viewName);
            });
        });

        // Element SDK implementation
        const elementSdk = {
            init: async function(element) {
                this.element = element;
                this.config = { ...systemConfig };

                await element.onConfigChange(this.config);

                return { isOk: true };
            },

            setConfig: async function(newConfig) {
                this.config = { ...this.config, ...newConfig };
                await this.element.onConfigChange(this.config);
            }
        };

        // Make elementSdk available globally
        window.elementSdk = elementSdk;

        // Initialize Element SDK
        async function initializeElementSdk() {
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig: defaultConfig,
                    onConfigChange: async function(config) {
                        systemConfig = { ...defaultConfig, ...config };
                        updateSystemLabels();
                        if (dataInitialized) {
                            saveData();
                        }
                    },
                    mapToCapabilities: function() {
                        return {
                            recolorables: [],
                            borderables: [],
                            fontEditable: undefined,
                            fontSizeable: undefined
                        };
                    },
                    mapToEditPanelValues: function(config) {
                        const mergedConfig = { ...defaultConfig, ...config };
                        return new Map([
                            ["system_title", mergedConfig.system_title],
                            ["school_name", mergedConfig.school_name]
                        ]);
                    }
                });
            }
        }

        window.initMap = function() {
            mapsApiReady = true;
            initializeLocationMap();

            if (pendingLocationEvent) {
                prepareLocationPicker(pendingLocationEvent);
                pendingLocationEvent = null;
            }
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeElementSdk();
            await loadInitialData();
        });
    </script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    updateDoc,
    collection,
    getDocs,
    query,
    orderBy,
    writeBatch
  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const fallbackConfig = {
    apiKey: 'AIzaSyDv--hw2BWKE-NTFrCMpTNz9LEzGK8l5PE',
    authDomain: 'thaigogo-e9112.firebaseapp.com',
    projectId: 'thaigogo-e9112',
    storageBucket: 'thaigogo-e9112.firebasestorage.app',
    messagingSenderId: '820257616141',
    appId: '1:820257616141:web:c92cf50ae5e05491fb4044',
    measurementId: 'G-4FX435MNDC'
  };

  const providedConfig = window.firebaseAppConfig || {};
  const firebaseConfig = Object.assign({}, fallbackConfig, providedConfig);

  try {
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authReady = new Promise((resolve, reject) => {
      onAuthStateChanged(
        auth,
        (user) => {
          if (user) {
            resolve(user);
          } else {
            signInAnonymously(auth).catch((authError) => {
              console.error('Anonymous sign-in failed:', authError);
              reject(authError);
            });
          }
        },
        (error) => {
          console.error('Auth observer error:', error);
          reject(error);
        }
      );
    });

    const helpers = {
      async get(path = "") {
        await authReady;
        const seg = path.split("/").filter(Boolean);

        if (seg.length === 1) {
          const key = seg[0];
          if (key === "config") {
            const snap = await getDoc(doc(db, "config", "app"));
            return snap.exists() ? snap.data() : null;
          }
          if (key === "teachers") {
            const snap = await getDocs(query(collection(db, "teachers"), orderBy("teacherId", "asc")));
            return snap.docs.map((d) => d.data());
          }
          if (key === "events") {
            const snap = await getDocs(query(collection(db, "events"), orderBy("eventId", "asc")));
            return snap.docs.map((d) => d.data());
          }
          if (key === "trainingEvents") {
            const snap = await getDocs(query(collection(db, "trainingEvents"), orderBy("eventId", "asc")));
            return snap.docs.map((d) => d.data());
          }
          if (key === "activityLog") {
            const snap = await getDocs(query(collection(db, "activityLog"), orderBy("timestamp", "desc")));
            return snap.docs.map((d) => d.data());
          }
        }

        if (seg.length === 2) {
          const [col, id] = seg;
          const snap = await getDoc(doc(db, col, String(id)));
          return snap.exists() ? snap.data() : null;
        }

        throw new Error(`Unsupported GET path: ${path}`);
      },

      async put(path = "", value) {
        await authReady;
        const seg = path.split("/").filter(Boolean);

        if (seg.length === 1 && seg[0] === "config") {
          await setDoc(doc(db, "config", "app"), value ?? {}, { merge: false });
          return value;
        }

        if (seg.length === 1 && ["teachers", "events", "trainingEvents", "activityLog"].includes(seg[0])) {
          const col = seg[0];
          const batch = writeBatch(db);

          const existing = await getDocs(collection(db, col));
          existing.forEach((docSnap) => batch.delete(docSnap.ref));

          const arr = Array.isArray(value) ? value : [];
          for (const row of arr) {
            const id =
              col === "teachers" ? String(row.teacherId) :
              col === "events" ? String(row.eventId) :
              col === "trainingEvents" ? String(row.eventId) :
              String(row.id ?? Date.now());
            batch.set(doc(db, col, id), row ?? {}, { merge: false });
          }

          await batch.commit();
          return value;
        }

        if (seg.length === 2) {
          const [col, id] = seg;
          await setDoc(doc(db, col, String(id)), value ?? {}, { merge: false });
          return value;
        }

        throw new Error(`Unsupported PUT path: ${path}`);
      },

      async patch(path = "", value) {
        await authReady;
        const seg = path.split("/").filter(Boolean);

        if (seg.length === 2) {
          const [col, id] = seg;
          await updateDoc(doc(db, col, String(id)), value ?? {});
          return value;
        }

        if (seg.length === 1 && ["teachers", "events", "trainingEvents", "activityLog"].includes(seg[0])) {
          const col = seg[0];
          const arr = Array.isArray(value) ? value : [];
          const batch = writeBatch(db);
          for (const row of arr) {
            const id =
              col === "teachers" ? String(row.teacherId) :
              col === "events" ? String(row.eventId) :
              col === "trainingEvents" ? String(row.eventId) :
              String(row.id ?? Date.now());
            batch.set(doc(db, col, id), row ?? {}, { merge: true });
          }
          await batch.commit();
          return value;
        }

        throw new Error("PATCH requires collection/id or mergeable array");
      }
    };

    window.firebaseApp = app;
    window.firebaseDatabase = null;
    window.firebaseDbApi = helpers;

    if (typeof window.notifyFirebaseReady === "function") {
      window.notifyFirebaseReady(app, null, helpers);
    }
  } catch (error) {
    if (typeof window.notifyFirebaseInitError === "function") {
      window.notifyFirebaseInitError(error);
    } else {
      console.error("Firebase initialization error:", error);
    }
  }
  </script>
 <script>
  window.addEventListener('error', (e) => {
   console.error('Global error:', e.error || e.message || e);
  });
  window.addEventListener('unhandledrejection', (e) => {
   console.error('Unhandled promise rejection:', e.reason || e);
  });
 </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'995b9a46b40c072d',t:'MTc2MTY2Njc3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
