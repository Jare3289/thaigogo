<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบจัดการคิวงานพระราชพิธีครู</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        body {
            box-sizing: border-box;
            font-family: 'Sarabun', sans-serif;
            background: var(--surface-muted);
            color: #2c1720;
            min-height: 100vh;
        }

        :root {
            --primary-bg: #E1B1C1;
            --secondary-bg: #894D5B;
            --accent-color: #C4E9F8;
            --success-color: #88A82A;
            --warning-color: #21510A;
            --surface-muted: #f8f1f4;
        }
        
        .view {
            padding: 1.5rem 1rem;
        }

        .view-container {
            width: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .status-banner {
            border-radius: 12px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
        }

        .status-banner svg {
            flex-shrink: 0;
        }

        .nav-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: flex-start;
            width: 100%;
        }

        @media (min-width: 768px) {
            .nav-list {
                width: auto;
                justify-content: flex-end;
            }
        }

        @media (max-width: 767px) {
            .nav-item {
                flex: 1 1 calc(50% - 0.5rem);
                text-align: center;
            }
        }

        .nav-item {
            transition: all 0.3s ease;
            border-radius: 8px;
            color: inherit;
        }

        .nav-item:hover {
            background: rgba(137, 77, 91, 0.12);
        }

        .nav-item.active {
            background: rgba(137, 77, 91, 0.18);
            border-bottom: 3px solid var(--secondary-bg);
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(137, 77, 91, 0.08);
        }
        
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: var(--secondary-bg);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #6f3b48;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--primary-bg);
            color: var(--secondary-bg);
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background: #d9a6b7;
            color: var(--secondary-bg);
        }

        .queue-reset-button {
            padding: 0.35rem 0.9rem;
            border-radius: 9999px;
            border: 1px solid rgba(137, 77, 91, 0.35);
            background: rgba(255, 255, 255, 0.9);
            color: #894D5B;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .queue-reset-button:hover {
            background: rgba(137, 77, 91, 0.08);
            border-color: rgba(137, 77, 91, 0.55);
            color: #5b2d38;
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            background: var(--warning-color);
        }

        .btn-delete {
            background: #f87171;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            background: #ef4444;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .table th {
            background: var(--primary-bg);
            font-weight: 600;
            color: #4a2c35;
        }

        .table tbody tr {
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .table tbody tr:hover {
            background: rgba(225, 177, 193, 0.25);
        }

        .table tbody tr.is-active {
            background: rgba(137, 77, 91, 0.12);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--secondary-bg);
            box-shadow: 0 0 0 3px rgba(137, 77, 91, 0.1);
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-assigned {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-completed {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .queue-score {
            display: inline-block;
            background: rgba(137, 77, 91, 0.12);
            color: var(--secondary-bg);
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 12px;
        }
        
        .teacher-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--secondary-bg);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
            overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .teacher-avatar-large {
            width: 62px;
            height: 62px;
            border-radius: 50%;
            background: var(--secondary-bg);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 12px rgba(137,77,91,0.15);
        }
        
        .teacher-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .next-queue-grid {
            display: grid;
            gap: 0.4rem;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        }

        @media (min-width: 1280px) {
            .next-queue-grid {
                grid-template-columns: repeat(13, minmax(0, 1fr));
            }
        }

        .next-queue-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            gap: 0.35rem;
            padding: 0.5rem;
            border-radius: 12px;
            background: white;
            border: 1px solid rgba(137, 77, 91, 0.18);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            min-height: 140px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .next-queue-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
        }

        .next-queue-card.is-active {
            border-color: rgba(137, 77, 91, 0.55);
            box-shadow: 0 8px 18px rgba(137, 77, 91, 0.15);
        }

        .next-queue-card .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 1px 6px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 600;
            color: var(--secondary-bg);
            background: rgba(137, 77, 91, 0.15);
            white-space: nowrap;
        }

        .next-queue-card .queue-mini-stat {
            display: flex;
            width: 100%;
            align-items: center;
            justify-content: space-between;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 6px;
            background: rgba(225, 177, 193, 0.25);
            color: #4a2c35;
            font-weight: 500;
        }

        .next-queue-card .queue-mini-stat.is-duty {
            background: rgba(196, 233, 248, 0.35);
            color: #2a5a6f;
        }

        .next-queue-card .queue-mini-stat.is-training {
            background: rgba(225, 177, 193, 0.35);
            color: #5b2d38;
        }

        .next-queue-card .queue-mini-stat.is-focus {
            border: 1px solid rgba(137, 77, 91, 0.35);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .next-queue-card .queue-mini-stat.is-sub {
            background: rgba(136, 168, 42, 0.18);
            color: var(--warning-color);
        }

        .log-entry {
            border-left: 4px solid #e5e7eb;
            padding-left: 12px;
            margin-bottom: 12px;
        }
        
        .log-entry.auto-assign {
            border-left-color: var(--success-color);
        }
        
        .log-entry.manual-edit {
            border-left-color: var(--warning-color);
        }
        
        .log-entry.substitution {
            border-left-color: var(--secondary-bg);
        }

        .teacher-detail-card {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .teacher-detail-card .detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #4b5563;
        }

        .teacher-detail-card .detail-row span:first-child {
            font-weight: 600;
            color: #374151;
        }

    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <script>
   (function () {
    const hide = () => {
     const el = document.getElementById('loading-overlay');
     if (el) el.classList.add('hidden');
    };
    window.addEventListener('error', (e) => {
     console.error('[GlobalError]', e.error || e.message || e);
     hide();
    });
    window.addEventListener('unhandledrejection', (e) => {
     console.error('[UnhandledRejection]', e.reason || e);
     hide();
    });
    setTimeout(hide, 8000);
   })();
  </script>
  <div class="flex flex-col h-screen"><!-- Top Navigation -->
   <div class="shadow-lg" style="background: var(--primary-bg); color: #4a2c35;">
    <div class="px-6 py-4">
     <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
       <h1 id="systemTitle" class="text-xl font-bold">ระบบจัดการออกงานครู</h1>
       <p id="schoolName" class="text-sm opacity-80">กลุ่มสาระการเรียนรู้ภาษาไทย</p>
      </div>
      <nav class="nav-list">
       <div class="nav-item active px-4 py-2 cursor-pointer rounded-lg" data-view="dashboard">
        <div class="flex items-center"><span class="mr-2">🏠</span> <span>หน้าหลัก</span>
        </div>
       </div>
       <div class="nav-item px-4 py-2 cursor-pointer rounded-lg" data-view="events">
        <div class="flex items-center"><span class="mr-2">📅</span> <span>ออกงาน</span>
        </div>
       </div>
       <div class="nav-item px-4 py-2 cursor-pointer rounded-lg" data-view="trainings">
        <div class="flex items-center"><span class="mr-2">🎓</span> <span>อบรม</span>
        </div>
       </div>
       <div class="nav-item px-4 py-2 cursor-pointer rounded-lg" data-view="teachers">
        <div class="flex items-center"><span class="mr-2">👥</span> <span>ครู</span>
        </div>
       </div>
       <div class="nav-item px-4 py-2 cursor-pointer rounded-lg" data-view="history">
        <div class="flex items-center"><span class="mr-2">📋</span> <span>บันทึกและประวัติ</span>
        </div>
       </div>
      </nav>
     </div>
    </div>
   </div><!-- Main Content -->
   <div class="flex-1 overflow-auto" style="background: var(--surface-muted);"><!-- Dashboard View -->
    <div id="firebase-status-banner" class="hidden mx-auto mt-4 mb-2 w-full max-w-6xl"></div>
    <div id="dashboard-view" class="view">
     <div class="view-container">
      <h2 class="text-2xl font-bold text-gray-800">หน้าหลัก - ภาพรวมระบบ</h2><!-- Next Queue Section - แนวนอนที่บนสุด -->
      <div class="card p-5">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><span class="mr-2">⏭️</span>คิวต่อไป - ครูทั้งหมดเรียงตามลำดับความสำคัญ</h3>
      <div id="next-queue"><!-- Next queue will be populated here -->
      </div>
      <div id="next-queue-insight" class="mt-4 hidden"></div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card p-6 border-l-4" style="border-left-color: var(--secondary-bg);">
       <div class="flex items-center">
        <div class="p-3 rounded-full mr-4" style="background: rgba(225, 177, 193, 0.35); color: var(--secondary-bg);"><span class="text-2xl">📅</span>
        </div>
        <div>
         <p class="text-sm text-gray-600">งานทั้งหมด</p>
         <p class="text-2xl font-bold" style="color: var(--secondary-bg);" id="total-events">0</p>
        </div>
       </div>
      </div>
      <div class="card p-6 border-l-4" style="border-left-color: #88A82A;">
       <div class="flex items-center">
        <div class="p-3 rounded-full mr-4" style="background: rgba(136, 168, 42, 0.1); color: #88A82A;"><span class="text-2xl">✅</span>
        </div>
        <div>
         <p class="text-sm text-gray-600">งานที่จัดคิวแล้ว</p>
         <p class="text-2xl font-bold" style="color: #88A82A;" id="assigned-events">0</p>
        </div>
       </div>
      </div>
      <div class="card p-6 border-l-4" style="border-left-color: var(--accent-color);">
       <div class="flex items-center">
        <div class="p-3 rounded-full mr-4" style="background: rgba(196, 233, 248, 0.3); color: #1E90FF;"><span class="text-2xl">⏳</span>
        </div>
        <div>
         <p class="text-sm text-gray-600">รอจัดคิว</p>
         <p class="text-2xl font-bold" style="color: #1E90FF;" id="pending-events">0</p>
        </div>
       </div>
      </div>
      <div class="card p-6 border-l-4" style="border-left-color: var(--secondary-bg);">
       <div class="flex items-center">
        <div class="p-3 rounded-full mr-4" style="background: rgba(225, 177, 193, 0.35); color: var(--secondary-bg);"><span class="text-2xl">👥</span>
        </div>
        <div>
         <p class="text-sm text-gray-600">ครูทั้งหมด</p>
         <p class="text-2xl font-bold" style="color: var(--secondary-bg);" id="total-teachers">0</p>
        </div>
       </div>
      </div>
      </div><!-- Latest Event Section -->
      <div class="card p-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center"><span class="mr-2">🎯</span>งานล่าสุดที่จัดคิวแล้ว</h3>
      <div id="latest-event" class="space-y-3"><!-- Latest event will be populated here -->
      </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="card p-6">
       <h3 class="text-lg font-semibold text-gray-800 mb-4">งานที่ต้องจัดคิวเร่งด่วน</h3>
       <div id="urgent-events" class="space-y-3"><!-- Urgent events will be populated here -->
       </div>
      </div>
      <div class="card p-6">
       <h3 class="text-lg font-semibold text-gray-800 mb-4">ครูที่ควรออกงานถัดไป (คะแนนออกงานต่ำสุด)</h3>
       <div id="top-queue-teachers" class="space-y-3"><!-- Top queue teachers will be populated here -->
       </div>
      </div>
      </div><!-- Queue Score Explanation -->
      <div class="card p-8 border-2" style="background: rgba(225, 177, 193, 0.2); border-color: var(--secondary-bg);">
      <h3 class="text-xl font-bold mb-6 flex items-center" style="color: var(--secondary-bg);"><span class="mr-3 text-2xl">🎯</span>ระบบคะแนนความเป็นธรรม - วิธีการทำงาน</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
       <div class="p-4 rounded-lg" style="background: rgba(136, 168, 42, 0.1); border-left: 4px solid #88A82A;">
        <h4 class="font-bold text-gray-800 mb-3 flex items-center"><span class="mr-2">🏁</span>หลักการเริ่มต้น</h4>
        <ul class="text-sm text-gray-700 space-y-2">
         <li>• ครูเริ่มต้นด้วย <strong>0 คะแนน</strong></li>
         <li>• <strong>คะแนนน้อย = โอกาสได้งานมาก</strong></li>
         <li>• ระบบเลือกครูที่มีคะแนนต่ำสุดก่อน</li>
         <li>• ยิ่งออกงานน้อย ยิ่งได้โอกาสมาก</li>
        </ul>
       </div>
       <div class="p-4 rounded-lg" style="background: rgba(196, 233, 248, 0.3); border-left: 4px solid #C4E9F8;">
        <h4 class="font-bold text-gray-800 mb-3 flex items-center"><span class="mr-2">📈</span>การได้คะแนน</h4>
        <ul class="text-sm text-gray-700 space-y-2">
         <li>• ออกงาน 1 ครั้ง = <strong>+15 คะแนน</strong></li>
         <li>• แทนคนอื่น = <strong>+25 คะแนน</strong></li>
         <li>• งานสำคัญพิเศษ = <strong>+20 คะแนน</strong></li>
         <li>• คะแนนสะสมตลอดปีการศึกษา</li>
        </ul>
       </div>
       <div class="p-4 rounded-lg" style="background: rgba(225, 177, 193, 0.35); border-left: 4px solid var(--secondary-bg);">
        <h4 class="font-bold text-gray-800 mb-3 flex items-center"><span class="mr-2">⚖️</span>ความยุติธรรม</h4>
        <ul class="text-sm text-gray-700 space-y-2">
         <li>• จัดคิวอัตโนมัติตามคะแนนต่ำสุด</li>
         <li>• กระจายภาระงานอย่างเท่าเทียม</li>
         <li>• ป้องกันการออกงานซ้ำคนเดิม</li>
         <li>• โปร่งใส ตรวจสอบได้ทุกขั้นตอน</li>
        </ul>
       </div>
      </div>
      <div class="p-4 rounded-lg" style="background: rgba(137, 77, 91, 0.05); border: 1px solid rgba(137, 77, 91, 0.2);">
       <p class="text-center font-medium" style="color: var(--secondary-bg);">💡 <strong>หลักสำคัญ:</strong> ครูที่มีคะแนนน้อยที่สุดจะได้รับโอกาสออกงานก่อน เพื่อความเป็นธรรมในการกระจายภาระงาน</p>
      </div>
     </div>
    </div>
   </div><!-- Events Management View -->
   <div id="events-view" class="view hidden">
     <div class="view-container">
      <div class="flex justify-between items-center">
       <h2 class="text-2xl font-bold text-gray-800">ออกงาน</h2><button class="btn-primary" onclick="openEventModal()"> <span class="mr-2">+</span>เพิ่มงานใหม่ </button>
      </div>
      <div id="events-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"><!-- Event cards will be populated here -->
      </div>
     </div>
   </div><!-- Training Management View -->
   <div id="trainings-view" class="view hidden">
    <div class="view-container">
     <div class="flex justify-between items-center">
      <h2 class="text-2xl font-bold text-gray-800">การออกรับการอบรม</h2><button class="btn-primary" onclick="openTrainingModal()"> <span class="mr-2">+</span>เพิ่มอบรมใหม่ </button>
     </div>
     <div id="trainings-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    </div>
   </div><!-- Teachers Management View -->
    <div id="teachers-view" class="view hidden">
     <div class="view-container">
      <div class="flex justify-between items-center">
       <h2 class="text-2xl font-bold text-gray-800">ครู</h2><button class="btn-primary" onclick="openTeacherModal()"> <span class="mr-2">+</span>เพิ่มครูใหม่ </button>
      </div>
      <div class="grid grid-cols-1 xl:grid-cols-3 gap-5">
       <div class="xl:col-span-2 card p-0">
        <div class="overflow-x-auto">
         <table class="table">
          <thead>
           <tr>
            <th>ลำดับ</th>
            <th>ชื่อครู</th>
            <th>ตำแหน่ง</th>
            <th>คะแนนออกงาน</th>
            <th>คะแนนอบรม</th>
            <th>ออกงาน</th>
            <th>อบรม</th>
            <th>แทนรวม</th>
           </tr>
          </thead>
          <tbody id="teachers-table-body"></tbody>
         </table>
        </div>
       </div>
       <div id="teacher-detail-panel" class="card p-6 teacher-detail-card">
        <p class="text-sm text-gray-500">เลือกครูจากตารางเพื่อดูรายละเอียดและจัดการข้อมูล</p>
       </div>
      </div>
     </div>
    </div><!-- History View -->
    <div id="history-view" class="view hidden">
     <div class="view-container">
      <h2 class="text-2xl font-bold text-gray-800">บันทึกการปฏิบัติงานและประวัติ</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
       <div class="card p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">สถิติรวมการกระจายงาน</h3>
        <div id="duty-distribution" class="space-y-2"><!-- Duty distribution will be populated here -->
        </div>
       </div>
       <div class="card p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">สถิติการแทนงาน</h3>
        <div id="substitution-stats" class="space-y-2"><!-- Substitution stats will be populated here -->
        </div>
       </div>
      </div>
      <div class="card p-6">
       <h3 class="text-lg font-semibold text-gray-800 mb-4">ประวัติการดำเนินการ</h3>
       <div id="activity-log" class="space-y-3 max-h-96 overflow-y-auto"><!-- Activity log will be populated here -->
       </div>
      </div>
     </div>
    </div>
    </div>
  </div><!-- Event Modal -->
  <div id="event-modal" class="modal">
   <div class="modal-content w-full max-w-2xl">
    <div class="flex justify-between items-center mb-6">
     <h3 id="event-modal-title" class="text-xl font-bold text-gray-800">เพิ่มงานใหม่</h3><button onclick="closeEventModal()" class="text-gray-500 hover:text-gray-700"> <span class="text-2xl">×</span> </button>
    </div>
    <form id="event-form">
     <div class="grid grid-cols-1 gap-4">
      <div class="form-group"><label class="form-label">ชื่องาน</label> <input type="text" id="event-name" class="form-input" required>
      </div>
      <div class="form-group"><label class="form-label">รายละเอียด</label> <textarea id="event-details" class="form-input" rows="3" placeholder="รายละเอียดเพิ่มเติมของงาน"></textarea>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div class="form-group"><label class="form-label">วันที่</label> <input type="date" id="event-date" class="form-input" required>
       </div>
       <div class="form-group md:col-span-1"><label class="form-label">เวลาเริ่มและสิ้นสุด</label>
        <div class="flex flex-col sm:flex-row gap-3">
         <input type="time" id="event-start-time" class="form-input sm:flex-1" required>
         <input type="time" id="event-end-time" class="form-input sm:flex-1" required>
        </div>
       </div>
      </div>
      <div class="form-group"><label class="form-label">สถานที่</label>
       <input type="text" id="event-location" class="form-input" placeholder="เช่น หอประชุมใหญ่ โรงเรียนหันคาพิทยาคม" required>
      </div>
      <div class="form-group md:w-1/2"><label class="form-label">จำนวนครูที่ต้องการ</label> <input type="number" id="event-quota" class="form-input" min="1" required>
      </div>
     </div>
     <div id="event-assignment-summary" class="mt-4 hidden">
      <h4 class="text-sm font-semibold text-gray-700 mb-2">ข้อมูลการจัดคิวปัจจุบัน</h4>
      <div id="event-assignment-list" class="space-y-2"></div>
     </div>
     <input type="hidden" id="event-location-lat" value="">
     <input type="hidden" id="event-location-lng" value="">
     <div class="flex justify-end space-x-3 mt-6"><button type="button" onclick="resetEventForm()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> รีเซ็ต </button><button type="button" onclick="closeEventModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> ยกเลิก </button> <button type="submit" class="btn-primary"> บันทึก </button>
     </div>
    </form>
   </div>
  </div><!-- Teacher Modal -->
  <div id="teacher-modal" class="modal">
   <div class="modal-content w-full max-w-lg">
    <div class="flex justify-between items-center mb-6">
     <h3 id="teacher-modal-title" class="text-xl font-bold text-gray-800">เพิ่มครูใหม่</h3><button onclick="closeTeacherModal()" class="text-gray-500 hover:text-gray-700"> <span class="text-2xl">×</span> </button>
    </div>
    <form id="teacher-form">
     <div class="form-group"><label class="form-label">ชื่อ</label> <input type="text" id="teacher-name" class="form-input" required>
     </div>
     <div class="form-group"><label class="form-label">ตำแหน่ง</label> <input type="text" id="teacher-position" class="form-input" required>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="form-group"><label class="form-label">คะแนนคิวออกงานเริ่มต้น</label> <input type="number" id="teacher-duty-queue-score" class="form-input" value="0" min="0" required>
      </div>
      <div class="form-group"><label class="form-label">คะแนนคิวอบรมเริ่มต้น</label> <input type="number" id="teacher-training-queue-score" class="form-input" value="0" min="0" required>
      </div>
     </div>
     <div class="flex justify-end space-x-3 mt-6"><button type="button" onclick="resetTeacherForm()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> รีเซ็ต </button><button type="button" onclick="closeTeacherModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> ยกเลิก </button> <button type="submit" class="btn-primary"> บันทึก </button>
     </div>
    </form>
   </div>
  </div><!-- Auto Assign Modal -->
  <div id="auto-assign-modal" class="modal">
   <div class="modal-content w-full max-w-lg">
    <div class="flex justify-between items-center mb-6">
     <h3 class="text-xl font-bold text-gray-800">กำหนดคิวอัตโนมัติ</h3><button onclick="closeAutoAssignModal()" class="text-gray-500 hover:text-gray-700"> <span class="text-2xl">×</span> </button>
    </div>
    <div id="auto-assign-content"><!-- Auto assign content will be populated here -->
    </div>
    <div class="flex justify-end space-x-3 mt-6"><button onclick="closeAutoAssignModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> ยกเลิก </button> <button id="confirm-auto-assign" class="btn-success"> ยืนยันการจัดคิว </button>
    </div>
   </div>
  </div><!-- Substitution Modal -->
  <div id="substitution-modal" class="modal">
   <div class="modal-content w-full max-w-lg">
    <div class="flex justify-between items-center mb-6">
     <h3 class="text-xl font-bold text-gray-800">แทนบุคลากร</h3><button onclick="closeSubstitutionModal()" class="text-gray-500 hover:text-gray-700"> <span class="text-2xl">×</span> </button>
    </div>
    <form id="substitution-form">
     <div class="form-group"><label class="form-label">ครูที่ต้องการเปลี่ยนออก</label> <select id="original-teacher" class="form-input" required> <option value="">เลือกครู</option> </select>
     </div>
     <div class="form-group"><label class="form-label">ครูที่จะมาแทน</label> <select id="substitute-teacher" class="form-input" required> <option value="">เลือกครู</option> </select>
     </div>
     <div class="form-group">
      <label class="form-label">รูปแบบการแทน</label>
      <div class="space-y-2">
       <label class="flex items-center gap-2 text-sm text-gray-700">
        <input type="radio" name="substitution-type" value="replacement" checked>
        <span>แทน (ไม่เพิ่มคะแนนผู้ไปแทน)</span>
       </label>
       <label class="flex items-center gap-2 text-sm text-gray-700">
        <input type="radio" name="substitution-type" value="swap">
        <span>แลกสลับ (เพิ่มคะแนนผู้ที่ไปแทน)</span>
       </label>
      </div>
     </div>
     <div class="form-group"><label class="form-label">เหตุผลการแทน (บังคับ)</label> <textarea id="substitution-reason" class="form-input" rows="3" required placeholder="กรุณาระบุเหตุผลการแทนบุคลากร"></textarea>
     </div>
     <div class="flex justify-end space-x-3 mt-6"><button type="button" onclick="closeSubstitutionModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> ยกเลิก </button> <button type="submit" class="btn-danger"> ยืนยันการแทน </button>
     </div>
   </form>
  </div>
 </div>
  <!-- Training Modal -->
  <div id="training-modal" class="modal">
   <div class="modal-content w-full max-w-2xl">
    <div class="flex justify-between items-center mb-6">
     <h3 id="training-modal-title" class="text-xl font-bold text-gray-800">เพิ่มอบรมใหม่</h3><button onclick="closeTrainingModal()" class="text-gray-500 hover:text-gray-700"> <span class="text-2xl">×</span> </button>
    </div>
    <form id="training-form">
     <div class="grid grid-cols-1 gap-4">
      <div class="form-group"><label class="form-label">ชื่ออบรม</label> <input type="text" id="training-name" class="form-input" required>
      </div>
      <div class="form-group"><label class="form-label">รายละเอียด</label> <textarea id="training-details" class="form-input" rows="3"></textarea>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div class="form-group"><label class="form-label">วันที่เริ่ม</label> <input type="date" id="training-start-date" class="form-input" required>
       </div>
       <div class="form-group"><label class="form-label">วันที่สิ้นสุด</label> <input type="date" id="training-end-date" class="form-input" required>
       </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div class="form-group"><label class="form-label">เวลาเริ่ม</label> <input type="time" id="training-start-time" class="form-input" required>
       </div>
       <div class="form-group"><label class="form-label">เวลาสิ้นสุด</label> <input type="time" id="training-end-time" class="form-input" required>
       </div>
      </div>
      <div class="form-group"><label class="form-label">สถานที่</label> <input type="text" id="training-location" class="form-input" required>
      </div>
      <div class="form-group md:w-1/2"><label class="form-label">จำนวนครูที่ต้องการ</label> <input type="number" id="training-quota" class="form-input" min="1" required>
      </div>
     </div><input type="hidden" id="training-location-lat" value=""><input type="hidden" id="training-location-lng" value="">
     <div class="flex justify-end space-x-3 mt-6"><button type="button" onclick="resetTrainingForm()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> รีเซ็ต </button><button type="button" onclick="closeTrainingModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> ยกเลิก </button> <button type="submit" class="btn-primary"> บันทึก </button>
     </div>
    </form>
  </div>
 </div>
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-[2000] hidden">
   <div class="text-center">
    <svg class="animate-spin h-10 w-10 text-[#894D5B] mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
     <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
     <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p class="text-sm font-medium text-gray-700">กำลังเชื่อมต่อกับฐานข้อมูล...</p>
   </div>
  </div>
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-[2000] hidden">
   <div class="text-center">
    <svg class="animate-spin h-10 w-10 text-[#894D5B] mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
     <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
     <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p class="text-sm font-medium text-gray-700">กำลังเชื่อมต่อกับฐานข้อมูล...</p>
   </div>
  </div>
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-[2000] hidden">
   <div class="text-center">
    <svg class="animate-spin h-10 w-10 text-[#894D5B] mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
     <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
     <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p class="text-sm font-medium text-gray-700">กำลังเชื่อมต่อกับฐานข้อมูล...</p>
   </div>
  </div>
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-[2000] hidden">
   <div class="text-center">
    <svg class="animate-spin h-10 w-10 text-[#894D5B] mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
     <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
     <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p class="text-sm font-medium text-gray-700">กำลังเชื่อมต่อกับฐานข้อมูล...</p>
   </div>
  </div>
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-[2000] hidden">
   <div class="text-center">
    <svg class="animate-spin h-10 w-10 text-[#894D5B] mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
     <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
     <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p class="text-sm font-medium text-gray-700">กำลังเชื่อมต่อกับฐานข้อมูล...</p>
   </div>
  </div>
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-[2000] hidden">
   <div class="text-center">
    <svg class="animate-spin h-10 w-10 text-[#894D5B] mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
     <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
     <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p class="text-sm font-medium text-gray-700">กำลังเชื่อมต่อกับฐานข้อมูล...</p>
   </div>
  </div>
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-[2000] hidden">
   <div class="text-center">
    <svg class="animate-spin h-10 w-10 text-[#894D5B] mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
     <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
     <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p class="text-sm font-medium text-gray-700">กำลังเชื่อมต่อกับฐานข้อมูล...</p>
   </div>
  </div>
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-[2000] hidden">
   <div class="text-center">
    <svg class="animate-spin h-10 w-10 text-[#894D5B] mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
     <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
     <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p class="text-sm font-medium text-gray-700">กำลังเชื่อมต่อกับฐานข้อมูล...</p>
   </div>
  </div>
  <script>
        // Firebase initialization bridge (shared with module loader)
        window.firebaseAppConfig = window.firebaseAppConfig || {
            apiKey: "AIzaSyDv--hw2BWKE-NTFrCMpTNz9LEzGK8l5PE",
            authDomain: "thaigogo-e9112.firebaseapp.com",
            databaseURL: "https://thaigogo-e9112-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "thaigogo-e9112",
            storageBucket: "thaigogo-e9112.firebasestorage.app",
            messagingSenderId: "820257616141",
            appId: "1:820257616141:web:c92cf50ae5e05491fb4044",
            measurementId: "G-4FX435MNDC"
        };

        window.firebaseReadyPromise = window.firebaseReadyPromise || new Promise((resolve, reject) => {
            window.__resolveFirebaseReady = resolve;
            window.__rejectFirebaseReady = reject;
        });

        window.notifyFirebaseReady = function(app, database, helpers) {
            window.firebaseApp = app;
            window.firebaseDatabase = database;
            if (helpers) {
                window.firebaseDbApi = helpers;
            }
            if (typeof window.__resolveFirebaseReady === 'function') {
                window.__resolveFirebaseReady({ app, database });
                window.__resolveFirebaseReady = null;
            }
        };

        window.notifyFirebaseInitError = function(error) {
            if (typeof window.__rejectFirebaseReady === 'function') {
                window.__rejectFirebaseReady(error);
                window.__rejectFirebaseReady = null;
            }
            console.error('Firebase initialization failed:', error);
            showFirebaseStatus('error', `Firebase เริ่มต้นไม่สำเร็จ: ${extractFirebaseMessage(error)}`, true);
        };

        window.callToAction = window.callToAction || function() { return null; };

        // Default configuration
        const defaultConfig = {
            system_title: "ระบบจัดการออกงานครู",
            school_name: "กลุ่มสาระการเรียนรู้ภาษาไทย"
        };

        const PRIMARY_COLOR = '#894D5B';
        const SECONDARY_COLOR = '#E1B1C1';

        const QUEUE_TYPES = Object.freeze({
            DUTY: 'duty',
            TRAINING: 'training'
        });
        window.QUEUE_TYPES = QUEUE_TYPES;

        const SUBSTITUTION_TYPES = Object.freeze({
            NONE: 'none',
            REPLACEMENT: 'replacement',
            SWAP: 'swap'
        });
        window.SUBSTITUTION_TYPES = SUBSTITUTION_TYPES;

        // Data structures
        let systemConfig = { ...defaultConfig };
        let teachers = [];
        let events = [];
        let trainings = [];
        let activityLog = [];
        let currentEventId = null;
        let currentTeacherId = null;
        let currentTrainingId = null;
        let currentEventInitialData = null;
        let currentTeacherInitialData = null;
        let currentTrainingInitialData = null;
        let currentNextQueueSelection = null;
        let currentEventQueueType = QUEUE_TYPES.DUTY;
        let selectedTeacherId = null;
        let dataInitialized = false;
        let firebaseDataLoaded = false;

        function normalizeDateString(input) {
            if (!input) {
                return null;
            }
            if (input instanceof Date && !Number.isNaN(input)) {
                return input.toISOString().slice(0, 10);
            }

            const str = String(input).trim();
            const direct = new Date(str);
            if (!Number.isNaN(direct.getTime())) {
                return direct.toISOString().slice(0, 10);
            }

            const match = str.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/);
            if (match) {
                let day = parseInt(match[1], 10);
                let month = parseInt(match[2], 10) - 1;
                let year = parseInt(match[3], 10);
                if (year > 2400) {
                    year -= 543;
                }
                const normalized = new Date(year, month, day);
                if (!Number.isNaN(normalized.getTime())) {
                    return normalized.toISOString().slice(0, 10);
                }
            }

            return null;
        }

        function ensureTeacherStats(t) {
            if (!t) {
                return t;
            }

            const fallbackScore = Number.isFinite(Number(t.queueScore)) ? Number(t.queueScore) : 0;

            if (typeof t.totalDuties !== 'number') {
                t.totalDuties = 0;
            }
            if (typeof t.swapCount !== 'number') {
                t.swapCount = 0;
            }
            if (typeof t.dutyDuties !== 'number') {
                t.dutyDuties = typeof t.totalDuties === 'number' ? t.totalDuties : 0;
            }
            if (typeof t.trainingDuties !== 'number') {
                t.trainingDuties = 0;
            }
            if (typeof t.dutySwapCount !== 'number') {
                t.dutySwapCount = 0;
            }
            if (typeof t.trainingSwapCount !== 'number') {
                t.trainingSwapCount = 0;
            }
            let normalizedDutyScore = Number.isFinite(Number(t.dutyQueueScore)) ? Number(t.dutyQueueScore) : fallbackScore;
            if (!Number.isFinite(normalizedDutyScore)) {
                normalizedDutyScore = 0;
            }
            let normalizedTrainingScore = Number.isFinite(Number(t.trainingQueueScore)) ? Number(t.trainingQueueScore) : 0;
            if (!Number.isFinite(normalizedTrainingScore)) {
                normalizedTrainingScore = 0;
            }
            if (!Number.isFinite(Number(t.initialDutyQueueScore))) {
                t.initialDutyQueueScore = normalizedDutyScore;
            } else {
                t.initialDutyQueueScore = Number(t.initialDutyQueueScore);
            }
            if (!Number.isFinite(Number(t.initialTrainingQueueScore))) {
                t.initialTrainingQueueScore = normalizedTrainingScore;
            } else {
                t.initialTrainingQueueScore = Number(t.initialTrainingQueueScore);
            }
            t.dutyQueueScore = normalizedDutyScore;
            t.trainingQueueScore = normalizedTrainingScore;
            t.queueScore = t.dutyQueueScore;
            t.lastEventDate = t.lastEventDate ? normalizeDateString(t.lastEventDate) : null;
            t.lastDutyDate = t.lastDutyDate ? normalizeDateString(t.lastDutyDate) : null;
            t.lastTrainingDate = t.lastTrainingDate ? normalizeDateString(t.lastTrainingDate) : null;

            return t;
        }

        function getTeacherQueueScore(teacher, queueType = QUEUE_TYPES.DUTY) {
            if (!teacher) {
                return 0;
            }
            ensureTeacherStats(teacher);
            const value = queueType === QUEUE_TYPES.TRAINING
                ? teacher.trainingQueueScore
                : teacher.dutyQueueScore;
            return Number.isFinite(value) ? value : 0;
        }

        function setTeacherQueueScore(teacher, queueType, value) {
            if (!teacher) {
                return;
            }
            ensureTeacherStats(teacher);
            const numericValue = Number.isFinite(value) ? value : 0;
            if (queueType === QUEUE_TYPES.TRAINING) {
                teacher.trainingQueueScore = numericValue;
            } else {
                teacher.dutyQueueScore = numericValue;
            }
            teacher.queueScore = teacher.dutyQueueScore;
        }

        function adjustTeacherQueueScore(teacher, queueType, delta) {
            if (!teacher) {
                return;
            }
            const current = getTeacherQueueScore(teacher, queueType);
            setTeacherQueueScore(teacher, queueType, current + delta);
        }

        function ensureAllTeacherStats(list) {
            (list || []).forEach(ensureTeacherStats);
        }

        function getQueueEvents(queueType = QUEUE_TYPES.DUTY) {
            return queueType === QUEUE_TYPES.TRAINING ? trainings : events;
        }

        function setQueueEvents(queueType, collection) {
            if (queueType === QUEUE_TYPES.TRAINING) {
                trainings = collection;
            } else {
                events = collection;
            }
        }

        function getQueueView(queueType = QUEUE_TYPES.DUTY) {
            return queueType === QUEUE_TYPES.TRAINING ? 'trainings' : 'events';
        }

        function getQueueDisplayName(queueType = QUEUE_TYPES.DUTY) {
            return queueType === QUEUE_TYPES.TRAINING ? 'การอบรม' : 'งาน';
        }

        function getQueueItemName(item, queueType = QUEUE_TYPES.DUTY) {
            if (!item) {
                return '';
            }
            return queueType === QUEUE_TYPES.TRAINING
                ? (item.trainingName || item.eventName || '')
                : (item.eventName || item.trainingName || '');
        }

        function safeDate(value) {
            if (!value) {
                return null;
            }
            if (value instanceof Date && !Number.isNaN(value)) {
                return value;
            }
            const normalized = normalizeDateString(value);
            if (!normalized) {
                return null;
            }
            const parsed = new Date(normalized);
            return Number.isNaN(parsed.getTime()) ? null : parsed;
        }

        function latestDateString(dateA, dateB) {
            const parsedA = safeDate(dateA);
            const parsedB = safeDate(dateB);

            if (!parsedA && !parsedB) {
                return null;
            }
            if (!parsedA) {
                return parsedB.toISOString().slice(0, 10);
            }
            if (!parsedB) {
                return parsedA.toISOString().slice(0, 10);
            }

            const latest = parsedA > parsedB ? parsedA : parsedB;
            return latest.toISOString().slice(0, 10);
        }

        function recomputeTeacherStats() {
            const teacherMap = new Map();

            teachers.forEach(teacher => {
                ensureTeacherStats(teacher);
                teacher.dutyDuties = 0;
                teacher.trainingDuties = 0;
                teacher.dutySwapCount = 0;
                teacher.trainingSwapCount = 0;
                teacher.totalDuties = 0;
                teacher.swapCount = 0;
                teacher.lastDutyDate = null;
                teacher.lastTrainingDate = null;
                teacherMap.set(teacher.teacherId, teacher);
            });

            const updateFromEvent = (event, queueType) => {
                const slots = getEventAssignmentSlots(event);
                slots.forEach(slot => {
                    if (!slot || slot.currentTeacherId === null || slot.currentTeacherId === undefined) {
                        return;
                    }
                    const teacher = teacherMap.get(slot.currentTeacherId);
                    if (!teacher) {
                        return;
                    }

                    const dateValue = normalizeDateString(event.date);
                    if (queueType === QUEUE_TYPES.TRAINING) {
                        teacher.trainingDuties = (teacher.trainingDuties || 0) + 1;
                        teacher.lastTrainingDate = latestDateString(teacher.lastTrainingDate, dateValue);
                        if (slot.originalTeacherId && slot.originalTeacherId !== slot.currentTeacherId) {
                            teacher.trainingSwapCount = (teacher.trainingSwapCount || 0) + 1;
                        }
                    } else {
                        teacher.dutyDuties = (teacher.dutyDuties || 0) + 1;
                        teacher.lastDutyDate = latestDateString(teacher.lastDutyDate, dateValue);
                        if (slot.originalTeacherId && slot.originalTeacherId !== slot.currentTeacherId) {
                            teacher.dutySwapCount = (teacher.dutySwapCount || 0) + 1;
                        }
                    }
                });
            };

            events.forEach(event => updateFromEvent(event, QUEUE_TYPES.DUTY));
            trainings.forEach(event => updateFromEvent(event, QUEUE_TYPES.TRAINING));

            teachers.forEach(teacher => {
                teacher.totalDuties = (teacher.dutyDuties || 0) + (teacher.trainingDuties || 0);
                teacher.swapCount = (teacher.dutySwapCount || 0) + (teacher.trainingSwapCount || 0);
                const latestOverall = latestDateString(teacher.lastDutyDate, teacher.lastTrainingDate);
                teacher.lastEventDate = latestOverall || normalizeDateString(teacher.lastEventDate);
            });
        }

        function normalizeTeacherId(value) {
            if (value === null || value === undefined) {
                return null;
            }

            if (typeof value === 'number') {
                return value;
            }

            const parsed = Number(value);
            return Number.isFinite(parsed) ? parsed : value;
        }

        function createAssignmentSlotsFromIds(ids = []) {
            return (Array.isArray(ids) ? ids : [])
                .filter(id => id !== null && id !== undefined)
                .map(id => {
                    const normalizedId = normalizeTeacherId(id);
                    return {
                        originalTeacherId: normalizedId,
                        currentTeacherId: normalizedId,
                        substituteTeacherId: null,
                        substitutionType: SUBSTITUTION_TYPES.NONE
                    };
                });
        }

        function ensureEventAssignments(event) {
            if (!event || typeof event !== 'object') {
                return event;
            }

            if (!Array.isArray(event.assignmentSlots) || event.assignmentSlots.length === 0) {
                event.assignmentSlots = createAssignmentSlotsFromIds(event.assignedTeachers);
            } else {
                event.assignmentSlots = event.assignmentSlots.map(slot => {
                    const originalId = normalizeTeacherId(slot.originalTeacherId ?? slot.teacherId ?? slot.currentTeacherId ?? null);
                    const currentId = normalizeTeacherId(slot.currentTeacherId ?? slot.substituteTeacherId ?? originalId);
                    const substituted = originalId && currentId && originalId !== currentId;
                    const slotType = slot.substitutionType || (substituted ? SUBSTITUTION_TYPES.REPLACEMENT : SUBSTITUTION_TYPES.NONE);
                    return {
                        originalTeacherId: originalId,
                        currentTeacherId: currentId,
                        substituteTeacherId: substituted ? currentId : null,
                        substitutionType: substituted ? slotType : SUBSTITUTION_TYPES.NONE
                    };
                });
            }

            event.assignedTeachers = event.assignmentSlots
                .map(slot => slot.currentTeacherId)
                .filter(id => id !== null && id !== undefined);

            return event;
        }

        function getEventAssignmentSlots(event) {
            if (!event) {
                return [];
            }
            ensureEventAssignments(event);
            return event.assignmentSlots;
        }

        function canUseDirectFirebase() {
            const helpersReady = !!(
                window.firebaseDbApi &&
                typeof window.firebaseDbApi.get === 'function'
            );
            const rtdbOk = !!(window.firebaseDatabase && helpersReady);
            const fsOk = !!(typeof firebase !== 'undefined' && firebase && firebase.firestore && helpersReady);
            return rtdbOk || fsOk;
        }

        async function firebaseFetch(path, options = {}) {
            if (!canUseDirectFirebase()) {
                throw new Error('Firebase database is not ready');
            }

            const helpers = window.firebaseDbApi;
            const method = (options.method || 'GET').toUpperCase();

            if (method === 'GET') {
                return helpers.get(path);
            }

            let payload = options.body;
            if (typeof payload === 'string') {
                try {
                    payload = JSON.parse(payload);
                } catch (error) {
                    console.warn('Unable to parse Firebase payload string, sending raw value.');
                }
            }

            if (method === 'PUT') {
                return helpers.put(path, payload);
            }

            if (method === 'PATCH') {
                if (payload && typeof payload === 'object') {
                    return helpers.patch(path, payload);
                }
                throw new Error('PATCH requests require a JSON object payload');
            }

            throw new Error(`Unsupported Firebase method: ${method}`);
        }

        function normalizeFirebaseList(value) {
            if (Array.isArray(value)) {
                return value.filter(item => item !== null && item !== undefined);
            }

            if (value && typeof value === 'object') {
                return Object.keys(value)
                    .sort((a, b) => {
                        const numA = Number(a);
                        const numB = Number(b);
                        const bothNumeric = !Number.isNaN(numA) && !Number.isNaN(numB);
                        return bothNumeric ? numA - numB : a.localeCompare(b);
                    })
                    .map(key => value[key]);
            }

            return [];
        }

        function toggleLoadingOverlay(show) {
            const overlay = document.getElementById('loading-overlay');
            if (!overlay) return;
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        let firebaseStatusTimeout = null;
        let firebaseWriteErrorNotified = false;

        function clearFirebaseStatus() {
            const banner = document.getElementById('firebase-status-banner');
            if (!banner) {
                return;
            }
            banner.classList.add('hidden');
            banner.innerHTML = '';
            if (firebaseStatusTimeout) {
                clearTimeout(firebaseStatusTimeout);
                firebaseStatusTimeout = null;
            }
        }

        function getFirebaseStatusTemplate(type = 'info') {
            const styles = {
                success: {
                    background: 'rgba(136, 168, 42, 0.15)',
                    border: '#88A82A',
                    text: '#21510A',
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'
                },
                warning: {
                    background: 'rgba(196, 233, 248, 0.25)',
                    border: '#55a6c7',
                    text: '#245f7a',
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
                },
                error: {
                    background: 'rgba(137, 77, 91, 0.15)',
                    border: '#894D5B',
                    text: '#5b2d38',
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6.938 4.938l10.124 10.124M17.062 4.938L6.938 15.062"/></svg>'
                },
                info: {
                    background: 'rgba(196, 233, 248, 0.4)',
                    border: '#55a6c7',
                    text: '#245f7a',
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
                }
            };
            return styles[type] || styles.info;
        }

        function showFirebaseStatus(type = 'info', message = '', sticky = false) {
            const banner = document.getElementById('firebase-status-banner');
            if (!banner || !message) {
                clearFirebaseStatus();
                return;
            }

            const template = getFirebaseStatusTemplate(type);
            banner.innerHTML = `
                <div class="status-banner" style="background:${template.background}; color:${template.text}; border:1px solid ${template.border};">
                    ${template.icon}
                    <span>${message}</span>
                </div>
            `;
            banner.classList.remove('hidden');

            if (!sticky) {
                if (firebaseStatusTimeout) {
                    clearTimeout(firebaseStatusTimeout);
                }
                firebaseStatusTimeout = setTimeout(() => {
                    clearFirebaseStatus();
                }, 6000);
            }
        }

        function notifyFirebaseWriteFailure(error) {
            if (firebaseWriteErrorNotified) {
                return;
            }
            firebaseWriteErrorNotified = true;
            const message = `ไม่สามารถบันทึกข้อมูลไปยัง Cloud Firestore: ${extractFirebaseMessage(error)}`;
            showFirebaseStatus('warning', message, true);
        }

        function extractFirebaseMessage(error) {
            if (!error) {
                return 'ไม่ทราบสาเหตุ';
            }
            if (typeof error === 'string') {
                return error;
            }
            if (error.message) {
                return error.message;
            }
            if (error.statusText) {
                return error.statusText;
            }
            if (error.code) {
                return error.code;
            }
            try {
                return JSON.stringify(error);
            } catch (serializationError) {
                return 'ไม่ทราบสาเหตุ';
            }
        }

        function createDefaultTeachers() {
            const baseTeachers = [
                { teacherId: 1, name: 'พรรวินท์', position: 'ครูชำนาญการ', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2024-07-07' },
                { teacherId: 2, name: 'สอาดวรรณ', position: 'ครูชำนาญการพิเศษ', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2024-07-07' },
                { teacherId: 3, name: 'สุทัศษา', position: 'ครูชำนาญการ', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2024-07-07' },
                { teacherId: 4, name: 'กฤษณีนาท', position: 'ครู', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2025-04-01' },
                { teacherId: 5, name: 'ขวัญนาค', position: 'ครูชำนาญการ', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2025-01-08' },
                { teacherId: 6, name: 'นัชนันท์', position: 'ครู', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2024-08-12' },
                { teacherId: 7, name: 'นันทนา', position: 'ครูชำนาญการ', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2025-01-08' },
                { teacherId: 8, name: 'เพ็ญพรรณี', position: 'ครู', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2024-08-12' },
                { teacherId: 9, name: 'วินัย', position: 'ครูชำนาญการพิเศษ', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2025-04-01' },
                { teacherId: 10, name: 'วิลาวรรณ', position: 'ครูชำนาญการ', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2025-01-08' },
                { teacherId: 11, name: 'อรวรรณ', position: 'ครู', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2025-04-01' },
                { teacherId: 12, name: 'อังคณา', position: 'ครูชำนาญการ', totalDuties: 3, queueScore: 45, swapCount: 0, lastEventDate: '2024-08-12' },
                { teacherId: 13, name: 'ภาณุวัฒน์', position: 'ครู', totalDuties: 2, queueScore: 30, swapCount: 0, lastEventDate: '2025-04-01' }
            ];

            return baseTeachers.map(teacher => {
                const dutyScore = typeof teacher.dutyQueueScore === 'number'
                    ? teacher.dutyQueueScore
                    : (typeof teacher.queueScore === 'number' ? teacher.queueScore : 0);
                const trainingScore = typeof teacher.trainingQueueScore === 'number'
                    ? teacher.trainingQueueScore
                    : 0;
                const enriched = {
                    ...teacher,
                    dutyQueueScore: dutyScore,
                    trainingQueueScore: trainingScore,
                    initialDutyQueueScore: dutyScore,
                    initialTrainingQueueScore: trainingScore,
                    queueScore: dutyScore,
                    dutyDuties: teacher.totalDuties ?? 0,
                    trainingDuties: teacher.trainingDuties ?? 0,
                    dutySwapCount: teacher.swapCount ?? 0,
                    trainingSwapCount: teacher.trainingSwapCount ?? 0,
                    lastDutyDate: teacher.lastEventDate || null,
                    lastTrainingDate: teacher.lastTrainingDate || null
                };
                ensureTeacherStats(enriched);
                return enriched;
            });
        }

        function createDefaultEvents() {
            const defaultEvents = [
                {
                    eventId: 1,
                    eventName: 'พิธีเสกน้ำพระพุทธมนต์ศักดิ์สิทธิ์',
                    details: 'พิธีเสกน้ำพระพุทธมนต์เพื่อความเป็นสิริมงคล ร่วมกับชุมชนและผู้ปกครอง',
                    date: '2024-07-07',
                    startTime: '15:00',
                    endTime: '17:00',
                    time: '15:00-17:00',
                    location: 'วัดพระบรมธาตุวรวิหาร ชัยนาท',
                    requiredQuota: 3,
                    assignedTeachers: [1, 2, 3],
                    status: 'assigned'
                },
                {
                    eventId: 2,
                    eventName: 'จุดเทียนชัยถวายพระพร',
                    details: 'พิธีจุดเทียนชัยถวายพระพรและจัดขบวนแสดงความจงรักภักดี',
                    date: '2024-08-12',
                    startTime: '18:30',
                    endTime: '20:00',
                    time: '18:30-20:00',
                    location: 'อาคารวิมลคุณากร',
                    requiredQuota: 5,
                    assignedTeachers: [5, 6, 7, 8, 12],
                    status: 'assigned'
                },
                {
                    eventId: 3,
                    eventName: 'วันคล้ายวันประสูตรสมเด็จพระเจ้าลูกเธอ เจ้าฟ้าสิริวัณณวรี นารีรัตนราชกัญญา',
                    date: '2025-01-08',
                    startTime: '07:00',
                    endTime: '12:00',
                    time: '07:00-12:00',
                    location: 'เขื่อนเรียงหิน',
                    requiredQuota: 4,
                    assignedTeachers: [5, 7, 10, 12],
                    status: 'assigned'
                },
                {
                    eventId: 4,
                    eventName: 'วันคล้ายวันสถาปนากระทรวงศึกษาธิการ 133 ปี',
                    date: '2025-04-01',
                    startTime: '07:00',
                    endTime: '16:00',
                    time: '07:00-16:00',
                    location: 'โรงเรียนหันคาพิทยาคม',
                    requiredQuota: 5,
                    assignedTeachers: [2, 4, 9, 11, 13],
                    status: 'assigned'
                },
                {
                    eventId: 5,
                    eventName: 'วันคล้ายวันพระราชสมภพ ในหลวง',
                    date: '2024-07-28',
                    startTime: '07:00',
                    endTime: '12:00',
                    time: '07:00-12:00',
                    location: 'เขื่อนเรียงหิน',
                    requiredQuota: 5,
                    assignedTeachers: [1, 3, 6, 9, 10],
                    status: 'assigned'
                },
                {
                    eventId: 6,
                    eventName: 'ฟังสวดอภิธรรมสมเด็จพระราชินีนาถ',
                    date: '2024-10-28',
                    startTime: '16:45',
                    endTime: '18:00',
                    time: '16:45-18:00',
                    location: 'วัดพระบรมธาตุวรวิหาร ชัยนาท',
                    requiredQuota: 5,
                    assignedTeachers: [],
                    status: 'pending'
                }
            ];

            defaultEvents.forEach(event => ensureEventAssignments(event));
            return defaultEvents;
        }

        function createDefaultTrainings() {
            const defaults = [
                {
                    trainingId: 1,
                    trainingName: 'อบรม Active Learning สำหรับครูไทย',
                    details: 'หลักสูตรพัฒนาการจัดกิจกรรม Active Learning',
                    startDate: '2025-06-15',
                    endDate: '2025-06-15',
                    date: '2025-06-15',
                    startTime: '09:00',
                    endTime: '16:00',
                    time: '09:00-16:00',
                    location: 'ห้องประชุมใหญ่ อาคารวิมลคุณากร',
                    requiredQuota: 4,
                    assignedTeachers: [],
                    status: 'pending'
                }
            ];

            defaults.forEach(event => ensureEventAssignments(event));
            return defaults;
        }

        function updateSystemLabels() {
            const titleEl = document.getElementById('systemTitle');
            const schoolEl = document.getElementById('schoolName');
            if (titleEl) {
                titleEl.textContent = systemConfig.system_title || defaultConfig.system_title;
            }
            if (schoolEl) {
                schoolEl.textContent = systemConfig.school_name || defaultConfig.school_name;
            }
        }

        function renderAllViews() {
            recomputeTeacherStats();
            renderDashboard();
            renderEventsTable();
            renderTrainingsTable();
            renderTeachersTable();
            renderHistory();
        }

        function buildPersistPayload() {
            return {
                config: systemConfig,
                teachers: teachers,
                events: events,
                trainings: trainings,
                activityLog: activityLog
            };
        }

        async function persistAllDataDirect(payload) {
            const tasks = [];

            if (payload.config !== undefined) {
                tasks.push(firebaseFetch('config', {
                    method: 'PUT',
                    body: JSON.stringify(payload.config)
                }));
            }

            if (payload.teachers !== undefined) {
                tasks.push(firebaseFetch('teachers', {
                    method: 'PUT',
                    body: JSON.stringify(payload.teachers)
                }));
            }

            if (payload.events !== undefined) {
                tasks.push(firebaseFetch('events', {
                    method: 'PUT',
                    body: JSON.stringify(payload.events)
                }));
            }

            if (payload.trainings !== undefined) {
                tasks.push(firebaseFetch('trainings', {
                    method: 'PUT',
                    body: JSON.stringify(payload.trainings)
                }));
            }

            if (payload.activityLog !== undefined) {
                tasks.push(firebaseFetch('activityLog', {
                    method: 'PUT',
                    body: JSON.stringify(payload.activityLog)
                }));
            }

            await Promise.all(tasks);
            firebaseWriteErrorNotified = false;
        }

        function persistAllData() {
            const payload = buildPersistPayload();
            if (canUseDirectFirebase()) {
                return persistAllDataDirect(payload)
                    .catch(error => {
                        console.error('ไม่สามารถบันทึกข้อมูลไปยัง Firebase โดยตรง:', error);
                        notifyFirebaseWriteFailure(error);
                    });
            }

            return Promise.resolve();
        }

        function saveData() {
            if (!dataInitialized) {
                return;
            }

            recomputeTeacherStats();
            const persistResult = persistAllData();
            if (persistResult && typeof persistResult.then === 'function') {
                persistResult.catch(error => console.error('การบันทึกข้อมูลล้มเหลว:', error));
            }
            renderAllViews();
        }

        async function fetchInitialDataDirect() {
            const [config, teacherData, eventData, trainingData, logData] = await Promise.all([
                firebaseFetch('config'),
                firebaseFetch('teachers'),
                firebaseFetch('events'),
                firebaseFetch('trainings'),
                firebaseFetch('activityLog')
            ]);

            return {
                config: config || {},
                teachers: normalizeFirebaseList(teacherData),
                events: normalizeFirebaseList(eventData),
                trainings: normalizeFirebaseList(trainingData),
                activityLog: normalizeFirebaseList(logData)
            };
        }

        async function loadInitialData() {
            toggleLoadingOverlay(true);
            let usedFallbackData = false;

            try {
                if (window.firebaseReadyPromise) {
                    try {
                        await Promise.race([
                            window.firebaseReadyPromise,
                            new Promise(resolve => setTimeout(resolve, 5000))
                        ]);
                    } catch (error) {
                        console.error('Firebase initialization error:', error);
                        showFirebaseStatus('error', `เริ่มต้น Firebase ไม่สำเร็จ: ${extractFirebaseMessage(error)}`, true);
                    }
                }

                try {
                    if (canUseDirectFirebase()) {
                        try {
                            const data = await fetchInitialDataDirect();
                            firebaseDataLoaded = true;
                            applyInitialData(data || {});
                            showFirebaseStatus('success', 'เชื่อมต่อ Cloud Firestore สำเร็จ');
                        } catch (error) {
                            console.error('ไม่สามารถโหลดข้อมูลจาก Firebase โดยตรง:', error);
                            showFirebaseStatus('error', `ไม่สามารถโหลดข้อมูลจาก Cloud Firestore: ${extractFirebaseMessage(error)}`, true);
                            applyInitialData({});
                            usedFallbackData = true;
                        }
                    } else {
                        applyInitialData({});
                        usedFallbackData = true;
                    }
                } finally {
                    if (usedFallbackData && !firebaseDataLoaded) {
                        showFirebaseStatus('info', 'กำลังใช้ข้อมูลตัวอย่างภายในเครื่อง (เชื่อมต่อ Cloud Firestore ไม่สำเร็จ)', true);
                    }

                    dataInitialized = true;
                    renderAllViews();
                    showView('dashboard');
                }

                if (!firebaseDataLoaded && window.firebaseReadyPromise) {
                    window.firebaseReadyPromise
                        .then(() => {
                            if (!firebaseDataLoaded && canUseDirectFirebase()) {
                                fetchInitialDataDirect()
                                    .then(data => {
                                        firebaseDataLoaded = true;
                                        applyInitialData(data || {});
                                        renderAllViews();
                                        showFirebaseStatus('success', 'เชื่อมต่อ Cloud Firestore สำเร็จ');
                                    })
                                    .catch(error => {
                                        console.error('ไม่สามารถซิงค์ข้อมูลจาก Firebase หลังการเริ่มต้น:', error);
                                        showFirebaseStatus('error', `ไม่สามารถซิงค์ข้อมูลจาก Cloud Firestore: ${extractFirebaseMessage(error)}`, true);
                                    });
                            }
                        })
                        .catch(error => {
                            console.error('Firebase readiness promise rejected:', error);
                            showFirebaseStatus('error', `Firebase ไม่พร้อมใช้งาน: ${extractFirebaseMessage(error)}`, true);
                        });
                }
            } finally {
                toggleLoadingOverlay(false);
            }
        }

        function applyInitialData(data) {
            let shouldSeedDefaults = false;

            if (Array.isArray(data.teachers) && data.teachers.length > 0) {
                teachers = data.teachers;
            } else {
                teachers = createDefaultTeachers();
                shouldSeedDefaults = true;
            }

            ensureAllTeacherStats(teachers);
            selectedTeacherId = null;

            if (Array.isArray(data.events) && data.events.length > 0) {
                events = data.events;
            } else {
                events = createDefaultEvents();
                shouldSeedDefaults = true;
            }

            events = (Array.isArray(events) ? events : []).map(event => {
                ensureEventAssignments(event);
                return event;
            });

            if (Array.isArray(data.trainings) && data.trainings.length > 0) {
                trainings = data.trainings;
            } else {
                trainings = createDefaultTrainings();
                shouldSeedDefaults = true;
            }

            trainings = Array.isArray(trainings) ? trainings : [];
            trainings = trainings.map((training, index) => {
                const normalized = { ...training };
                if (normalized.trainingId === undefined || normalized.trainingId === null) {
                    normalized.trainingId = normalized.eventId !== undefined ? normalized.eventId : index + 1;
                }
                if (!normalized.trainingName && normalized.eventName) {
                    normalized.trainingName = normalized.eventName;
                }
                const normalizedStart = normalizeDateString(normalized.startDate || normalized.date);
                const normalizedEnd = normalizeDateString(normalized.endDate || normalized.date || normalizedStart);
                normalized.startDate = normalizedStart || null;
                normalized.endDate = normalizedEnd || normalizedStart || null;
                if (normalized.startDate) {
                    normalized.date = normalized.startDate;
                }
                if (!normalized.time && normalized.startTime && normalized.endTime) {
                    normalized.time = `${normalized.startTime}-${normalized.endTime}`;
                }
                if (!Array.isArray(normalized.assignedTeachers)) {
                    normalized.assignedTeachers = [];
                }
                normalized.status = normalized.status || 'pending';
                ensureEventAssignments(normalized);
                return normalized;
            });

            ensureAllTeacherStats(teachers);
            recomputeTeacherStats();

            activityLog = Array.isArray(data.activityLog) ? data.activityLog : [];
            systemConfig = { ...defaultConfig, ...(data.config || {}) };
            updateSystemLabels();

            if (window.elementSdk && window.elementSdk.config) {
                window.elementSdk.config = { ...systemConfig };
                if (window.elementSdk.element && typeof window.elementSdk.element.onConfigChange === 'function') {
                    window.elementSdk.element.onConfigChange(window.elementSdk.config);
                }
            }

            if (shouldSeedDefaults) {
                const seedResult = persistAllData();
                if (seedResult && typeof seedResult.then === 'function') {
                    seedResult.catch(error => console.error('การบันทึกข้อมูลตั้งต้นล้มเหลว:', error));
                }
            }
        }

        function addActivityLog(type, description, details = '') {
            const log = {
                id: Date.now(),
                type: type,
                description: description,
                details: details,
                timestamp: new Date().toISOString(),
                admin: 'Admin'
            };
            activityLog.unshift(log);
            saveData();
        }

        // Teacher photos mapping
        const teacherPhotos = {
            'ภาณุวัฒน์': 'https://img5.pic.in.th/file/secure-sv1/5e6f1794bb827bebc2e65ada722df90a.jpg',
            'นัชนันท์': 'https://img5.pic.in.th/file/secure-sv1/1af9893f65630d5e1ba39c3784d1cde0.png',
            'นันทนา': 'https://img5.pic.in.th/file/secure-sv1/34093e3c53533ba2d0f4e017dc519b19.png',
            'กฤษณีนาท': 'https://img2.pic.in.th/pic/4427e7666f2d9b21acd3d055da5e3cc1.png',
            'พรรวินท์': 'https://img2.pic.in.th/pic/41dcc8930f131834415adc9b313b8c32.png',
            'ขวัญนาค': 'https://img2.pic.in.th/pic/6c7baf1df19706aaee0d4326aad10e02.png',
            'อรวรรณ': 'https://img5.pic.in.th/file/secure-sv1/ba991bebe77c479877912bb4c8c41120.png',
            'อังคณา': 'https://img2.pic.in.th/pic/10653004a11f24a845d64c4f0ad4ff2a.png',
            'สุทัศษา': 'https://img5.pic.in.th/file/secure-sv1/f2c5119a8b036412489618b7cf3b9f70.png',
            'สอาดวรรณ': 'https://img2.pic.in.th/pic/289ed6001a81b79e8d4ab6378fd7f1a6.png',
            'วินัย': 'https://img5.pic.in.th/file/secure-sv1/b50541ebf13b24546c51e4b928a641b1.png',
            'วิลาวรรณ': 'https://img2.pic.in.th/pic/780e5fa00b1a4787c0eb2a3d56e08f8c.png',
            'เพ็ญพรรณี': 'https://img5.pic.in.th/file/secure-sv1/f3f6d80d0a4047e1d97b05fe6a78c0f1.png'
        };

        function getTeacherPhoto(name) {
            return teacherPhotos[name] || null;
        }

        function createTeacherAvatar(teacher, large = false) {
            const photo = teacher ? getTeacherPhoto(teacher.name) : null;
            const avatarClass = large ? 'teacher-avatar-large' : 'teacher-avatar';
            if (photo) {
                return `<div class="${avatarClass}">
                    <img src="${photo}" alt="${teacher.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='${teacher.name.charAt(0)}';">
                </div>`;
            }

            if (teacher && teacher.name) {
                return `<div class="${avatarClass}">${teacher.name.charAt(0)}</div>`;
            }

            return `<div class="${avatarClass}">?</div>`;
        }

        function formatDateThai(dateStr) {
            if (!dateStr) {
                return '-';
            }

            const date = new Date(dateStr);
            if (Number.isNaN(date.getTime())) {
                return '-';
            }

            const buddhistYear = date.getFullYear() + 543;
            const months = [
                'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
            ];
            return `${date.getDate()} ${months[date.getMonth()]} ${buddhistYear}`;
        }

        function formatDateRangeThai(startDate, endDate) {
            const normalizedStart = normalizeDateString(startDate);
            const normalizedEnd = normalizeDateString(endDate);

            if (!normalizedStart && !normalizedEnd) {
                return '-';
            }

            if (normalizedStart && normalizedEnd) {
                if (normalizedStart === normalizedEnd) {
                    return formatDateThai(normalizedStart);
                }
                return `${formatDateThai(normalizedStart)} - ${formatDateThai(normalizedEnd)}`;
            }

            return formatDateThai(normalizedStart || normalizedEnd);
        }

        function formatDateTimeThai(value) {
            if (!value) {
                return '-';
            }

            const date = value instanceof Date ? value : new Date(value);
            if (Number.isNaN(date.getTime())) {
                return '-';
            }

            return date.toLocaleString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getTeacherById(id) {
            return teachers.find(t => t.teacherId === id);
        }

        function getEventById(id, queueType = QUEUE_TYPES.DUTY) {
            const collection = getQueueEvents(queueType);
            if (queueType === QUEUE_TYPES.TRAINING) {
                return collection.find(e => e.trainingId === id) || null;
            }
            return collection.find(e => e.eventId === id) || null;
        }

        // ฟังก์ชันสำหรับหาครูที่ควรได้รับงาน/อบรมต่อไป (เรียงตามคะแนนและประวัติ)
        function getNextQueueTeachers(limit = 13, queueType = QUEUE_TYPES.DUTY) {
            return [...teachers]
                .map(teacher => {
                    ensureTeacherStats(teacher);
                    return teacher;
                })
                .sort((a, b) => compareTeachersForQueue(a, b, queueType))
                .slice(0, limit);
        }

        function compareTeachersForQueue(a, b, queueType = QUEUE_TYPES.DUTY) {
            const scoreA = getTeacherQueueScore(a, queueType);
            const scoreB = getTeacherQueueScore(b, queueType);

            if (scoreA !== scoreB) {
                return scoreA - scoreB;
            }

            const typeDateA = safeDate(queueType === QUEUE_TYPES.TRAINING ? a.lastTrainingDate : a.lastDutyDate) || new Date(0);
            const typeDateB = safeDate(queueType === QUEUE_TYPES.TRAINING ? b.lastTrainingDate : b.lastDutyDate) || new Date(0);

            if (typeDateA.getTime() !== typeDateB.getTime()) {
                return typeDateA - typeDateB;
            }

            const overallDateA = safeDate(a.lastEventDate) || new Date(0);
            const overallDateB = safeDate(b.lastEventDate) || new Date(0);

            if (overallDateA.getTime() !== overallDateB.getTime()) {
                return overallDateA - overallDateB;
            }

            return (a.teacherId || 0) - (b.teacherId || 0);
        }

        function buildNextQueueSection(queueType, queueTeachers) {
            const isTraining = queueType === QUEUE_TYPES.TRAINING;
            const label = isTraining ? 'คิวอบรม' : 'คิวออกงาน';
            const accentBg = isTraining ? 'rgba(225, 177, 193, 0.55)' : 'rgba(196, 233, 248, 0.55)';
            const accentText = isTraining ? '#5b2d38' : '#2a5a6f';
            const resetButtonHtml = `<button type="button" class="queue-reset-button" onclick="confirmResetQueue('${queueType}')"><span>♻️</span>รีเซ็ตคิวนี้</button>`;

            if (!queueTeachers || queueTeachers.length === 0) {
                return `
                    <div class="space-y-3">
                        <div class="flex flex-wrap items-center justify-between gap-2 text-xs font-semibold text-gray-700">
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center px-3 py-1 rounded-full" style="background:${accentBg}; color:${accentText};">${label}</span>
                                <span class="text-[11px] text-gray-500">ยังไม่มีข้อมูลครูในแถวนี้</span>
                            </div>
                            ${resetButtonHtml}
                        </div>
                        <p class="text-gray-500 text-center py-4 text-sm">ยังไม่มีข้อมูลครู</p>
                    </div>
                `;
            }

            const cardsHtml = queueTeachers
                .map((teacher, index) => renderNextQueueCard(teacher, index, queueType))
                .join('');

            return `
                <div class="space-y-3">
                    <div class="flex flex-wrap items-center justify-between gap-2 text-xs text-gray-600">
                        <div class="flex items-center gap-2">
                            <span class="inline-flex items-center px-3 py-1 rounded-full font-semibold" style="background:${accentBg}; color:${accentText};">${label}</span>
                            <span>เรียงตามคะแนน${isTraining ? 'อบรม' : 'ออกงาน'}ล่าสุด</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span>${queueTeachers.length} คน</span>
                            ${resetButtonHtml}
                        </div>
                    </div>
                    <div class="next-queue-grid">
                        ${cardsHtml}
                    </div>
                </div>
            `;
        }

        function confirmResetQueue(queueType) {
            const isTraining = queueType === QUEUE_TYPES.TRAINING;
            const label = isTraining ? 'คิวอบรม' : 'คิวออกงาน';
            const confirmMessage = `คุณต้องการรีเซ็ต${label}ทั้งหมดให้กลับเป็นค่าเริ่มต้นหรือไม่?\nระบบจะล้างรายชื่อครูที่ถูกจัดคิวแล้วและคืนค่าคะแนนคิวเริ่มต้น`;

            if (!window.confirm(confirmMessage)) {
                return;
            }

            resetQueueAssignments(queueType);
        }

        function resetQueueAssignments(queueType = QUEUE_TYPES.DUTY) {
            const isTraining = queueType === QUEUE_TYPES.TRAINING;
            const label = isTraining ? 'การอบรม' : 'การออกงาน';

            const sourceCollection = getQueueEvents(queueType);
            const collection = Array.isArray(sourceCollection) ? sourceCollection : [];
            if (!Array.isArray(sourceCollection)) {
                setQueueEvents(queueType, []);
            }

            collection.forEach(item => {
                if (!item) {
                    return;
                }
                item.assignmentSlots = [];
                item.assignedTeachers = [];
                item.status = 'pending';
            });
            setQueueEvents(queueType, collection);

            teachers.forEach(teacher => {
                ensureTeacherStats(teacher);
                if (isTraining) {
                    teacher.trainingDuties = 0;
                    teacher.trainingSwapCount = 0;
                    teacher.trainingQueueScore = Number.isFinite(Number(teacher.initialTrainingQueueScore))
                        ? Number(teacher.initialTrainingQueueScore)
                        : 0;
                    teacher.lastTrainingDate = null;
                } else {
                    teacher.dutyDuties = 0;
                    teacher.dutySwapCount = 0;
                    teacher.dutyQueueScore = Number.isFinite(Number(teacher.initialDutyQueueScore))
                        ? Number(teacher.initialDutyQueueScore)
                        : 0;
                    teacher.lastDutyDate = null;
                }
                teacher.totalDuties = (teacher.dutyDuties || 0) + (teacher.trainingDuties || 0);
                teacher.swapCount = (teacher.dutySwapCount || 0) + (teacher.trainingSwapCount || 0);
                teacher.queueScore = teacher.dutyQueueScore;
                teacher.lastEventDate = latestDateString(teacher.lastDutyDate, teacher.lastTrainingDate);
            });

            currentNextQueueSelection = null;
            renderNextQueueInsight(null, null);

            activityLog.unshift({
                id: Date.now(),
                type: isTraining ? 'training-queue-reset' : 'event-queue-reset',
                description: `รีเซ็ตการจัดคิว${label}ทั้งหมด`,
                details: `ล้างข้อมูลการจัดคิว${label}และคืนค่าคะแนนให้เป็นค่าเริ่มต้น`,
                timestamp: new Date().toISOString(),
                admin: 'Admin'
            });

            showFirebaseStatus('success', `รีเซ็ต${label}สำเร็จ`, false);
            saveData();
        }

        function renderNextQueueCard(teacher, index, queueType) {
            if (!teacher) {
                return '';
            }

            const rankIcon = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '🎯';
            const dutyClass = 'queue-mini-stat is-duty' + (queueType === QUEUE_TYPES.DUTY ? ' is-focus' : '');
            const trainingClass = 'queue-mini-stat is-training' + (queueType === QUEUE_TYPES.TRAINING ? ' is-focus' : '');
            const dutyCount = teacher.dutyDuties ?? 0;
            const trainingCount = teacher.trainingDuties ?? 0;
            const swapCount = teacher.swapCount ?? 0;
            const lastKeyDate = queueType === QUEUE_TYPES.TRAINING
                ? (teacher.lastTrainingDate || teacher.lastEventDate)
                : (teacher.lastDutyDate || teacher.lastEventDate);
            const lastDateText = lastKeyDate ? `ล่าสุด ${formatDateThai(lastKeyDate)}` : '';
            const queueScore = getTeacherQueueScore(teacher, queueType);
            const scoreLabel = queueType === QUEUE_TYPES.TRAINING ? 'คะแนนอบรม' : 'คะแนนออกงาน';
            const queueLabelShort = queueType === QUEUE_TYPES.TRAINING ? 'อบรม' : 'ออกงาน';

            return `
                <div class="next-queue-card" data-teacher-id="${teacher.teacherId}" data-queue-type="${queueType}" onclick="handleNextQueueCardClick(${teacher.teacherId}, '${queueType}')">
                    <div class="w-full flex items-center justify-between text-[11px] text-gray-500 font-semibold">
                        <span class="rank-badge">${rankIcon} #${index + 1}</span>
                        <span class="uppercase tracking-wide">${queueLabelShort}</span>
                    </div>
                    ${createTeacherAvatar(teacher, true)}
                    <div class="text-center space-y-1 w-full">
                        <h4 class="font-semibold text-sm text-gray-900 leading-tight">${teacher.name}</h4>
                        <p class="text-[11px] text-gray-500 leading-tight">${teacher.position}</p>
                        ${lastDateText ? `<p class="text-[10px] text-gray-400 leading-tight">${lastDateText}</p>` : ''}
                        <p class="text-xs font-semibold" style="color:#5b2d38;">${scoreLabel} ${queueScore}</p>
                    </div>
                    <div class="w-full space-y-1">
                        <div class="${dutyClass}"><span>งาน</span><span class="font-semibold text-gray-700">${dutyCount}</span></div>
                        <div class="${trainingClass}"><span>อบรม</span><span class="font-semibold text-gray-700">${trainingCount}</span></div>
                        <div class="queue-mini-stat is-sub"><span>แทนรวม</span><span class="font-semibold text-gray-700">${swapCount}</span></div>
                    </div>
                </div>
            `;
        }

        function handleNextQueueCardClick(teacherId, queueType) {
            currentNextQueueSelection = { teacherId, queueType };
            highlightNextQueueSelection();
            renderNextQueueInsightFromSelection();
        }

        function highlightNextQueueSelection() {
            const cards = document.querySelectorAll('.next-queue-card');
            cards.forEach(card => {
                const cardTeacherId = parseInt(card.getAttribute('data-teacher-id'), 10);
                const cardType = card.getAttribute('data-queue-type');
                if (currentNextQueueSelection && cardTeacherId === currentNextQueueSelection.teacherId && cardType === currentNextQueueSelection.queueType) {
                    card.classList.add('is-active');
                } else {
                    card.classList.remove('is-active');
                }
            });
        }

        function renderNextQueueInsightFromSelection() {
            if (!currentNextQueueSelection) {
                renderNextQueueInsight(null, null);
                return;
            }
            const teacher = getTeacherById(currentNextQueueSelection.teacherId);
            if (!teacher) {
                currentNextQueueSelection = null;
                renderNextQueueInsight(null, null);
                return;
            }
            renderNextQueueInsight(teacher, currentNextQueueSelection.queueType);
        }

        function renderNextQueueInsight(teacher, queueType) {
            const container = document.getElementById('next-queue-insight');
            if (!container) {
                return;
            }

            if (!teacher || !queueType) {
                container.classList.add('hidden');
                container.innerHTML = '';
                return;
            }

            ensureTeacherStats(teacher);
            const queueLabel = queueType === QUEUE_TYPES.TRAINING ? 'คิวอบรม' : 'คิวออกงาน';
            const queueScore = getTeacherQueueScore(teacher, queueType);
            const otherScore = getTeacherQueueScore(teacher, queueType === QUEUE_TYPES.TRAINING ? QUEUE_TYPES.DUTY : QUEUE_TYPES.TRAINING);
            const rankingList = [...teachers].sort((a, b) => compareTeachersForQueue(a, b, queueType));
            const rankIndex = rankingList.findIndex(item => item.teacherId === teacher.teacherId);
            const rank = rankIndex >= 0 ? rankIndex + 1 : '-';
            const totalCount = rankingList.length || '-';

            const lastDutyText = teacher.lastDutyDate ? formatDateThai(teacher.lastDutyDate) : '-';
            const lastTrainingText = teacher.lastTrainingDate ? formatDateThai(teacher.lastTrainingDate) : '-';

            const relatedEvents = events
                .filter(event => Array.isArray(event.assignedTeachers) && event.assignedTeachers.includes(teacher.teacherId))
                .sort((a, b) => (safeDate(b.date) || new Date(0)) - (safeDate(a.date) || new Date(0)))
                .slice(0, 2);

            const relatedTrainings = trainings
                .filter(event => Array.isArray(event.assignedTeachers) && event.assignedTeachers.includes(teacher.teacherId))
                .sort((a, b) => (safeDate(b.startDate || b.date) || new Date(0)) - (safeDate(a.startDate || a.date) || new Date(0)))
                .slice(0, 2);

            const relatedHtml = queueType === QUEUE_TYPES.TRAINING ? relatedTrainings : relatedEvents;
            const relatedItemsHtml = relatedHtml.length > 0
                ? relatedHtml.map(item => {
                    const isTraining = queueType === QUEUE_TYPES.TRAINING;
                    const displayName = isTraining ? (item.trainingName || item.eventName) : item.eventName;
                    const dateDisplay = isTraining
                        ? formatDateRangeThai(item.startDate || item.date, item.endDate || item.date)
                        : formatDateThai(item.date);
                    const statusText = item.status === 'assigned' ? 'จัดคิวแล้ว'
                        : item.status === 'completed' ? 'เสร็จสิ้น' : 'รอจัดคิว';
                    return `
                        <li class="flex justify-between items-center text-xs bg-white border border-gray-200 rounded-lg px-3 py-2">
                            <div>
                                <p class="font-semibold text-gray-800">${displayName}</p>
                                <p class="text-gray-500">${dateDisplay} • ${item.time || '-'}</p>
                            </div>
                            <span class="text-[11px] text-gray-500">${statusText}</span>
                        </li>
                    `;
                }).join('')
                : '<li class="text-xs text-gray-500">ยังไม่มีประวัติที่เกี่ยวข้อง</li>';

            container.classList.remove('hidden');
            container.innerHTML = `
                <div class="card p-4">
                    <div class="flex items-center gap-4">
                        ${createTeacherAvatar(teacher, true)}
                        <div class="flex-1">
                            <div class="flex flex-wrap items-center justify-between gap-2">
                                <div>
                                    <h4 class="text-lg font-bold text-gray-800">${teacher.name}</h4>
                                    <p class="text-sm text-gray-600">${teacher.position}</p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-semibold" style="background: rgba(137,77,91,0.1); color:#5b2d38;">${queueLabel} ลำดับ ${rank}/${totalCount}</span>
                            </div>
                            <div class="flex flex-wrap gap-2 mt-3">
                                <span class="queue-score">${queueLabel} ${queueScore}</span>
                                <span class="queue-score" style="background: rgba(36,95,122,0.1); color:#245f7a;">${queueType === QUEUE_TYPES.TRAINING ? 'คะแนนออกงาน' : 'คะแนนอบรม'} ${otherScore}</span>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4 text-sm text-gray-600">
                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="font-semibold text-gray-700 mb-1">สถิติรวม</p>
                            <p>ออกงานทั้งหมด: <strong>${teacher.dutyDuties ?? 0}</strong></p>
                            <p>อบรมทั้งหมด: <strong>${teacher.trainingDuties ?? 0}</strong></p>
                            <p>การแทนรวม: <strong>${teacher.swapCount ?? 0}</strong> (งาน ${teacher.dutySwapCount ?? 0} | อบรม ${teacher.trainingSwapCount ?? 0})</p>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="font-semibold text-gray-700 mb-1">ประวัติล่าสุด</p>
                            <p>ออกงานล่าสุด: <strong>${lastDutyText}</strong></p>
                            <p>อบรมล่าสุด: <strong>${lastTrainingText}</strong></p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-sm font-semibold text-gray-700 mb-2">ประวัติที่เกี่ยวข้อง (${queueLabel})</p>
                        <ul class="space-y-2">${relatedItemsHtml}</ul>
                    </div>
                </div>
            `;
        }

        // Navigation
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            
            // Show selected view
            document.getElementById(`${viewName}-view`).classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
            
            // Refresh view data
            switch(viewName) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'events':
                    renderEventsTable();
                    break;
                case 'trainings':
                    renderTrainingsTable();
                    break;
                case 'teachers':
                    renderTeachersTable();
                    break;
                case 'history':
                    renderHistory();
                    break;
            }
        }

        // Dashboard rendering
        function renderDashboard() {
            const totalEvents = events.length;
            const assignedEvents = events.filter(e => e.status === 'assigned').length;
            const pendingEvents = events.filter(e => e.status === 'pending').length;
            const totalTeachers = teachers.length;

            document.getElementById('total-events').textContent = totalEvents;
            document.getElementById('assigned-events').textContent = assignedEvents;
            document.getElementById('pending-events').textContent = pendingEvents;
            document.getElementById('total-teachers').textContent = totalTeachers;

            // Render latest event (most recent assigned event)
            const latestEvent = events
                .filter(e => e.status === 'assigned')
                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

            const latestEventHtml = latestEvent ? `
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <h4 class="font-medium text-gray-800 mb-2">${latestEvent.eventName}</h4>
                    <p class="text-sm text-gray-600 mb-3">${formatDateThai(latestEvent.date)} • ${latestEvent.time}</p>
                    <p class="text-sm text-gray-600 mb-3">📍 ${latestEvent.location}</p>
                    
                    <div class="mb-3">
                        <p class="text-sm font-medium text-gray-700 mb-2">ครูที่ออกงาน:</p>
                        <div class="grid grid-cols-2 gap-2">
                            ${latestEvent.assignedTeachers.map(id => {
                                const teacher = getTeacherById(id);
                                return `
                                    <div class="flex items-center bg-white p-2 rounded border">
                                        ${createTeacherAvatar(teacher)}
                                        <span class="ml-2 text-sm font-medium">${teacher.name}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            ` : '<p class="text-gray-500 text-center py-8">ยังไม่มีงานที่จัดคิวแล้ว</p>';

            document.getElementById('latest-event').innerHTML = latestEventHtml;

            // Render next queue split by duty/training rows
            const dutyQueueTeachers = getNextQueueTeachers(13, QUEUE_TYPES.DUTY);
            const trainingQueueTeachers = getNextQueueTeachers(13, QUEUE_TYPES.TRAINING);
            const divider = '<div class="border-t border-dashed border-rose-200 my-4"></div>';

            document.getElementById('next-queue').innerHTML = [
                buildNextQueueSection(QUEUE_TYPES.DUTY, dutyQueueTeachers),
                buildNextQueueSection(QUEUE_TYPES.TRAINING, trainingQueueTeachers)
            ].join(divider);
            highlightNextQueueSelection();
            renderNextQueueInsightFromSelection();

            // Render urgent events (pending events sorted by date)
            const urgentEvents = events
                .filter(e => e.status === 'pending')
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(0, 5);

            const urgentEventsHtml = urgentEvents.length > 0 ? urgentEvents.map(event => `
                <div class="flex justify-between items-center p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div class="flex-1">
                        <p class="font-medium text-gray-800">${event.eventName}</p>
                        <p class="text-sm text-gray-600">${formatDateThai(event.date)} • ${event.time}</p>
                        ${event.assignedTeachers.length > 0 ? `
                            <div class="flex items-center mt-2">
                                <span class="text-xs text-gray-500 mr-2">ครูที่ได้รับมอบหมาย:</span>
                                <div class="flex -space-x-1">
                                    ${event.assignedTeachers.slice(0, 3).map(id => {
                                        const teacher = getTeacherById(id);
                                        return createTeacherAvatar(teacher);
                                    }).join('')}
                                    ${event.assignedTeachers.length > 3 ? `<div class="teacher-avatar bg-gray-400">+${event.assignedTeachers.length - 3}</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <button onclick="openAutoAssignModal(${event.eventId}, '${QUEUE_TYPES.DUTY}')" class="btn-primary text-sm">
                        จัดคิว
                    </button>
                </div>
            `).join('') : '<p class="text-gray-500 text-center py-4">ไม่มีงานที่ต้องจัดคิวเร่งด่วน</p>';

            document.getElementById('urgent-events').innerHTML = urgentEventsHtml;

            // Render top priority teachers (lowest score first)
            const topTeachers = [...teachers]
                .map(ensureTeacherStats)
                .sort((a, b) => compareTeachersForQueue(a, b, QUEUE_TYPES.DUTY))
                .slice(0, 5);

            const topTeachersHtml = topTeachers.map(teacher => `
                <div class="flex justify-between items-center p-3 rounded-lg" style="background: rgba(137, 77, 91, 0.08); border: 1px solid rgba(137, 77, 91, 0.2);">
                    <div class="flex items-center">
                        ${createTeacherAvatar(teacher)}
                        <div class="ml-3">
                            <p class="font-medium text-gray-800">${teacher.name}</p>
                            <p class="text-sm text-gray-600">${teacher.position}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="queue-score">ออกงาน ${getTeacherQueueScore(teacher, QUEUE_TYPES.DUTY)}</div>
                        <div class="queue-score mt-1" style="background: rgba(36, 95, 122, 0.1); color: #245f7a;">อบรม ${getTeacherQueueScore(teacher, QUEUE_TYPES.TRAINING)}</div>
                        <p class="text-xs text-gray-600 mt-1">งาน ${teacher.dutyDuties ?? 0} | อบรม ${teacher.trainingDuties ?? 0}</p>
                    </div>
                </div>
            `).join('');

            document.getElementById('top-queue-teachers').innerHTML = topTeachersHtml;
        }

        function renderQueueCards(queueType, containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                return;
            }

            const queueEvents = [...getQueueEvents(queueType)].sort((a, b) => new Date(b.date) - new Date(a.date));
            if (queueEvents.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-6">ยังไม่มีข้อมูลกิจกรรม</p>';
                return;
            }

            const queueLabel = getQueueDisplayName(queueType);

            const cardsHtml = queueEvents.map(event => {
                const statusClass = event.status === 'assigned' ? 'status-assigned'
                    : event.status === 'completed' ? 'status-completed'
                    : 'status-pending';
                const statusText = event.status === 'assigned' ? 'จัดคิวแล้ว'
                    : event.status === 'completed' ? 'เสร็จสิ้น'
                    : 'รอจัดคิว';
                const statusIcon = event.status === 'assigned' ? '✅'
                    : event.status === 'completed' ? '🎉'
                    : '⏳';

                const assignmentSlots = getEventAssignmentSlots(event);
                const currentAssignments = assignmentSlots.filter(slot => slot.currentTeacherId !== null && slot.currentTeacherId !== undefined);
                const assignedCount = currentAssignments.length;

                const queueBadge = queueType === QUEUE_TYPES.TRAINING
                    ? '<span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-[#E1B1C1] text-[#5b2d38] mb-2">คิวอบรม</span>'
                    : '<span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-[#C4E9F8] text-[#245f7a] mb-2">คิวออกงาน</span>';

                return `
                    <div class="card p-6 hover:shadow-lg transition-all duration-300">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                ${queueBadge}
                                <h3 class="font-semibold text-gray-800 text-lg mb-2">${getQueueItemName(event, queueType)}</h3>
                                <div class="space-y-1 text-sm text-gray-600">
                                    <p class="flex items-center">
                                        <span class="mr-2">📅</span>${formatDateThai(event.date)}
                                    </p>
                                    <p class="flex items-center">
                                        <span class="mr-2">⏰</span>${event.time}
                                    </p>
                                    <p class="flex items-center">
                                        <span class="mr-2">📍</span>${event.location}
                                    </p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="status-badge ${statusClass} flex items-center">
                                    <span class="mr-1">${statusIcon}</span>${statusText}
                                </span>
                                <p class="text-sm text-gray-500 mt-2">${assignedCount}/${event.requiredQuota} คน</p>
                            </div>
                        </div>

                        ${currentAssignments.length > 0 ? `
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-700 mb-3">ครูที่ได้รับมอบหมาย:</p>
                                <div class="flex flex-wrap gap-2">
                                    ${currentAssignments.map(slot => {
                                        const currentTeacher = getTeacherById(slot.currentTeacherId);
                                        const originalTeacher = slot.originalTeacherId ? getTeacherById(slot.originalTeacherId) : null;
                                        const isSubstituted = slot.originalTeacherId && slot.currentTeacherId && slot.originalTeacherId !== slot.currentTeacherId;
                                        const substitutionType = slot.substitutionType || (isSubstituted ? SUBSTITUTION_TYPES.REPLACEMENT : SUBSTITUTION_TYPES.NONE);
                                        const currentName = currentTeacher ? currentTeacher.name : 'ไม่พบข้อมูล';
                                        const originalName = originalTeacher ? originalTeacher.name : 'ไม่ทราบ';
                                        const scoreLabel = queueType === QUEUE_TYPES.TRAINING ? 'คะแนนอบรม' : 'คะแนนออกงาน';
                                        const scoreValue = currentTeacher ? getTeacherQueueScore(currentTeacher, queueType) : '-';
                                        let detailHtml = '<p class="text-xs text-gray-500">คิวเดิม</p>';
                                        if (isSubstituted) {
                                            if (substitutionType === SUBSTITUTION_TYPES.SWAP) {
                                                detailHtml = `<p class="text-xs text-[#21510A] font-semibold">แลกกับ ${originalName}</p>`;
                                            } else {
                                                detailHtml = `<p class="text-xs text-[#894D5B] font-medium">แทนคิวของ ${originalName}</p>`;
                                            }
                                        }
                                        return `
                                            <div class="flex items-center bg-gray-50 p-2 rounded-lg border ${isSubstituted ? 'border-[#E1B1C1]' : 'border-transparent'}">
                                                ${createTeacherAvatar(currentTeacher)}
                                                <div class="ml-2">
                                                    <p class="font-medium text-gray-800 text-sm">${currentName}</p>
                                                    ${detailHtml}
                                                    <div class="queue-score text-xs mt-1">${scoreLabel} ${scoreValue}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <p class="text-sm text-yellow-700 text-center">ยังไม่ได้จัดคิว</p>
                            </div>
                        `}

                        <div class="flex flex-wrap gap-2">
                            <button onclick="editEvent(${event.eventId}, '${queueType}')" class="btn-primary text-sm flex-1 min-w-[140px]">
                                <span class="mr-1">✏️</span>แก้ไข
                            </button>
                            ${event.status === 'pending'
                                ? `<button onclick="openAutoAssignModal(${event.eventId}, '${queueType}')" class="btn-success text-sm flex-1 min-w-[140px]">
                                    <span class="mr-1">🎯</span>จัดคิว
                                </button>`
                                : `<button onclick="openSubstitutionModal(${event.eventId}, '${queueType}')" class="btn-danger text-sm flex-1 min-w-[140px]">
                                    <span class="mr-1">🔄</span>แทน
                                </button>`
                            }
                            <button onclick="deleteQueueItem(${event.eventId}, '${queueType}')" class="btn-delete text-sm flex-1 min-w-[140px]">
                                <span class="mr-1">🗑️</span>ลบ
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = cardsHtml;
        }

        function renderEventsTable() {
            renderQueueCards(QUEUE_TYPES.DUTY, 'events-cards');
        }

        function renderTrainingsTable() {
            const sortedTrainings = [...trainings].sort((a, b) => {
                const bDate = safeDate(b.startDate || b.date) || new Date(0);
                const aDate = safeDate(a.startDate || a.date) || new Date(0);
                return bDate - aDate;
            });
            const container = document.getElementById('trainings-cards');
            if (!container) {
                return;
            }

            const html = sortedTrainings.map(tr => {
                const dateRange = formatDateRangeThai(tr.startDate || tr.date, tr.endDate || tr.date);
                const statusClass = tr.status === 'assigned' ? 'status-assigned'
                    : tr.status === 'completed' ? 'status-completed' : 'status-pending';
                const statusText = tr.status === 'assigned' ? 'จัดคิวแล้ว'
                    : tr.status === 'completed' ? 'เสร็จสิ้น' : 'รอจัดคิว';
                const statusIcon = tr.status === 'assigned' ? '✅'
                    : tr.status === 'completed' ? '🎉' : '⏳';

                const assignedTeachers = Array.isArray(tr.assignedTeachers) ? tr.assignedTeachers : [];

                return `
                    <div class="card p-6 hover:shadow-lg transition-all duration-300">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800 text-lg mb-2">${tr.trainingName}</h3>
                                <div class="space-y-1 text-sm text-gray-600">
                                    <p class="flex items-center"><span class="mr-2">📅</span>${dateRange}</p>
                                    <p class="flex items-center"><span class="mr-2">⏰</span>${tr.time}</p>
                                    <p class="flex items-center"><span class="mr-2">📍</span>${tr.location}</p>
                                </div>
                                ${callToAction}
                            </div>
                            <div class="text-right">
                                <span class="status-badge ${statusClass} flex items-center">
                                    <span class="mr-1">${statusIcon}</span>${statusText}
                                </span>
                                <p class="text-sm text-gray-500 mt-2">${assignedTeachers.length}/${tr.requiredQuota} คน</p>
                            </div>
                        </div>

                        ${assignedTeachers.length > 0 ? `
                            <div class="mb-4">
                                <p class="text-sm font-medium text-gray-700 mb-3">ครูที่ได้รับมอบหมาย:</p>
                                <div class="flex flex-wrap gap-2">
                                    ${assignedTeachers.map(id => {
                                        const teacher = getTeacherById(id);
                                        const trainingScore = teacher ? getTeacherQueueScore(teacher, QUEUE_TYPES.TRAINING) : '-';
                                        return `
                                            <div class="flex items-center bg-gray-50 p-2 rounded-lg">
                                                ${createTeacherAvatar(teacher)}
                                                <div class="ml-2">
                                                    <p class="font-medium text-gray-800 text-sm">${teacher?.name || 'ไม่พบข้อมูล'}</p>
                                                    <div class="queue-score text-xs">คะแนนอบรม ${trainingScore}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <p class="text-sm text-yellow-700 text-center">ยังไม่ได้จัดคิว</p>
                            </div>
                        `}

                        <div class="flex flex-wrap gap-2">
                            <button onclick="editTraining(${tr.trainingId})" class="btn-primary text-sm flex-1 min-w-[140px]"><span class="mr-1">✏️</span>แก้ไข</button>
                            ${tr.status === 'pending'
                                ? `<button onclick="openTrainingAutoAssignModal(${tr.trainingId})" class='btn-success text-sm flex-1 min-w-[140px]'><span class="mr-1">🎯</span>จัดคิว</button>`
                                : `<button onclick="openTrainingSubstitutionModal(${tr.trainingId})" class='btn-danger text-sm flex-1 min-w-[140px]'><span class="mr-1">🔄</span>แทน</button>`}
                            <button onclick="deleteQueueItem(${tr.trainingId}, '${QUEUE_TYPES.TRAINING}')" class="btn-delete text-sm flex-1 min-w-[140px]"><span class="mr-1">🗑️</span>ลบ</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html || '<p class="text-gray-500 text-center py-8">ยังไม่มีข้อมูลการอบรม</p>';
        }

        // Teachers table rendering
        function renderTeachersTable() {
            const tbody = document.getElementById('teachers-table-body');
            if (!tbody) {
                return;
            }

            const sortedTeachers = [...teachers]
                .map(teacher => {
                    ensureTeacherStats(teacher);
                    return teacher;
                })
                .sort((a, b) => {
                    const dutyDiff = getTeacherQueueScore(a, QUEUE_TYPES.DUTY) - getTeacherQueueScore(b, QUEUE_TYPES.DUTY);
                    if (dutyDiff !== 0) {
                        return dutyDiff;
                    }
                    const trainingDiff = getTeacherQueueScore(a, QUEUE_TYPES.TRAINING) - getTeacherQueueScore(b, QUEUE_TYPES.TRAINING);
                    if (trainingDiff !== 0) {
                        return trainingDiff;
                    }
                    const dateA = a.lastEventDate ? new Date(a.lastEventDate) : new Date(0);
                    const dateB = b.lastEventDate ? new Date(b.lastEventDate) : new Date(0);
                    return dateA - dateB;
                })
                .map((teacher, index) => ({ ...teacher, queueRank: index + 1 }));

            if (sortedTeachers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-6 text-gray-500">ยังไม่มีข้อมูลครู</td></tr>';
                renderTeacherDetail(null);
                return;
            }

            if (!selectedTeacherId || !sortedTeachers.some(t => t.teacherId === selectedTeacherId)) {
                selectedTeacherId = sortedTeachers[0].teacherId;
            }

            tbody.innerHTML = sortedTeachers.map(teacher => {
                const isActive = teacher.teacherId === selectedTeacherId;
                return `
                    <tr class="${isActive ? 'is-active' : ''}" onclick="showTeacherDetail(${teacher.teacherId})">
                        <td class="font-medium text-gray-700">${teacher.queueRank}</td>
                        <td>
                            <div class="flex items-center space-x-3">
                                ${createTeacherAvatar(teacher)}
                                <div>
                                    <p class="font-semibold text-gray-800">${teacher.name}</p>
                                    ${teacher.lastEventDate ? `<p class="text-xs text-gray-500">ล่าสุด ${formatDateThai(teacher.lastEventDate)}</p>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="text-sm text-gray-600">${teacher.position}</td>
                        <td class="font-semibold text-[#5b2d38]">${getTeacherQueueScore(teacher, QUEUE_TYPES.DUTY)}</td>
                        <td class="font-semibold text-[#245f7a]">${getTeacherQueueScore(teacher, QUEUE_TYPES.TRAINING)}</td>
                        <td class="text-center">${teacher.dutyDuties ?? 0}</td>
                        <td class="text-center">${teacher.trainingDuties ?? 0}</td>
                        <td class="text-center">${teacher.swapCount ?? 0}</td>
                    </tr>
                `;
            }).join('');

            const activeTeacher = sortedTeachers.find(t => t.teacherId === selectedTeacherId) || sortedTeachers[0];
            renderTeacherDetail(activeTeacher);
        }

        function showTeacherDetail(teacherId) {
            selectedTeacherId = teacherId;
            renderTeachersTable();
        }

        function renderTeacherDetail(teacher) {
            const panel = document.getElementById('teacher-detail-panel');
            if (!panel) {
                return;
            }

            if (!teacher) {
                panel.innerHTML = '<p class="text-sm text-gray-500">ยังไม่มีข้อมูลครูให้แสดง</p>';
                return;
            }

            ensureTeacherStats(teacher);
            const relatedEvents = events
                .filter(event => Array.isArray(event.assignedTeachers) && event.assignedTeachers.includes(teacher.teacherId))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const relatedTrainingEvents = trainings
                .filter(event => Array.isArray(event.assignedTeachers) && event.assignedTeachers.includes(teacher.teacherId))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const totalEvent = relatedEvents.length;
            const totalTraining = relatedTrainingEvents.length;
            const totalAll = totalEvent + totalTraining;

            const highlightEvents = relatedEvents.slice(0, 3).map(event => {
                const statusLabel = event.status === 'assigned' ? 'จัดคิวแล้ว' : event.status === 'completed' ? 'เสร็จสิ้น' : 'รอจัดคิว';
                return `
                    <li class="p-3 rounded-lg border border-gray-200 bg-gray-50">
                        <p class="font-medium text-gray-800">${event.eventName}</p>
                        <p class="text-xs text-gray-500">${formatDateThai(event.date)} • ${event.time}</p>
                        <p class="text-xs text-gray-500">สถานที่: ${event.location}</p>
                        <span class="inline-block mt-2 text-xs font-semibold px-2 py-1 rounded-full" style="background: rgba(137, 77, 91, 0.12); color: #5b2d38;">${statusLabel}</span>
                    </li>
                `;
            }).join('');

                const highlightTraining = relatedTrainingEvents.slice(0, 3).map(event => {
                    const statusLabel = event.status === 'assigned' ? 'จัดคิวแล้ว' : event.status === 'completed' ? 'เสร็จสิ้น' : 'รอจัดคิว';
                    return `
                        <li class="p-3 rounded-lg border border-blue-200 bg-blue-50">
                            <p class="font-medium text-gray-800">${event.trainingName || event.eventName}</p>
                            <p class="text-xs text-gray-500">${formatDateRangeThai(event.startDate || event.date, event.endDate || event.date)} • ${event.time}</p>
                            <p class="text-xs text-gray-500">สถานที่: ${event.location}</p>
                            <span class="inline-block mt-2 text-xs font-semibold px-2 py-1 rounded-full" style="background: rgba(196, 233, 248, 0.6); color: #245f7a;">${statusLabel}</span>
                        </li>
                    `;
            }).join('');

            panel.innerHTML = `
                <div class="flex items-center gap-4">
                    ${createTeacherAvatar(teacher, true)}
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">${teacher.name}</h3>
                        <p class="text-sm text-gray-600">${teacher.position}</p>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <span class="queue-score">คะแนนออกงาน ${getTeacherQueueScore(teacher, QUEUE_TYPES.DUTY)}</span>
                            <span class="queue-score" style="background: rgba(36, 95, 122, 0.1); color: #245f7a;">คะแนนอบรม ${getTeacherQueueScore(teacher, QUEUE_TYPES.TRAINING)}</span>
                        </div>
                    </div>
                </div>
                <div class="teacher-detail-card mt-4">
                    <div class="detail-row"><span>ลำดับคิวปัจจุบัน</span><span>${teacher.queueRank ?? '-'}</span></div>
                    <div class="detail-row"><span>คะแนนออกงาน</span><span>${getTeacherQueueScore(teacher, QUEUE_TYPES.DUTY)}</span></div>
                    <div class="detail-row"><span>คะแนนอบรม</span><span>${getTeacherQueueScore(teacher, QUEUE_TYPES.TRAINING)}</span></div>
                    <div class="detail-row"><span>รวมทั้งหมด (งาน+อบรม)</span><span>${totalAll} ครั้ง</span></div>
                    <div class="detail-row"><span>งาน (Event)</span><span>${totalEvent} ครั้ง</span></div>
                    <div class="detail-row"><span>อบรม (Training)</span><span>${totalTraining} ครั้ง</span></div>
                    <div class="detail-row"><span>ออกงานทั้งหมด</span><span>${teacher.dutyDuties ?? 0} ครั้ง</span></div>
                    <div class="detail-row"><span>อบรมทั้งหมด</span><span>${teacher.trainingDuties ?? 0} ครั้ง</span></div>
                    <div class="detail-row"><span>แทนงาน</span><span>${teacher.dutySwapCount ?? 0} ครั้ง</span></div>
                    <div class="detail-row"><span>แทนอบรม</span><span>${teacher.trainingSwapCount ?? 0} ครั้ง</span></div>
                    <div class="detail-row"><span>รวมการแทน</span><span>${teacher.swapCount ?? 0} ครั้ง</span></div>
                    <div class="detail-row"><span>ออกงานล่าสุด</span><span>${teacher.lastDutyDate ? formatDateThai(teacher.lastDutyDate) : '-'}</span></div>
                    <div class="detail-row"><span>อบรมล่าสุด</span><span>${teacher.lastTrainingDate ? formatDateThai(teacher.lastTrainingDate) : '-'}</span></div>
                </div>
                <div class="mt-4">
                    <h4 class="font-semibold text-gray-800">งานที่เกี่ยวข้องล่าสุด</h4>
                    ${relatedEvents.length > 0 ? `<ul class="mt-2 space-y-2">${highlightEvents}</ul>` : '<p class="text-sm text-gray-500 mt-2">ยังไม่มีประวัติงาน</p>'}
                </div>
                <div class="mt-4">
                    <h4 class="font-semibold text-gray-800">การอบรมที่เกี่ยวข้องล่าสุด</h4>
                    ${relatedTrainingEvents.length > 0 ? `<ul class="mt-2 space-y-2">${highlightTraining}</ul>` : '<p class="text-sm text-gray-500 mt-2">ยังไม่มีประวัติการอบรม</p>'}
                </div>
                <div class="flex gap-3 mt-6">
                    <button class="btn-primary flex-1" onclick="editTeacher(${teacher.teacherId})">
                        <span class="mr-1">✏️</span>แก้ไขข้อมูล
                    </button>
                    <button class="btn-success flex-1" onclick="adjustQueueScore(${teacher.teacherId})">
                        <span class="mr-1">⚖️</span>ปรับคะแนนคิว
                    </button>
                    <button class="btn-delete flex-1" onclick="deleteTeacher(${teacher.teacherId})">
                        <span class="mr-1">🗑️</span>ลบครู
                    </button>
                </div>
            `;
        }

        // History rendering
        function renderHistory() {
            // Duty distribution
            const sortedTeachers = [...teachers].map(ensureTeacherStats).sort((a, b) => (a.totalDuties || 0) - (b.totalDuties || 0));
            const dutyDistributionHtml = sortedTeachers.map(teacher => `
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <div class="flex items-center">
                        ${createTeacherAvatar(teacher)}
                        <span class="font-medium ml-3">${teacher.name}</span>
                    </div>
                    <span class="text-gray-600">${teacher.dutyDuties ?? 0} งาน | ${teacher.trainingDuties ?? 0} อบรม</span>
                </div>
            `).join('');
            document.getElementById('duty-distribution').innerHTML = dutyDistributionHtml;

            // Substitution stats
            const substitutionStats = teachers.map(ensureTeacherStats).filter(t => (t.swapCount || 0) > 0);
            const substitutionStatsHtml = substitutionStats.length > 0 ? substitutionStats.map(teacher => `
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <div class="flex items-center">
                        ${createTeacherAvatar(teacher)}
                        <span class="font-medium ml-3">${teacher.name}</span>
                    </div>
                    <span class="font-semibold" style="color: var(--secondary-bg);">${teacher.swapCount} ครั้ง (งาน ${teacher.dutySwapCount ?? 0} | อบรม ${teacher.trainingSwapCount ?? 0})</span>
                </div>
            `).join('') : '<p class="text-gray-500 text-center py-4">ยังไม่มีการแทน</p>';
            document.getElementById('substitution-stats').innerHTML = substitutionStatsHtml;

            // Activity log
            const activityLogHtml = activityLog.length > 0 ? activityLog.map(log => {
                const logClass = log.type === 'auto-assign' ? 'auto-assign' :
                               log.type === 'manual-edit' ? 'manual-edit' : 'substitution';
                const date = formatDateTimeThai(log.timestamp);
                
                return `
                    <div class="log-entry ${logClass}">
                        <div class="flex justify-between items-start mb-1">
                            <p class="font-medium text-gray-800">${log.description}</p>
                            <span class="text-xs text-gray-500">${date}</span>
                        </div>
                        ${log.details ? `<p class="text-sm text-gray-600">${log.details}</p>` : ''}
                        <p class="text-xs text-gray-500 mt-1">โดย: ${log.admin}</p>
                    </div>
                `;
            }).join('') : '<p class="text-gray-500 text-center py-4">ยังไม่มีประวัติการดำเนินการ</p>';
            document.getElementById('activity-log').innerHTML = activityLogHtml;
        }

        // Modal functions
        function renderEventAssignmentSummary(event) {
            const summary = document.getElementById('event-assignment-summary');
            const list = document.getElementById('event-assignment-list');

            if (!summary || !list) {
                return;
            }

            if (!event) {
                summary.classList.add('hidden');
                list.innerHTML = '';
                return;
            }

            const slots = getEventAssignmentSlots(event);
            summary.classList.remove('hidden');

            if (!slots.length) {
                list.innerHTML = '<p class="text-sm text-gray-500">ยังไม่มีข้อมูลการจัดคิวสำหรับงานนี้</p>';
                return;
            }

            list.innerHTML = slots.map((slot, index) => {
                const originalTeacher = slot.originalTeacherId ? getTeacherById(slot.originalTeacherId) : null;
                const currentTeacher = slot.currentTeacherId ? getTeacherById(slot.currentTeacherId) : null;
                const isSubstituted = slot.originalTeacherId && slot.currentTeacherId && slot.originalTeacherId !== slot.currentTeacherId;

                const originalName = originalTeacher ? originalTeacher.name : 'ไม่ระบุ';
                const currentName = currentTeacher ? currentTeacher.name : 'ไม่พบข้อมูล';
                const currentScore = currentTeacher ? getTeacherQueueScore(currentTeacher, currentEventQueueType) : '-';
                const scoreLabel = currentEventQueueType === QUEUE_TYPES.TRAINING ? 'คะแนนอบรม' : 'คะแนนออกงาน';

                return `
                    <div class="p-3 rounded-lg border ${isSubstituted ? 'border-[#E1B1C1] bg-[#fdf6f8]' : 'border-gray-200 bg-white'}">
                        <div class="flex items-center justify-between gap-3">
                            <div class="flex items-center space-x-3">
                                ${createTeacherAvatar(originalTeacher)}
                                <div>
                                    <p class="text-xs text-gray-500 uppercase tracking-wide">คิวที่ ${index + 1}</p>
                                    <p class="text-sm font-medium text-gray-800">${originalName}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                ${createTeacherAvatar(currentTeacher)}
                                <div class="text-right">
                                    <p class="text-xs text-gray-500 uppercase tracking-wide">ผู้ปฏิบัติจริง</p>
                                    <p class="text-sm font-semibold ${isSubstituted ? 'text-[#894D5B]' : 'text-gray-800'}">${currentName}</p>
                                    <p class="text-xs text-gray-500">${scoreLabel} ${currentScore}</p>
                                </div>
                            </div>
                        </div>
                        ${isSubstituted
                            ? `<p class="text-xs text-[#894D5B] mt-2">แทนคิวของ ${originalName}</p>`
                            : '<p class="text-xs text-gray-500 mt-2">ตรงตามคิวเดิม</p>'}
                    </div>
                `;
            }).join('');
        }

        function fillEventFormFields(data = {}) {
            document.getElementById('event-name').value = data.eventName || '';
            document.getElementById('event-details').value = data.details || '';
            document.getElementById('event-date').value = data.date || '';
            document.getElementById('event-start-time').value = data.startTime || '';
            document.getElementById('event-end-time').value = data.endTime || '';
            document.getElementById('event-location').value = data.location || '';
            const quota = parseInt(data.requiredQuota, 10);
            document.getElementById('event-quota').value = Number.isFinite(quota) ? quota : '';
            const latInput = document.getElementById('event-location-lat');
            const lngInput = document.getElementById('event-location-lng');
            if (latInput) latInput.value = data.locationLat ?? '';
            if (lngInput) lngInput.value = data.locationLng ?? '';
        }

        function resetEventForm() {
            const form = document.getElementById('event-form');
            if (currentEventInitialData) {
                fillEventFormFields(currentEventInitialData);
            } else if (form) {
                form.reset();
                fillEventFormFields({ requiredQuota: '' });
            }

            renderEventAssignmentSummary(currentEventId ? getEventById(currentEventId, currentEventQueueType) : null);
        }

        function openEventModal(eventId = null, queueType = QUEUE_TYPES.DUTY) {
            currentEventId = eventId;
            currentEventQueueType = queueType || QUEUE_TYPES.DUTY;

            const modal = document.getElementById('event-modal');
            const title = document.getElementById('event-modal-title');
            const form = document.getElementById('event-form');
            const queueLabel = getQueueDisplayName(currentEventQueueType);

            if (eventId) {
                const event = getEventById(eventId, currentEventQueueType);
                if (!event) {
                    console.error('ไม่พบข้อมูลงานสำหรับคิว', currentEventQueueType, 'รหัส', eventId);
                    return;
                }
                title.textContent = `แก้ไข${queueLabel}`;
                fillEventFormFields(event);
                currentEventInitialData = {
                    eventName: event.eventName || '',
                    details: event.details || '',
                    date: event.date || '',
                    startTime: event.startTime || '',
                    endTime: event.endTime || '',
                    location: event.location || '',
                    locationLat: event.locationLat ?? '',
                    locationLng: event.locationLng ?? '',
                    requiredQuota: event.requiredQuota ?? ''
                };
                renderEventAssignmentSummary(event);
            } else {
                title.textContent = `เพิ่ม${queueLabel}ใหม่`;
                form.reset();
                currentEventInitialData = null;
                fillEventFormFields({ requiredQuota: '' });
                renderEventAssignmentSummary(null);
            }

            modal.classList.add('show');
        }

        function closeEventModal() {
            document.getElementById('event-modal').classList.remove('show');
            currentEventId = null;
            currentEventInitialData = null;
            renderEventAssignmentSummary(null);
        }

        function fillTrainingFormFields(data = {}) {
            document.getElementById('training-name').value = data.trainingName || '';
            document.getElementById('training-details').value = data.details || '';
            document.getElementById('training-start-date').value = data.startDate || data.date || '';
            document.getElementById('training-end-date').value = data.endDate || data.date || '';
            document.getElementById('training-start-time').value = data.startTime || '';
            document.getElementById('training-end-time').value = data.endTime || '';
            document.getElementById('training-location').value = data.location || '';
            const quota = parseInt(data.requiredQuota, 10);
            document.getElementById('training-quota').value = Number.isFinite(quota) ? quota : '';
            const latInput = document.getElementById('training-location-lat');
            const lngInput = document.getElementById('training-location-lng');
            if (latInput) latInput.value = data.locationLat ?? '';
            if (lngInput) lngInput.value = data.locationLng ?? '';
        }

        function resetTrainingForm() {
            const form = document.getElementById('training-form');
            if (currentTrainingInitialData) {
                fillTrainingFormFields(currentTrainingInitialData);
            } else if (form) {
                form.reset();
                fillTrainingFormFields({ requiredQuota: '' });
            }
        }

        function openTrainingModal(trainingId = null) {
            currentTrainingId = trainingId;
            const modal = document.getElementById('training-modal');
            const title = document.getElementById('training-modal-title');
            const form = document.getElementById('training-form');

            const latInput = document.getElementById('training-location-lat');
            const lngInput = document.getElementById('training-location-lng');

            if (trainingId) {
                const tr = trainings.find(t => t.trainingId === trainingId);
                if (!tr) {
                    console.error('ไม่พบข้อมูลอบรมรหัส', trainingId);
                    return;
                }
                title.textContent = 'แก้ไขอบรม';
                fillTrainingFormFields(tr);
                currentTrainingInitialData = {
                    trainingName: tr.trainingName || '',
                    details: tr.details || '',
                    startDate: tr.startDate || tr.date || '',
                    endDate: tr.endDate || tr.date || '',
                    startTime: tr.startTime || '',
                    endTime: tr.endTime || '',
                    location: tr.location || '',
                    locationLat: tr.locationLat ?? '',
                    locationLng: tr.locationLng ?? '',
                    requiredQuota: tr.requiredQuota ?? ''
                };
            } else {
                title.textContent = 'เพิ่มอบรมใหม่';
                form.reset();
                currentTrainingInitialData = null;
                fillTrainingFormFields({ requiredQuota: '' });
            }

            modal.classList.add('show');
        }

        function closeTrainingModal() {
            document.getElementById('training-modal').classList.remove('show');
            currentTrainingId = null;
            currentTrainingInitialData = null;
        }

        function editTraining(id) {
            openTrainingModal(id);
        }

        function fillTeacherFormFields(data = {}) {
            document.getElementById('teacher-name').value = data.name || '';
            document.getElementById('teacher-position').value = data.position || '';
            const dutyScore = parseInt(data.dutyQueueScore, 10);
            const trainingScore = parseInt(data.trainingQueueScore, 10);
            document.getElementById('teacher-duty-queue-score').value = Number.isFinite(dutyScore) ? dutyScore : 0;
            document.getElementById('teacher-training-queue-score').value = Number.isFinite(trainingScore) ? trainingScore : 0;
        }

        function resetTeacherForm() {
            const form = document.getElementById('teacher-form');
            if (currentTeacherInitialData) {
                fillTeacherFormFields(currentTeacherInitialData);
            } else if (form) {
                form.reset();
                fillTeacherFormFields({ dutyQueueScore: 0, trainingQueueScore: 0 });
            }
        }

        function openTeacherModal(teacherId = null) {
            currentTeacherId = teacherId;
            const modal = document.getElementById('teacher-modal');
            const title = document.getElementById('teacher-modal-title');
            const form = document.getElementById('teacher-form');

            if (teacherId) {
                const teacher = getTeacherById(teacherId);
                title.textContent = 'แก้ไขข้อมูลครู';
                const dutyScore = getTeacherQueueScore(teacher, QUEUE_TYPES.DUTY);
                const trainingScore = getTeacherQueueScore(teacher, QUEUE_TYPES.TRAINING);
                fillTeacherFormFields({
                    name: teacher.name,
                    position: teacher.position,
                    dutyQueueScore: dutyScore,
                    trainingQueueScore: trainingScore
                });
                currentTeacherInitialData = {
                    name: teacher.name,
                    position: teacher.position,
                    dutyQueueScore: dutyScore,
                    trainingQueueScore: trainingScore
                };
            } else {
                title.textContent = 'เพิ่มครูใหม่';
                form.reset();
                currentTeacherInitialData = null;
                fillTeacherFormFields({ dutyQueueScore: 0, trainingQueueScore: 0 });
            }

            modal.classList.add('show');
        }

        function closeTeacherModal() {
            document.getElementById('teacher-modal').classList.remove('show');
            currentTeacherId = null;
            currentTeacherInitialData = null;
        }

        function openAutoAssignModal(eventId, queueType = QUEUE_TYPES.DUTY) {
            currentEventQueueType = queueType || QUEUE_TYPES.DUTY;
            const event = getEventById(eventId, currentEventQueueType);
            if (!event || event.status !== 'pending') return;

            // Get teachers sorted by queue score (lowest first)
            const sortedTeachers = [...teachers].sort((a, b) => compareTeachersForQueue(a, b, currentEventQueueType));
            const suggestedTeachers = sortedTeachers.slice(0, event.requiredQuota);

            const content = document.getElementById('auto-assign-content');
            const queueAction = currentEventQueueType === QUEUE_TYPES.TRAINING ? 'เข้ารับการอบรม' : 'ออกงาน';
            const scoreDescriptor = currentEventQueueType === QUEUE_TYPES.TRAINING ? 'คะแนนอบรม' : 'คะแนนออกงาน';
            content.innerHTML = `
                <div class="mb-4">
                    <h4 class="font-semibold text-gray-800 mb-2">${getQueueDisplayName(currentEventQueueType)}: ${event.eventName}</h4>
                    <p class="text-sm text-gray-600">วันที่: ${formatDateThai(event.date)} เวลา: ${event.time}</p>
                    <p class="text-sm text-gray-600">ต้องการครู: ${event.requiredQuota} คน</p>
                </div>

                <div class="mb-6">
                    <h5 class="font-medium text-gray-800 mb-3">เลือกครูที่จะ${queueAction} (คลิกเพื่อเลือก/ยกเลิก):</h5>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 max-h-80 overflow-y-auto">
                        ${sortedTeachers.map((teacher, index) => {
                            const isSelected = index < event.requiredQuota;
                            const isRecommended = index < event.requiredQuota;
                            return `
                                <div class="teacher-select-card p-3 border-2 rounded-lg cursor-pointer transition-all duration-200 ${isSelected ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white hover:border-blue-300'}" 
                                     data-teacher-id="${teacher.teacherId}" 
                                     onclick="toggleTeacherSelection(${teacher.teacherId}, ${event.requiredQuota})">
                                            <div class="flex flex-col items-center text-center">
                                                ${createTeacherAvatar(teacher)}
                                                <div class="mt-2">
                                                    <p class="font-medium text-sm">${teacher.name}</p>
                                                    <p class="text-xs text-gray-600">${teacher.position}</p>
                                                    <div class="flex items-center justify-center mt-1">
                                                        <span class="queue-score text-xs">${getTeacherQueueScore(teacher, currentEventQueueType)}</span>
                                                        ${isRecommended ? '<span class="ml-1 text-xs">⭐</span>' : ''}
                                                    </div>
                                                    <p class="text-xs text-gray-500">งาน ${teacher.dutyDuties ?? 0} | อบรม ${teacher.trainingDuties ?? 0}</p>
                                                </div>
                                                <div class="selection-indicator mt-2 w-4 h-4 rounded-full border-2 ${isSelected ? 'bg-green-500 border-green-500' : 'border-gray-300'}">
                                                    ${isSelected ? '<span class="text-white text-xs">✓</span>' : ''}
                                                </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="mt-3 text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                        <p><span class="font-medium">💡 คำแนะนำ:</span> ครูที่มี ⭐ คือครูที่ระบบแนะนำตาม${scoreDescriptor}ต่ำสุด</p>
                        <p class="mt-1"><span class="font-medium">เลือกแล้ว:</span> <span id="selected-count">0</span>/${event.requiredQuota} คน</p>
                    </div>
                </div>
            `;

            // Initialize selection count
            updateSelectedCount(event.requiredQuota);

            document.getElementById('confirm-auto-assign').onclick = () => confirmAutoAssignFromSelection(eventId, currentEventQueueType);
            document.getElementById('auto-assign-modal').classList.add('show');
        }

        function toggleTeacherSelection(teacherId, requiredQuota) {
            const card = document.querySelector(`[data-teacher-id="${teacherId}"]`);
            const indicator = card.querySelector('.selection-indicator');
            const isCurrentlySelected = card.classList.contains('border-green-500');
            
            if (isCurrentlySelected) {
                // Deselect
                card.classList.remove('border-green-500', 'bg-green-50');
                card.classList.add('border-gray-200', 'bg-white');
                indicator.classList.remove('bg-green-500', 'border-green-500');
                indicator.classList.add('border-gray-300');
                indicator.innerHTML = '';
            } else {
                // Check if we can select more
                const currentSelected = document.querySelectorAll('.teacher-select-card.border-green-500').length;
                if (currentSelected >= requiredQuota) {
                    alert(`สามารถเลือกได้สูงสุด ${requiredQuota} คนเท่านั้น`);
                    return;
                }
                
                // Select
                card.classList.remove('border-gray-200', 'bg-white');
                card.classList.add('border-green-500', 'bg-green-50');
                indicator.classList.remove('border-gray-300');
                indicator.classList.add('bg-green-500', 'border-green-500');
                indicator.innerHTML = '<span class="text-white text-xs">✓</span>';
            }
            
            updateSelectedCount(requiredQuota);
        }

        function updateSelectedCount(requiredQuota) {
            const selectedCount = document.querySelectorAll('.teacher-select-card.border-green-500').length;
            const countElement = document.getElementById('selected-count');
            if (countElement) {
                countElement.textContent = selectedCount;
                countElement.style.color = selectedCount === requiredQuota ? '#059669' : '#dc2626';
            }
        }

        function confirmAutoAssignFromSelection(eventId, queueType = currentEventQueueType) {
            const selectedCards = document.querySelectorAll('.teacher-select-card.border-green-500');
            const selectedTeacherIds = Array.from(selectedCards).map(card =>
                parseInt(card.getAttribute('data-teacher-id'))
            );

            const event = getEventById(eventId, queueType);

            if (selectedTeacherIds.length !== event.requiredQuota) {
                alert(`กรุณาเลือกครูให้ครบ ${event.requiredQuota} คน (เลือกแล้ว ${selectedTeacherIds.length} คน)`);
                return;
            }

            const selectedTeachers = selectedTeacherIds.map(id => getTeacherById(id));
            confirmAutoAssign(eventId, selectedTeachers, queueType);
        }

        function closeAutoAssignModal() {
            document.getElementById('auto-assign-modal').classList.remove('show');
        }

        function confirmAutoAssign(eventId, selectedTeachers, queueType = currentEventQueueType) {
            const event = getEventById(eventId, queueType);
            const teacherIds = selectedTeachers.map(t => t.teacherId);

            // Update event
            event.assignedTeachers = teacherIds;
            event.assignmentSlots = createAssignmentSlotsFromIds(teacherIds);
            event.status = 'assigned';
            ensureEventAssignments(event);

            // Update teacher stats - ระบบใหม่: เพิ่มคะแนนตามประเภทคิว
            selectedTeachers.forEach(teacher => {
                ensureTeacherStats(teacher);
                if (queueType === QUEUE_TYPES.TRAINING) {
                    teacher.trainingDuties = (teacher.trainingDuties || 0) + 1;
                    teacher.lastTrainingDate = normalizeDateString(event.date);
                } else {
                    teacher.dutyDuties = (teacher.dutyDuties || 0) + 1;
                    teacher.lastDutyDate = normalizeDateString(event.date);
                }
                teacher.totalDuties = (teacher.dutyDuties || 0) + (teacher.trainingDuties || 0);
                adjustTeacherQueueScore(teacher, queueType, 15);
                teacher.lastEventDate = latestDateString(teacher.lastDutyDate, teacher.lastTrainingDate);
            });

            // Add activity log
            const teacherNames = selectedTeachers.map(t => t.name).join(', ');
            addActivityLog(
                'auto-assign',
                `จัดคิวอัตโนมัติสำหรับ${getQueueDisplayName(queueType)} "${getQueueItemName(event, queueType)}"`,
                `ครูที่ได้รับมอบหมาย: ${teacherNames}`
            );

            saveData();
            closeAutoAssignModal();
            showView(getQueueView(queueType));
        }

        function openTrainingAutoAssignModal(trainingId) {
            currentEventQueueType = QUEUE_TYPES.TRAINING;
            currentEventId = trainingId;
            const tr = trainings.find(t => t.trainingId === trainingId);
            if (!tr || tr.status !== 'pending') return;

            const sortedTeachers = [...teachers].sort((a, b) => compareTeachersForQueue(a, b, QUEUE_TYPES.TRAINING));
            const content = document.getElementById('auto-assign-content');

            content.innerHTML = `
                <div class="mb-4">
                    <h4 class="font-semibold text-gray-800 mb-2">อบรม: ${tr.trainingName}</h4>
                    <p class="text-sm text-gray-600">วันที่: ${formatDateRangeThai(tr.startDate || tr.date, tr.endDate || tr.date)} เวลา: ${tr.time}</p>
                    <p class="text-sm text-gray-600">ต้องการครู: ${tr.requiredQuota} คน</p>
                </div>
                <div class="mb-6">
                    <h5 class="font-medium text-gray-800 mb-3">เลือกครูที่จะเข้ารับการอบรม (คลิกเพื่อเลือก/ยกเลิก):</h5>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 max-h-80 overflow-y-auto">
                        ${sortedTeachers.map((teacher, index) => {
                            const isSelected = index < tr.requiredQuota;
                            return `
                                <div class="teacher-select-card p-3 border-2 rounded-lg cursor-pointer ${isSelected ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white'}"
                                     data-teacher-id="${teacher.teacherId}"
                                     onclick="toggleTeacherSelection(${teacher.teacherId}, ${tr.requiredQuota})">
                                    <div class="flex flex-col items-center text-center">
                                        ${createTeacherAvatar(teacher)}
                                        <div class="mt-2">
                                            <p class="font-medium text-sm">${teacher.name}</p>
                                            <p class="text-xs text-gray-600">${teacher.position}</p>
                                            <div class="flex items-center justify-center mt-1">
                                                <span class="queue-score text-xs">${getTeacherQueueScore(teacher, QUEUE_TYPES.TRAINING)}</span>
                                                ${index < tr.requiredQuota ? '<span class="ml-1 text-xs">⭐</span>' : ''}
                                            </div>
                                        </div>
                                        <div class="selection-indicator mt-2 w-4 h-4 rounded-full border-2 ${isSelected ? 'bg-green-500 border-green-500' : 'border-gray-300'}">
                                            ${isSelected ? '<span class="text-white text-xs">✓</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="mt-3 text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                        <p><span class="font-medium">💡 คำแนะนำ:</span> เลือกตามคะแนนอบรมต่ำสุดก่อน</p>
                        <p class="mt-1"><span class="font-medium">เลือกแล้ว:</span> <span id="selected-count">${Math.min(tr.requiredQuota, sortedTeachers.length)}</span>/${tr.requiredQuota} คน</p>
                    </div>
                </div>
            `;

            updateSelectedCount(tr.requiredQuota);
            document.getElementById('confirm-auto-assign').onclick = () => confirmTrainingAutoAssignFromSelection(trainingId);
            document.getElementById('auto-assign-modal').classList.add('show');
        }

        function confirmTrainingAutoAssignFromSelection(trainingId) {
            const selectedCards = document.querySelectorAll('.teacher-select-card.border-green-500');
            const selectedIds = Array.from(selectedCards).map(card => parseInt(card.getAttribute('data-teacher-id')));
            const tr = trainings.find(t => t.trainingId === trainingId);

            if (!tr) {
                alert('ไม่พบข้อมูลอบรมที่เลือก');
                return;
            }

        function updateSelectedCount(requiredQuota) {
            const selectedCount = document.querySelectorAll('.teacher-select-card.border-green-500').length;
            const countElement = document.getElementById('selected-count');
            if (countElement) {
                countElement.textContent = selectedCount;
                countElement.style.color = selectedCount === requiredQuota ? '#059669' : '#dc2626';
            }
        }

        function confirmAutoAssignFromSelection(eventId, queueType = currentEventQueueType) {
            const selectedCards = document.querySelectorAll('.teacher-select-card.border-green-500');
            const selectedTeacherIds = Array.from(selectedCards).map(card =>
                parseInt(card.getAttribute('data-teacher-id'))
            );

            const event = getEventById(eventId, queueType);

            if (selectedTeacherIds.length !== event.requiredQuota) {
                alert(`กรุณาเลือกครูให้ครบ ${event.requiredQuota} คน (เลือกแล้ว ${selectedTeacherIds.length} คน)`);
                return;
            }

            const selectedTeachers = selectedTeacherIds.map(id => getTeacherById(id));
            confirmAutoAssign(eventId, selectedTeachers, queueType);
        }

        function closeAutoAssignModal() {
            document.getElementById('auto-assign-modal').classList.remove('show');
        }

        function confirmAutoAssign(eventId, selectedTeachers, queueType = currentEventQueueType) {
            const event = getEventById(eventId, queueType);
            const teacherIds = selectedTeachers.map(t => t.teacherId);

            // Update event
            event.assignedTeachers = teacherIds;
            event.assignmentSlots = createAssignmentSlotsFromIds(teacherIds);
            event.status = 'assigned';
            ensureEventAssignments(event);

            // Update teacher stats - ระบบใหม่: เพิ่มคะแนนตามประเภทคิว
            selectedTeachers.forEach(teacher => {
                ensureTeacherStats(teacher);
                if (queueType === QUEUE_TYPES.TRAINING) {
                    teacher.trainingDuties = (teacher.trainingDuties || 0) + 1;
                    teacher.lastTrainingDate = normalizeDateString(event.date);
                } else {
                    teacher.dutyDuties = (teacher.dutyDuties || 0) + 1;
                    teacher.lastDutyDate = normalizeDateString(event.date);
                }
                teacher.totalDuties = (teacher.dutyDuties || 0) + (teacher.trainingDuties || 0);
                adjustTeacherQueueScore(teacher, queueType, 15);
                teacher.lastEventDate = latestDateString(teacher.lastDutyDate, teacher.lastTrainingDate);
            });

            // Add activity log
            const teacherNames = selectedTeachers.map(t => t.name).join(', ');
            addActivityLog(
                'auto-assign',
                `จัดคิวอัตโนมัติสำหรับ${getQueueDisplayName(queueType)} "${getQueueItemName(event, queueType)}"`,
                `ครูที่ได้รับมอบหมาย: ${teacherNames}`
            );

            saveData();
            closeAutoAssignModal();
            showView(getQueueView(queueType));
        }

        function openTrainingAutoAssignModal(trainingId) {
            currentEventQueueType = QUEUE_TYPES.TRAINING;
            currentEventId = trainingId;
            const tr = trainings.find(t => t.trainingId === trainingId);
            if (!tr || tr.status !== 'pending') return;

            const sortedTeachers = [...teachers].sort((a, b) => compareTeachersForQueue(a, b, QUEUE_TYPES.TRAINING));
            const content = document.getElementById('auto-assign-content');

            content.innerHTML = `
                <div class="mb-4">
                    <h4 class="font-semibold text-gray-800 mb-2">อบรม: ${tr.trainingName}</h4>
                    <p class="text-sm text-gray-600">วันที่: ${formatDateRangeThai(tr.startDate || tr.date, tr.endDate || tr.date)} เวลา: ${tr.time}</p>
                    <p class="text-sm text-gray-600">ต้องการครู: ${tr.requiredQuota} คน</p>
                </div>
                <div class="mb-6">
                    <h5 class="font-medium text-gray-800 mb-3">เลือกครูที่จะเข้ารับการอบรม (คลิกเพื่อเลือก/ยกเลิก):</h5>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 max-h-80 overflow-y-auto">
                        ${sortedTeachers.map((teacher, index) => {
                            const isSelected = index < tr.requiredQuota;
                            return `
                                <div class="teacher-select-card p-3 border-2 rounded-lg cursor-pointer ${isSelected ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white'}"
                                     data-teacher-id="${teacher.teacherId}"
                                     onclick="toggleTeacherSelection(${teacher.teacherId}, ${tr.requiredQuota})">
                                    <div class="flex flex-col items-center text-center">
                                        ${createTeacherAvatar(teacher)}
                                        <div class="mt-2">
                                            <p class="font-medium text-sm">${teacher.name}</p>
                                            <p class="text-xs text-gray-600">${teacher.position}</p>
                                            <div class="flex items-center justify-center mt-1">
                                                <span class="queue-score text-xs">${getTeacherQueueScore(teacher, QUEUE_TYPES.TRAINING)}</span>
                                                ${index < tr.requiredQuota ? '<span class="ml-1 text-xs">⭐</span>' : ''}
                                            </div>
                                        </div>
                                        <div class="selection-indicator mt-2 w-4 h-4 rounded-full border-2 ${isSelected ? 'bg-green-500 border-green-500' : 'border-gray-300'}">
                                            ${isSelected ? '<span class="text-white text-xs">✓</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="mt-3 text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                        <p><span class="font-medium">💡 คำแนะนำ:</span> เลือกตามคะแนนอบรมต่ำสุดก่อน</p>
                        <p class="mt-1"><span class="font-medium">เลือกแล้ว:</span> <span id="selected-count">${Math.min(tr.requiredQuota, sortedTeachers.length)}</span>/${tr.requiredQuota} คน</p>
                    </div>
                </div>
            `;

            updateSelectedCount(tr.requiredQuota);
            document.getElementById('confirm-auto-assign').onclick = () => confirmTrainingAutoAssignFromSelection(trainingId);
            document.getElementById('auto-assign-modal').classList.add('show');
        }

        function confirmTrainingAutoAssignFromSelection(trainingId) {
            const selectedCards = document.querySelectorAll('.teacher-select-card.border-green-500');
            const selectedIds = Array.from(selectedCards).map(card => parseInt(card.getAttribute('data-teacher-id')));
            const tr = trainings.find(t => t.trainingId === trainingId);

            if (!tr) {
                alert('ไม่พบข้อมูลอบรมที่เลือก');
                return;
            }

            if (selectedIds.length !== tr.requiredQuota) {
                alert(`กรุณาเลือกครูให้ครบ ${tr.requiredQuota} คน (เลือกแล้ว ${selectedIds.length} คน)`);
                return;
            }

            const selectedTeachers = selectedIds.map(id => getTeacherById(id));
            if (selectedTeachers.some(t => !t)) {
                alert('ไม่พบข้อมูลครูที่เลือก กรุณาลองใหม่');
                return;
            }
            confirmTrainingAutoAssign(trainingId, selectedTeachers);
        }

        function confirmTrainingAutoAssign(trainingId, selectedTeachers) {
            const tr = trainings.find(t => t.trainingId === trainingId);
            if (!tr) {
                alert('ไม่พบข้อมูลอบรมที่เลือก');
                return;
            }

            tr.assignedTeachers = selectedTeachers.map(t => t.teacherId);
            tr.status = 'assigned';
            tr.assignmentSlots = createAssignmentSlotsFromIds(tr.assignedTeachers);
            ensureEventAssignments(tr);

            selectedTeachers.forEach(teacher => {
                ensureTeacherStats(teacher);
                teacher.trainingDuties = (teacher.trainingDuties || 0) + 1;
                teacher.totalDuties = (teacher.dutyDuties || 0) + (teacher.trainingDuties || 0);
                adjustTeacherQueueScore(teacher, QUEUE_TYPES.TRAINING, 15);
                teacher.lastTrainingDate = normalizeDateString(tr.endDate || tr.startDate || tr.date);
                teacher.lastEventDate = latestDateString(teacher.lastDutyDate, teacher.lastTrainingDate);
            });

            addActivityLog(
                'training-auto-assign',
                `จัดคิวเข้ารับการอบรม "${tr.trainingName}"`,
                `ครู: ${selectedTeachers.map(t => t.name).join(', ')}`
            );

            saveData();
            closeAutoAssignModal();
            showView('trainings');
        }

        function openSubstitutionModal(eventId, queueType = QUEUE_TYPES.DUTY) {
            currentEventQueueType = queueType || QUEUE_TYPES.DUTY;
            const event = getEventById(eventId, currentEventQueueType);
            const slots = event ? getEventAssignmentSlots(event) : [];
            const currentAssignments = slots.filter(slot => slot.currentTeacherId !== null && slot.currentTeacherId !== undefined);

            if (!event || currentAssignments.length === 0) return;

            currentEventId = eventId;

            const assignedIds = currentAssignments
                .map(slot => slot.currentTeacherId)
                .filter(id => id !== null && id !== undefined);

            const currentTeachersHtml = `
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <h5 class="font-medium text-gray-800 mb-2">ครูที่ได้รับมอบหมายใน${getQueueDisplayName(currentEventQueueType)}นี้:</h5>
                    <div class="space-y-2">
                        ${slots.map((slot, index) => {
                            if (slot.currentTeacherId === null || slot.currentTeacherId === undefined) {
                                return '';
                            }
                            const currentTeacher = getTeacherById(slot.currentTeacherId);
                            const originalTeacher = slot.originalTeacherId ? getTeacherById(slot.originalTeacherId) : null;
                            const isSubstituted = slot.originalTeacherId && slot.currentTeacherId && slot.originalTeacherId !== slot.currentTeacherId;
                            const substitutionType = slot.substitutionType || (isSubstituted ? SUBSTITUTION_TYPES.REPLACEMENT : SUBSTITUTION_TYPES.NONE);
                            let detailHtml = '<p class="text-xs text-gray-500">คิวเดิม</p>';
                            if (isSubstituted) {
                                if (substitutionType === SUBSTITUTION_TYPES.SWAP) {
                                    detailHtml = `<p class=\"text-xs text-[#21510A]\">แลกกับ ${originalTeacher ? originalTeacher.name : 'ไม่ระบุ'}</p>`;
                                } else {
                                    detailHtml = `<p class=\"text-xs text-[#894D5B]\">แทนคิวของ ${originalTeacher ? originalTeacher.name : 'ไม่ระบุ'}</p>`;
                                }
                            }
                            return `
                                <div class="flex items-center justify-between bg-white px-3 py-2 rounded-lg border ${isSubstituted ? 'border-[#E1B1C1]' : 'border-gray-200'}">
                                    <div class="flex items-center">
                                        ${createTeacherAvatar(currentTeacher)}
                                        <div class="ml-2">
                                            <p class="text-sm font-medium text-gray-800">${currentTeacher ? currentTeacher.name : 'ไม่พบข้อมูล'}</p>
                                            ${detailHtml}
                                        </div>
                                    </div>
                                    <span class="text-xs text-gray-500">คิวที่ ${index + 1}</span>
                                </div>
                            `;
                        }).filter(Boolean).join('')}
                    </div>
                </div>
            `;

            const modalContent = document.querySelector('#substitution-modal .modal-content');
            const existingDisplay = modalContent.querySelector('.current-teachers-display');
            if (existingDisplay) {
                existingDisplay.remove();
            }

            const tempDiv = document.createElement('div');
            tempDiv.className = 'current-teachers-display';
            tempDiv.innerHTML = currentTeachersHtml;
            modalContent.insertBefore(tempDiv, document.getElementById('substitution-form'));

            const originalSelect = document.getElementById('original-teacher');
            originalSelect.innerHTML = '<option value="">เลือกครู</option>' +
                currentAssignments.map(slot => {
                    const currentTeacher = getTeacherById(slot.currentTeacherId);
                    const originalTeacher = slot.originalTeacherId ? getTeacherById(slot.originalTeacherId) : null;
                    const currentName = currentTeacher ? currentTeacher.name : 'ไม่พบข้อมูล';
                    const originalLabel = originalTeacher ? ` (คิวเดิม: ${originalTeacher.name})` : '';
                    return `<option value="${slot.currentTeacherId}">${currentName}${originalLabel}</option>`;
                }).join('');

            const substituteSelect = document.getElementById('substitute-teacher');
            const availableTeachers = teachers.filter(t => !assignedIds.includes(t.teacherId));
            substituteSelect.innerHTML = '<option value="">เลือกครู</option>' +
                availableTeachers.map(teacher => {
                    const scoreLabel = currentEventQueueType === QUEUE_TYPES.TRAINING ? 'คะแนนอบรม' : 'คะแนนออกงาน';
                    const scoreValue = getTeacherQueueScore(teacher, currentEventQueueType);
                    return `<option value="${teacher.teacherId}">${teacher.name} - ${teacher.position} (${scoreLabel}: ${scoreValue})</option>`;
                }).join('');

            document.getElementById('substitution-modal').classList.add('show');
        }

        function openTrainingSubstitutionModal(trainingId) {
            openSubstitutionModal(trainingId, QUEUE_TYPES.TRAINING);
        }

        function closeSubstitutionModal() {
            document.getElementById('substitution-modal').classList.remove('show');
            document.getElementById('substitution-form').reset();
            currentEventId = null;
        }

        function editEvent(eventId, queueType = QUEUE_TYPES.DUTY) {
            openEventModal(eventId, queueType);
        }

        function editTeacher(teacherId) {
            openTeacherModal(teacherId);
        }

        function adjustQueueScore(teacherId) {
            const teacher = getTeacherById(teacherId);
            if (!teacher) {
                alert('ไม่พบข้อมูลครูที่ต้องการปรับคะแนน');
                return;
            }

            const typeInput = prompt('ต้องการปรับคะแนนประเภทใด? พิมพ์ "งาน" สำหรับออกงาน หรือ "อบรม" สำหรับอบรม', 'งาน');
            if (!typeInput) {
                return;
            }

            const normalized = typeInput.trim().toLowerCase();
            const queueType = normalized === 'อบรม' || normalized === 'training'
                ? QUEUE_TYPES.TRAINING
                : QUEUE_TYPES.DUTY;

            const label = queueType === QUEUE_TYPES.TRAINING ? 'คะแนนอบรม' : 'คะแนนออกงาน';
            const currentScore = getTeacherQueueScore(teacher, queueType);
            const newScoreInput = prompt(`ปรับ${label}สำหรับ ${teacher.name}\nคะแนนปัจจุบัน: ${currentScore}`, currentScore);

            if (newScoreInput === null || newScoreInput === '') {
                return;
            }

            const parsedScore = parseInt(newScoreInput, 10);
            if (Number.isNaN(parsedScore)) {
                alert('กรุณากรอกตัวเลขสำหรับคะแนนใหม่');
                return;
            }

            const reason = prompt('กรุณาระบุเหตุผลการปรับแก้ไข (บังคับ):');
            if (!reason || !reason.trim()) {
                alert('กรุณาระบุเหตุผลการปรับแก้ไข');
                return;
            }

            const oldScore = currentScore;
            setTeacherQueueScore(teacher, queueType, parsedScore);

            addActivityLog(
                'manual-edit',
                `ปรับ${label}ของ ${teacher.name}`,
                `จาก ${oldScore} เป็น ${parsedScore} | เหตุผล: ${reason}`
            );

            saveData();
            renderTeachersTable();
        }

        function deleteQueueItem(itemId, queueType = QUEUE_TYPES.DUTY) {
            const collection = [...getQueueEvents(queueType)];
            const key = queueType === QUEUE_TYPES.TRAINING ? 'trainingId' : 'eventId';
            const index = collection.findIndex(item => Number(item[key]) === Number(itemId));

            if (index === -1) {
                alert(`ไม่พบ${getQueueDisplayName(queueType)}ที่ต้องการลบ`);
                return;
            }

            const item = collection[index];
            const itemName = getQueueItemName(item, queueType) || `${getQueueDisplayName(queueType)} #${itemId}`;
            if (!confirm(`ต้องการลบ${getQueueDisplayName(queueType)} "${itemName}" หรือไม่?`)) {
                return;
            }

            collection.splice(index, 1);
            setQueueEvents(queueType, collection);

            const logType = queueType === QUEUE_TYPES.TRAINING ? 'training-delete' : 'event-delete';
            const scheduleInfo = item.date ? `วันที่: ${formatDateThai(item.date)}` : 'ไม่มีข้อมูลวันเวลา';
            addActivityLog(
                logType,
                `ลบ${getQueueDisplayName(queueType)} "${itemName}"`,
                `${scheduleInfo} | สถานที่: ${item.location || '-'}`
            );

            if (currentEventQueueType === queueType && currentEventId === itemId) {
                currentEventId = null;
            }
            if (queueType === QUEUE_TYPES.TRAINING && currentTrainingId === itemId) {
                currentTrainingId = null;
            }

            saveData();
            showView(getQueueView(queueType));
        }

        function deleteTeacher(teacherId) {
            const teacher = getTeacherById(teacherId);
            if (!teacher) {
                alert('ไม่พบข้อมูลครูที่ต้องการลบ');
                return;
            }

            if (!confirm(`ต้องการลบข้อมูลครู "${teacher.name}" หรือไม่?`)) {
                return;
            }

            teachers = teachers.filter(t => t.teacherId !== teacherId);

            const cleanupAssignments = (eventList) => {
                eventList.forEach(event => {
                    const slots = getEventAssignmentSlots(event);
                    event.assignmentSlots = slots.map(slot => {
                        if (!slot) {
                            return slot;
                        }
                        const updatedSlot = { ...slot };
                        let slotChanged = false;
                        if (updatedSlot.originalTeacherId === teacherId) {
                            updatedSlot.originalTeacherId = null;
                            slotChanged = true;
                        }
                        if (updatedSlot.currentTeacherId === teacherId) {
                            updatedSlot.currentTeacherId = null;
                            slotChanged = true;
                        }
                        if (updatedSlot.substituteTeacherId === teacherId) {
                            updatedSlot.substituteTeacherId = null;
                            slotChanged = true;
                        }
                        if (slotChanged) {
                            updatedSlot.substitutionType = SUBSTITUTION_TYPES.NONE;
                        }
                        return updatedSlot;
                    });

                    ensureEventAssignments(event);
                    if (event.assignedTeachers.length === 0) {
                        event.status = 'pending';
                    }
                });
            };

            cleanupAssignments(events);
            cleanupAssignments(trainings);

            addActivityLog(
                'teacher-delete',
                `ลบข้อมูลครู "${teacher.name}"`,
                `ตำแหน่ง: ${teacher.position || '-'} | คะแนนออกงานล่าสุด: ${getTeacherQueueScore(teacher, QUEUE_TYPES.DUTY)} | คะแนนอบรมล่าสุด: ${getTeacherQueueScore(teacher, QUEUE_TYPES.TRAINING)}`
            );

            if (selectedTeacherId === teacherId) {
                selectedTeacherId = teachers.length ? teachers[0].teacherId : null;
            }
            if (currentTeacherId === teacherId) {
                currentTeacherId = null;
            }

            saveData();
            showView('teachers');
        }

        // Form submissions
        function safeValue(id) {
            const el = document.getElementById(id);
            return el ? (el.value ?? '').toString().trim() : '';
        }

        document.getElementById('event-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.currentTarget;
            try {
                if (!form.reportValidity()) return;

                const startTime = safeValue('event-start-time');
                const endTime = safeValue('event-end-time');

                const latRaw = parseFloat(safeValue('event-location-lat'));
                const lngRaw = parseFloat(safeValue('event-location-lng'));
                const locationLat = Number.isFinite(latRaw) ? latRaw : null;
                const locationLng = Number.isFinite(lngRaw) ? lngRaw : null;

                const eventData = {
                    eventName: safeValue('event-name'),
                    details: safeValue('event-details'),
                    date: safeValue('event-date'),
                    startTime,
                    endTime,
                    time: `${startTime}-${endTime}`,
                    location: safeValue('event-location'),
                    locationLat,
                    locationLng,
                    requiredQuota: parseInt(safeValue('event-quota')) || 0
                };

                const queueType = currentEventQueueType || QUEUE_TYPES.DUTY;
                const targetCollection = getQueueEvents(queueType);

                if (currentEventId) {
                    const event = getEventById(currentEventId, queueType);
                    Object.assign(event, eventData);
                    ensureEventAssignments(event);

                    addActivityLog(
                        'manual-edit',
                        `แก้ไขข้อมูล${getQueueDisplayName(queueType)} "${eventData.eventName}"`,
                        `วันที่: ${formatDateThai(eventData.date)} | เวลา: ${eventData.time} | สถานที่: ${eventData.location} | โควตาครู: ${eventData.requiredQuota} คน`
                    );
                } else {
                    const newEvent = {
                        eventId: Math.max(...targetCollection.map(e => e.eventId), 0) + 1,
                        ...eventData,
                        assignedTeachers: [],
                        assignmentSlots: [],
                        status: 'pending'
                    };
                    ensureEventAssignments(newEvent);
                    targetCollection.push(newEvent);

                    addActivityLog(
                        'manual-edit',
                        `เพิ่ม${getQueueDisplayName(queueType)}ใหม่ "${eventData.eventName}"`,
                        `วันที่: ${formatDateThai(eventData.date)} | เวลา: ${eventData.time} | สถานที่: ${eventData.location} | โควตาครู: ${eventData.requiredQuota} คน`
                    );
                }

                saveData();
                closeEventModal();
                showView(getQueueView(queueType));
            } catch (err) {
                console.error('Event form submit failed:', err);
                alert('บันทึกงานไม่สำเร็จ: ' + (err?.message || err));
            }
        });

        document.getElementById('training-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.currentTarget;
            if (!form.reportValidity()) return;

            try {
                const startDate = safeValue('training-start-date');
                const endDateInput = safeValue('training-end-date');
                const startTime = safeValue('training-start-time');
                const endTime = safeValue('training-end-time');

                const normalizedStart = normalizeDateString(startDate);
                const normalizedEnd = normalizeDateString(endDateInput) || normalizedStart;
                if (normalizedStart && normalizedEnd && (new Date(normalizedEnd) < new Date(normalizedStart))) {
                    alert('วันที่สิ้นสุดต้องไม่มาก่อนวันที่เริ่ม');
                    return;
                }

                const latRaw = parseFloat(safeValue('training-location-lat'));
                const lngRaw = parseFloat(safeValue('training-location-lng'));
                const locationLat = Number.isFinite(latRaw) ? latRaw : null;
                const locationLng = Number.isFinite(lngRaw) ? lngRaw : null;

                const data = {
                    trainingName: safeValue('training-name'),
                    details: safeValue('training-details'),
                    startDate: normalizedStart || '',
                    endDate: normalizedEnd || '',
                    date: normalizedStart || '',
                    startTime,
                    endTime,
                    time: `${startTime}-${endTime}`,
                    location: safeValue('training-location'),
                    locationLat,
                    locationLng,
                    requiredQuota: parseInt(safeValue('training-quota')) || 0
                };

                if (currentTrainingId) {
                    const tr = trainings.find(t => t.trainingId === currentTrainingId);
                    Object.assign(tr, data);
                    addActivityLog(
                        'training-manual-edit',
                        `แก้ไขข้อมูลอบรม "${data.trainingName}"`,
                        `วันที่: ${formatDateRangeThai(data.startDate, data.endDate)} | เวลา: ${data.time} | สถานที่: ${data.location} | โควตาครู: ${data.requiredQuota} คน`
                    );
                } else {
                    const newTraining = {
                        trainingId: Math.max(...trainings.map(t => t.trainingId), 0) + 1,
                        ...data,
                        assignedTeachers: [],
                        assignmentSlots: [],
                        status: 'pending'
                    };
                    trainings.push(newTraining);
                    addActivityLog(
                        'training-manual-edit',
                        `เพิ่มอบรมใหม่ "${data.trainingName}"`,
                        `วันที่: ${formatDateRangeThai(data.startDate, data.endDate)} | เวลา: ${data.time} | สถานที่: ${data.location} | โควตาครู: ${data.requiredQuota} คน`
                    );
                }

                saveData();
                closeTrainingModal();
                showView('trainings');
            } catch (err) {
                console.error('Training form submit failed:', err);
                alert('บันทึกข้อมูลอบรมไม่สำเร็จ: ' + (err?.message || err));
            }
        });

        document.getElementById('teacher-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.currentTarget;
            try {
                if (!form.reportValidity()) return;

                const teacherData = {
                    name: safeValue('teacher-name'),
                    position: safeValue('teacher-position'),
                    dutyQueueScore: parseInt(safeValue('teacher-duty-queue-score')) || 0,
                    trainingQueueScore: parseInt(safeValue('teacher-training-queue-score')) || 0
                };
                teacherData.queueScore = teacherData.dutyQueueScore;

                if (currentTeacherId) {
                    const teacher = getTeacherById(currentTeacherId);
                    Object.assign(teacher, teacherData);
                    teacher.initialDutyQueueScore = teacherData.dutyQueueScore;
                    teacher.initialTrainingQueueScore = teacherData.trainingQueueScore;
                    ensureTeacherStats(teacher);

                    addActivityLog(
                        'manual-edit',
                        `แก้ไขข้อมูลครู "${teacherData.name}"`,
                        `ตำแหน่ง: ${teacherData.position} | คะแนนออกงาน: ${teacherData.dutyQueueScore} | คะแนนอบรม: ${teacherData.trainingQueueScore}`
                    );
                } else {
                    const newTeacher = {
                        teacherId: Math.max(...teachers.map(t => t.teacherId), 0) + 1,
                        ...teacherData,
                        queueScore: teacherData.dutyQueueScore,
                        totalDuties: 0,
                        swapCount: 0,
                        dutyDuties: 0,
                        trainingDuties: 0,
                        dutySwapCount: 0,
                        trainingSwapCount: 0,
                        lastDutyDate: null,
                        lastTrainingDate: null,
                        initialDutyQueueScore: teacherData.dutyQueueScore,
                        initialTrainingQueueScore: teacherData.trainingQueueScore
                    };
                    ensureTeacherStats(newTeacher);
                    teachers.push(newTeacher);

                    addActivityLog(
                        'manual-edit',
                        `เพิ่มครูใหม่ "${teacherData.name}"`,
                        `ตำแหน่ง: ${teacherData.position} | คะแนนออกงานเริ่มต้น: ${teacherData.dutyQueueScore} | คะแนนอบรมเริ่มต้น: ${teacherData.trainingQueueScore}`
                    );
                }

                saveData();
                closeTeacherModal();
                showView('teachers');
            } catch (err) {
                console.error('Teacher form submit failed:', err);
                alert('บันทึกข้อมูลครูไม่สำเร็จ: ' + (err?.message || err));
            }
        });

        document.getElementById('substitution-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const originalTeacherId = parseInt(document.getElementById('original-teacher').value);
            const substituteTeacherId = parseInt(document.getElementById('substitute-teacher').value);
            const reason = document.getElementById('substitution-reason').value;
            const substitutionType = (document.querySelector('input[name="substitution-type"]:checked') || {}).value || SUBSTITUTION_TYPES.REPLACEMENT;
            const isSwap = substitutionType === SUBSTITUTION_TYPES.SWAP;

            if (!originalTeacherId || !substituteTeacherId || !reason.trim()) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            const event = getEventById(currentEventId, currentEventQueueType);
            const slots = getEventAssignmentSlots(event);
            const slot = slots.find(s => s.currentTeacherId === originalTeacherId) ||
                slots.find(s => s.originalTeacherId === originalTeacherId);

            const originalQueueTeacherId = slot && slot.originalTeacherId ? slot.originalTeacherId : originalTeacherId;
            const queueTeacher = getTeacherById(originalQueueTeacherId);
            const currentAssignedTeacher = getTeacherById(originalTeacherId);
            const substituteTeacher = getTeacherById(substituteTeacherId);

            // Update event assignment
            const index = event.assignedTeachers.indexOf(originalTeacherId);
            if (index !== -1) {
                event.assignedTeachers[index] = substituteTeacherId;
            }

            if (slot) {
                const slotIndex = slots.indexOf(slot);
                if (slotIndex !== -1 && slotIndex !== index) {
                    event.assignedTeachers[slotIndex] = substituteTeacherId;
                }
                if (!slot.originalTeacherId) {
                    slot.originalTeacherId = originalTeacherId;
                }
                slot.currentTeacherId = substituteTeacherId;
                slot.substituteTeacherId = substituteTeacherId;
                slot.substitutionType = isSwap ? SUBSTITUTION_TYPES.SWAP : SUBSTITUTION_TYPES.REPLACEMENT;
            }

            ensureEventAssignments(event);

            // Update teacher stats - ระบบใหม่: เพิ่มคะแนนเมื่อมีการแทน
            ensureTeacherStats(substituteTeacher);
            if (currentEventQueueType === QUEUE_TYPES.TRAINING) {
                substituteTeacher.trainingDuties = (substituteTeacher.trainingDuties || 0) + 1;
                substituteTeacher.trainingSwapCount = (substituteTeacher.trainingSwapCount || 0) + 1;
                substituteTeacher.lastTrainingDate = normalizeDateString(event.endDate || event.startDate || event.date);
            } else {
                substituteTeacher.dutyDuties = (substituteTeacher.dutyDuties || 0) + 1;
                substituteTeacher.dutySwapCount = (substituteTeacher.dutySwapCount || 0) + 1;
                substituteTeacher.lastDutyDate = normalizeDateString(event.date);
            }
            substituteTeacher.totalDuties = (substituteTeacher.dutyDuties || 0) + (substituteTeacher.trainingDuties || 0);
            substituteTeacher.swapCount = (substituteTeacher.dutySwapCount || 0) + (substituteTeacher.trainingSwapCount || 0);
            if (isSwap) {
                adjustTeacherQueueScore(substituteTeacher, currentEventQueueType, 25);
            }
            substituteTeacher.lastEventDate = latestDateString(substituteTeacher.lastDutyDate, substituteTeacher.lastTrainingDate);

            const logType = currentEventQueueType === QUEUE_TYPES.TRAINING ? 'training-substitution' : 'substitution';
            const substitutionLabel = isSwap ? 'แลกสลับ' : 'แทน';
            addActivityLog(
                logType,
                `${substitutionLabel}บุคลากรใน${getQueueDisplayName(currentEventQueueType)} "${getQueueItemName(event, currentEventQueueType)}"`,
                `รูปแบบ: ${substitutionLabel} | คิวเดิม: ${queueTeacher ? queueTeacher.name : 'ไม่ระบุ'} | ผู้มอบหมายล่าสุด: ${currentAssignedTeacher ? currentAssignedTeacher.name : 'ไม่พบข้อมูล'} | ผู้ปฏิบัติจริง: ${substituteTeacher ? substituteTeacher.name : 'ไม่พบข้อมูล'} | เหตุผล: ${reason}`
            );

            saveData();
            closeSubstitutionModal();
            showView(getQueueView(currentEventQueueType));
        });

        // Navigation event listeners
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                const viewName = this.getAttribute('data-view');
                showView(viewName);
            });
        });

        // Element SDK implementation
        const elementSdk = {
            init: async function(element) {
                this.element = element;
                this.config = { ...systemConfig };

                await element.onConfigChange(this.config);

                return { isOk: true };
            },

            setConfig: async function(newConfig) {
                this.config = { ...this.config, ...newConfig };
                await this.element.onConfigChange(this.config);
            }
        };

        // Make elementSdk available globally
        window.elementSdk = elementSdk;

        // Initialize Element SDK
        async function initializeElementSdk() {
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig: defaultConfig,
                    onConfigChange: async function(config) {
                        systemConfig = { ...defaultConfig, ...config };
                        updateSystemLabels();
                        if (dataInitialized) {
                            saveData();
                        }
                    },
                    mapToCapabilities: function() {
                        return {
                            recolorables: [],
                            borderables: [],
                            fontEditable: undefined,
                            fontSizeable: undefined
                        };
                    },
                    mapToEditPanelValues: function(config) {
                        const mergedConfig = { ...defaultConfig, ...config };
                        return new Map([
                            ["system_title", mergedConfig.system_title],
                            ["school_name", mergedConfig.school_name]
                        ]);
                    }
                });
            }
        }

        window.initMap = function() {
            mapsApiReady = true;
            initializeLocationMap();

            if (pendingLocationEvent) {
                prepareLocationPicker(pendingLocationEvent);
                pendingLocationEvent = null;
            }
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeElementSdk();
            await loadInitialData();
        });
    </script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script>
   (function () {
    try {
     if (window.firebase && firebase.auth) {
      firebase.auth().onAuthStateChanged(function (u) {
       console.log('[Auth]', u ? 'SIGNED-IN' : 'SIGNED-OUT', u || null);
      });
      firebase.auth().signInAnonymously()
       .then(() => console.log('[Auth] Anonymous signed in'))
       .catch((err) => console.error('[Auth] anonymous failed', err));
     }
    } catch (e) {
     console.error('Auth bootstrap failed:', e);
    }
   })();
  </script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    updateDoc,
    collection,
    getDocs,
    query,
    orderBy,
    writeBatch
  } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const fallbackConfig = {
    apiKey: 'AIzaSyDv--hw2BWKE-NTFrCMpTNz9LEzGK8l5PE',
    authDomain: 'thaigogo-e9112.firebaseapp.com',
    projectId: 'thaigogo-e9112',
    storageBucket: 'thaigogo-e9112.firebasestorage.app',
    messagingSenderId: '820257616141',
    appId: '1:820257616141:web:c92cf50ae5e05491fb4044',
    measurementId: 'G-4FX435MNDC'
  };

  const providedConfig = window.firebaseAppConfig || {};
  const firebaseConfig = Object.assign({}, fallbackConfig, providedConfig);

  try {
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authReady = new Promise((resolve, reject) => {
      onAuthStateChanged(
        auth,
        (user) => {
          if (user) {
            resolve(user);
          } else {
            signInAnonymously(auth).catch((authError) => {
              console.error('Anonymous sign-in failed:', authError);
              reject(authError);
            });
          }
        },
        (error) => {
          console.error('Auth observer error:', error);
          reject(error);
        }
      );
    });

    const helpers = {
      async get(path = "") {
        await authReady;
        const seg = path.split("/").filter(Boolean);

        if (seg.length === 1) {
          const key = seg[0];
          if (key === "config") {
            const snap = await getDoc(doc(db, "config", "app"));
            return snap.exists() ? snap.data() : null;
          }
          if (key === "teachers") {
            const snap = await getDocs(query(collection(db, "teachers"), orderBy("teacherId", "asc")));
            return snap.docs.map((d) => d.data());
          }
          if (key === "events") {
            const snap = await getDocs(query(collection(db, "events"), orderBy("eventId", "asc")));
            return snap.docs.map((d) => d.data());
          }
          if (key === "trainings") {
            const snap = await getDocs(query(collection(db, "trainings"), orderBy("trainingId", "asc")));
            return snap.docs.map((d) => d.data());
          }
          if (key === "activityLog") {
            const snap = await getDocs(query(collection(db, "activityLog"), orderBy("timestamp", "desc")));
            return snap.docs.map((d) => d.data());
          }
        }

        if (seg.length === 2) {
          const [col, id] = seg;
          const snap = await getDoc(doc(db, col, String(id)));
          return snap.exists() ? snap.data() : null;
        }

        throw new Error(`Unsupported GET path: ${path}`);
      },

      async put(path = "", value) {
        await authReady;
        const seg = path.split("/").filter(Boolean);

        if (seg.length === 1 && seg[0] === "config") {
          await setDoc(doc(db, "config", "app"), value ?? {}, { merge: false });
          return value;
        }

        if (seg.length === 1 && ["teachers", "events", "trainings", "activityLog"].includes(seg[0])) {
          const col = seg[0];
          const batch = writeBatch(db);

          const existing = await getDocs(collection(db, col));
          existing.forEach((docSnap) => batch.delete(docSnap.ref));

          const arr = Array.isArray(value) ? value : [];
          for (const row of arr) {
            const id =
              col === "teachers" ? String(row.teacherId) :
              col === "events" ? String(row.eventId) :
              col === "trainings" ? String(row.trainingId) :
              String(row.id ?? Date.now());
            batch.set(doc(db, col, id), row ?? {}, { merge: false });
          }

          await batch.commit();
          return value;
        }

        if (seg.length === 2) {
          const [col, id] = seg;
          await setDoc(doc(db, col, String(id)), value ?? {}, { merge: false });
          return value;
        }

        throw new Error(`Unsupported PUT path: ${path}`);
      },

      async patch(path = "", value) {
        await authReady;
        const seg = path.split("/").filter(Boolean);

        if (seg.length === 2) {
          const [col, id] = seg;
          await updateDoc(doc(db, col, String(id)), value ?? {});
          return value;
        }

        if (seg.length === 1 && ["teachers", "events", "trainings", "activityLog"].includes(seg[0])) {
          const col = seg[0];
          const arr = Array.isArray(value) ? value : [];
          const batch = writeBatch(db);
          for (const row of arr) {
            const id =
              col === "teachers" ? String(row.teacherId) :
              col === "events" ? String(row.eventId) :
              col === "trainings" ? String(row.trainingId) :
              String(row.id ?? Date.now());
            batch.set(doc(db, col, id), row ?? {}, { merge: true });
          }
          await batch.commit();
          return value;
        }

        throw new Error("PATCH requires collection/id or mergeable array");
      }
    };

    window.firebaseApp = app;
    window.firebaseDatabase = null;
    window.firebaseDbApi = helpers;

    if (typeof window.notifyFirebaseReady === "function") {
      window.notifyFirebaseReady(app, null, helpers);
    }
  } catch (error) {
    if (typeof window.notifyFirebaseInitError === "function") {
      window.notifyFirebaseInitError(error);
    } else {
      console.error("Firebase initialization error:", error);
    }
  }
  </script>
 </body>
</html>
